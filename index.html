<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One & Done Golf | PGA Tour Fantasy</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --green-deep: #0a3622;
            --green-fairway: #1a5c3a;
            --green-light: #2d8a5e;
            --gold: #c4a747;
            --gold-light: #e8d78a;
            --cream: #f5f2e8;
            --white: #ffffff;
            --dark: #1a1a1a;
            --gray: #6b7280;
            --red: #dc2626;
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--cream);
            color: var(--dark);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--white);
            letter-spacing: 1px;
        }

        .logo span {
            color: var(--gold);
        }

        nav {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            padding: 0.6rem 1.25rem;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            font-family: 'Oswald', sans-serif;
            font-size: 0.95rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .nav-btn:hover {
            background: var(--gold);
            color: var(--green-deep);
        }

        .nav-btn.primary {
            background: var(--gold);
            color: var(--green-deep);
        }

        .nav-btn.primary:hover {
            background: var(--gold-light);
        }

        .nav-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            margin-right: 1rem;
        }

        .nav-profile img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--gold);
            background: var(--gold);
            padding: 2px;
            transition: transform 0.2s, border-color 0.2s;
        }

        .nav-profile:hover img {
            transform: scale(1.05);
            border-color: var(--gold-light);
        }

        .nav-profile-edit {
            font-size: 0.7rem;
            color: var(--gold);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content Areas */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Screen visibility */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Landing Page */
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(180deg, rgba(10,54,34,0.05) 0%, transparent 100%);
        }

        .hero h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--green-deep);
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--gray);
            max-width: 600px;
            margin: 0 auto 2rem;
            line-height: 1.6;
        }

        .hero-cta {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 1rem 2rem;
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--green-deep);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--green-fairway);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--green-deep);
            border: 2px solid var(--green-deep);
        }

        .btn-secondary:hover {
            background: var(--green-deep);
            color: var(--white);
        }

        .btn-danger-outline {
            background: var(--white);
            color: var(--red);
            border: 2px solid var(--red);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-danger-outline:hover {
            background: var(--red);
            color: var(--white);
        }

        /* Features Grid */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            background: var(--white);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-top: 4px solid var(--gold);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            color: var(--green-deep);
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            color: var(--gray);
            line-height: 1.5;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 450px;
            margin: 3rem auto;
            background: var(--white);
            padding: 2.5rem;
            box-shadow: var(--shadow);
        }

        .auth-container h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--green-deep);
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--green-fairway);
        }

        .form-btn {
            width: 100%;
            padding: 1rem;
            background: var(--green-deep);
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .form-btn:hover {
            background: var(--green-fairway);
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--gray);
        }

        .auth-switch a {
            color: var(--green-fairway);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--green-deep);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--gray);
        }

        .user-info strong {
            color: var(--dark);
        }

        /* Tournament Cards */
        .tournaments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .tournament-card {
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            max-width: 380px;
        }

        .tournament-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .tournament-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1rem;
            color: var(--white);
        }

        .tournament-header h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.15rem;
            margin-bottom: 0.2rem;
        }

        .tournament-header p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .tournament-body {
            padding: 0.9rem;
        }

        .tournament-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .tournament-stat:last-child {
            border-bottom: none;
        }

        .tournament-stat span:first-child {
            color: var(--gray);
        }

        .tournament-stat span:last-child {
            font-weight: 600;
        }

        .tournament-actions {
            padding: 0.9rem;
            padding-top: 0;
            display: flex;
            gap: 0.5rem;
        }

        .tournament-actions .btn {
            flex: 1;
            padding: 0.6rem;
            font-size: 0.85rem;
        }

        /* Create Tournament Form */
        .create-tournament {
            background: var(--white);
            padding: 2rem;
            box-shadow: var(--shadow);
            max-width: 600px;
            margin: 0 auto;
        }

        .create-tournament h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
            color: var(--green-deep);
            margin-bottom: 1.5rem;
        }

        .invite-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .invite-section h3 {
            font-family: 'Oswald', sans-serif;
            color: var(--green-deep);
            margin-bottom: 1rem;
        }

        .invite-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .invite-tag {
            background: var(--green-deep);
            color: var(--white);
            padding: 0.35rem 0.75rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .invite-tag button {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }

        /* Player Selection */
        .player-selection {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .selection-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1.25rem 2rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-header .tournament-title {
            flex: 1;
        }

        .selection-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .selection-header p {
            opacity: 0.9;
        }

        .current-pick {
            background: var(--gold);
            color: var(--green-deep);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .current-pick strong {
            font-family: 'Oswald', sans-serif;
        }

        .search-filter {
            padding: 1.5rem 2rem;
            background: #f9fafb;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-filter input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            font-family: inherit;
        }

        .search-filter input:focus {
            outline: none;
            border-color: var(--green-fairway);
        }

        .players-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .player-item:hover:not(.disabled) {
            background: rgba(26, 92, 58, 0.05);
        }

        .player-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }

        .player-item.selected {
            background: rgba(196, 167, 71, 0.15);
            border-left: 4px solid var(--gold);
        }

        .player-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
            background: #e5e7eb;
        }

        .player-info {
            flex: 1;
        }

        .player-info h4 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .player-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .player-rank {
            text-align: right;
        }

        .player-rank strong {
            display: block;
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            color: var(--green-deep);
        }

        .player-rank span {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .used-badge {
            background: var(--red);
            color: var(--white);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .current-badge {
            background: var(--gold);
            color: var(--green-deep);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .player-item.current-pick {
            border: 2px solid var(--gold);
            background: rgba(196, 167, 71, 0.1);
        }

        .confirm-selection {
            padding: 1.5rem 2rem;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Leaderboard */
        .leaderboard {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .leaderboard-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1.25rem 2rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-header .tournament-title {
            flex: 1;
        }

        .tournament-logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
            background: var(--white);
            border-radius: 8px;
            padding: 6px;
        }

        .tournament-logo-small {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 4px;
        }

        .leaderboard-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
        }

        .leaderboard-meta {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .my-pick-highlight {
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .my-pick-highlight img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--white);
        }

        .my-pick-info {
            flex: 1;
        }

        .my-pick-info h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            color: var(--green-deep);
        }

        .my-pick-info p {
            color: var(--green-deep);
            opacity: 0.8;
        }

        .my-pick-stats {
            text-align: right;
        }

        .my-pick-stats .position {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--green-deep);
        }

        .my-pick-stats .earnings {
            color: var(--green-deep);
            font-weight: 600;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: #f9fafb;
            padding: 0.5rem 1rem;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            color: var(--gray);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .leaderboard-table td {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .leaderboard-table tr:hover {
            background: rgba(26, 92, 58, 0.03);
        }

        .leaderboard-table tr.my-pick {
            background: rgba(196, 167, 71, 0.15);
        }

        .leaderboard-table tr.my-pick td {
            font-weight: 600;
        }

        .pos-cell {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: var(--green-deep);
        }

        .player-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .player-cell img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .pick-tag {
            margin-left: 0.5rem;
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pick-tag.your-pick {
            background: var(--gold);
            color: var(--green-deep);
        }

        .pick-tag.friend-pick-0 {
            background: #3b82f6;
            color: var(--white);
        }

        .pick-tag.friend-pick-1 {
            background: #8b5cf6;
            color: var(--white);
        }

        .pick-tag.friend-pick-2 {
            background: #ec4899;
            color: var(--white);
        }

        .pick-tag.friend-pick-3 {
            background: #f97316;
            color: var(--white);
        }

        .pick-tag.friend-pick-4 {
            background: #14b8a6;
            color: var(--white);
        }

        .score-cell {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
        }

        .score-cell.under {
            color: var(--red);
        }

        .score-cell.over {
            color: var(--green-deep);
        }

        .thru-cell {
            color: var(--gray);
        }

        .earnings-cell {
            font-weight: 600;
            color: var(--green-fairway);
        }

        /* Pool Standings */
        .standings-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1.5rem 2rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .standings-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
        }

        .pool-total {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
        }

        .pool-total span {
            color: var(--gold);
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            color: var(--gray);
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .standings-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .standings-table tr.current-user {
            background: rgba(196, 167, 71, 0.15);
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
        }

        .rank-badge.gold {
            background: var(--gold);
            color: var(--green-deep);
        }

        .rank-badge.silver {
            background: #c0c0c0;
            color: var(--dark);
        }

        .rank-badge.bronze {
            background: #cd7f32;
            color: var(--white);
        }

        .weekly-pick {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weekly-pick img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            background: var(--green-deep);
            color: var(--white);
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.35rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--green-deep);
            color: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            transform: translateX(calc(100% + 2rem));
            transition: transform 0.3s;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--red);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: row;
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }

            .logo-icon {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }

            .logo h1 {
                font-size: 1.25rem;
            }

            .nav-buttons {
                gap: 0.5rem;
            }

            .nav-buttons .btn {
                padding: 0.4rem 0.75rem;
                font-size: 0.75rem;
            }

            .hero h2 {
                font-size: 1.75rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .hero-cta {
                flex-direction: column;
            }

            .dashboard-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .tournaments-grid {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            .card {
                padding: 1rem;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 1rem 1rem;
                font-size: 0.85rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* Smaller pool cards on mobile */
            .tournament-card {
                font-size: 0.85rem;
            }

            .tournament-header {
                padding: 1rem;
            }

            .tournament-header h3 {
                font-size: 1.1rem;
            }

            .tournament-body {
                padding: 0.75rem;
            }

            .tournament-stat {
                padding: 0.5rem 0;
            }

            .tournament-actions {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .tournament-actions .btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .leaderboard {
                padding: 1rem;
                margin: 0.5rem;
            }

            .leaderboard-header {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .leaderboard-header h2 {
                font-size: 1.1rem;
            }

            /* Make tables scrollable on mobile */
            .leaderboard-table,
            .standings-table {
                font-size: 0.8rem;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            .leaderboard-table th,
            .leaderboard-table td,
            .standings-table th,
            .standings-table td {
                padding: 0.5rem 0.4rem;
            }

            .my-pick-highlight {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .my-pick-photo {
                width: 60px;
                height: 60px;
            }

            .my-pick-stats {
                text-align: center;
            }

            .my-pick-position {
                font-size: 2rem;
            }

            .pool-header {
                padding: 1rem;
            }

            .pool-header h1 {
                font-size: 1.5rem;
            }

            .player-item {
                padding: 0.75rem;
            }

            .player-photo {
                width: 40px;
                height: 40px;
            }

            .player-info h4 {
                font-size: 0.9rem;
            }

            .player-info p {
                font-size: 0.75rem;
            }

            .screen {
                padding: 0.5rem;
            }

            .container {
                padding: 0 0.5rem;
            }

            /* Fix upcoming tournaments table */
            .upcoming-table {
                font-size: 0.75rem;
            }

            .upcoming-table th,
            .upcoming-table td {
                padding: 0.5rem 0.25rem;
            }

            /* Weekly pick display */
            .weekly-pick {
                flex-direction: column;
                gap: 0.25rem;
            }

            .weekly-pick img {
                width: 24px;
                height: 24px;
            }

            /* Profile pictures in standings */
            .standings-table img {
                width: 24px;
                height: 24px;
            }

            /* Nav profile on mobile */
            .nav-profile {
                margin-right: 0.5rem;
            }

            .nav-profile img {
                width: 32px;
                height: 32px;
            }

            .nav-profile-edit {
                font-size: 0.6rem;
            }

            /* Friend tags on leaderboard */
            .friend-tags {
                flex-wrap: wrap;
            }

            .friend-tag {
                font-size: 0.65rem;
                padding: 0.15rem 0.3rem;
            }
        }

        /* Extra small screens */
        @media (max-width: 400px) {
            .header-content {
                padding: 0.5rem;
            }

            .logo h1 {
                font-size: 1rem;
            }

            .nav-buttons .btn {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }

            .tab {
                font-size: 0.7rem;
                padding: 0.5rem 0.25rem;
            }

            .leaderboard-table,
            .standings-table {
                font-size: 0.7rem;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: var(--green-fairway);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }

        .empty-state h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .empty-state .btn {
            margin-top: 1.5rem;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: var(--white);
            position: relative;
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tabs-container {
            position: relative;
            width: 100%;
            background: var(--white);
            border-bottom: 2px solid #e5e7eb;
            overflow: visible;
        }

        .pool-options-menu {
            position: relative;
            display: flex;
            align-items: center;
            margin-left: auto;
            padding: 0 0.5rem;
            flex-shrink: 0;
        }

        .pool-options-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            font-size: 1.5rem;
            color: var(--gray);
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
            line-height: 1;
        }

        .pool-options-btn:hover {
            background: #f3f4f6;
            color: var(--green-deep);
        }

        .pool-options-dropdown {
            display: none;
            position: fixed;
            background: var(--white);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 150px;
            z-index: 1000;
            overflow: hidden;
        }

        .pool-options-dropdown.active {
            display: block;
        }

        .pool-options-dropdown button {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .pool-options-dropdown button:hover {
            background: #f9fafb;
        }

        .tab {
            padding: 1rem 2rem;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            color: var(--gray);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--green-fairway);
        }

        .tab.active {
            color: var(--green-deep);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--green-deep);
        }

        /* Profile Picture Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .profile-modal.active {
            display: flex;
        }
        .profile-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .profile-modal-name {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
        }
        .clickable-profile {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .clickable-profile:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">‚õ≥</div>
                <h1>ONE <span>&</span> DONE</h1>
            </div>
            <nav id="nav-guest">
                <button class="nav-btn" onclick="showScreen('login')">Log In</button>
                <button class="nav-btn primary" onclick="showScreen('signup')">Sign Up</button>
            </nav>
            <nav id="nav-user" style="display: none;">
                <div class="nav-profile" onclick="openProfileEditor()">
                    <img id="nav-profile-pic" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='24'>üë§</text></svg>" alt="Profile">
                    <span class="nav-profile-edit">Edit</span>
                </div>
                <button class="nav-btn" onclick="showScreen('dashboard')">My Pools</button>
                <button class="nav-btn" onclick="logout()">Log Out</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Landing Page -->
        <section id="landing" class="screen active">
            <div class="hero">
                <h2>One Pick Per Week.<br>One Season.<br>Unlimited Glory.</h2>
                <p>The ultimate PGA Tour fantasy pool. Select one player per tournament‚Äîuse each golfer only once all season. Accumulate earnings and dominate your friends.</p>
                <div class="hero-cta">
                    <button class="btn btn-primary" onclick="showScreen('signup')">Start a Pool</button>
                    <button class="btn btn-secondary" onclick="showScreen('login')">Join a Pool</button>
                </div>
            </div>

            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon">üèÜ</div>
                    <h3>Simple Rules</h3>
                    <p>Pick one PGA Tour player each week. Their tournament earnings become your score. Use each player only once per season.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìä</div>
                    <h3>Live Tracking</h3>
                    <p>Watch your player climb the leaderboard in real-time. See projected earnings update as the tournament unfolds.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üë•</div>
                    <h3>Challenge Friends</h3>
                    <p>Create private pools, invite friends, and compete head-to-head throughout the entire PGA Tour season.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üí∞</div>
                    <h3>Accumulate Earnings</h3>
                    <p>Your total earnings accumulate week after week. The highest total at season's end wins the pool.</p>
                </div>
            </div>
        </section>

        <!-- Login -->
        <section id="login" class="screen">
            <div class="auth-container">
                <h2>Welcome Back</h2>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="form-btn">Log In</button>
                </form>
                <p class="auth-switch">
                    Don't have an account? <a onclick="showScreen('signup')">Sign up</a>
                </p>
            </div>
        </section>

        <!-- Signup -->
        <section id="signup" class="screen">
            <div class="auth-container">
                <h2>Create Account</h2>
                <form id="signup-form" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="signup-name" required placeholder="How friends will see you">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signup-email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signup-password" required placeholder="At least 8 characters" minlength="8">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signup-confirm" required placeholder="Confirm your password">
                    </div>
                    <button type="submit" class="form-btn">Create Account</button>
                </form>
                <p class="auth-switch">
                    Already have an account? <a onclick="showScreen('login')">Log in</a>
                </p>
            </div>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="screen">
            <div class="dashboard-header">
                <h2>My Pools</h2>
                <div class="user-info">
                    <span>Logged in as <strong id="user-display-name">User</strong></span>
                </div>
            </div>

            <button class="btn btn-primary" onclick="showScreen('create-tournament')" style="margin-bottom: 2rem;">
                + Create New Pool
            </button>

            <div id="tournaments-container" class="tournaments-grid">
                <!-- Tournaments will be rendered here -->
            </div>
        </section>

        <!-- Create Tournament -->
        <section id="create-tournament" class="screen">
            <div class="create-tournament">
                <h2>Create a New Pool</h2>
                <form id="create-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Pool Name</label>
                        <input type="text" id="pool-name" required placeholder="e.g., Office Golf League 2026">
                    </div>
                    <div class="form-group">
                        <label>Season</label>
                        <select id="pool-season" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; font-size: 1rem;">
                            <option value="2025-2026">2025-2026 PGA Tour Season</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Your Profile Picture (optional)</label>
                        <p style="color: var(--gray); font-size: 0.85rem; margin-bottom: 0.5rem;">This will be shown in pool standings</p>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img id="profile-preview" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='12'>No Photo</text></svg>" 
                                 style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid #e5e7eb;">
                            <div style="flex: 1;">
                                <input type="file" id="profile-picture-input" accept="image/*" onchange="previewProfilePicture(event)" style="display: none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('profile-picture-input').click()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    Upload Photo
                                </button>
                                <button type="button" id="remove-photo-btn" class="btn" onclick="removeProfilePicture()" style="padding: 0.5rem 1rem; font-size: 0.9rem; display: none; margin-left: 0.5rem; color: var(--gray);">
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="invite-section">
                        <h3>Invite Friends</h3>
                        <p style="color: var(--gray); font-size: 0.95rem; margin-bottom: 1rem;">Enter email addresses to send invitations</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="email" id="invite-email" placeholder="friend@email.com" style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb;">
                            <button type="button" class="btn btn-secondary" onclick="addInvite()" style="padding: 0.75rem 1.5rem;">Add</button>
                        </div>
                        <div id="invite-list" class="invite-list"></div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="showScreen('dashboard')" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Create Pool</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Pool View -->
        <section id="pool-view" class="screen">
            <div style="margin-bottom: 1rem;">
                <button class="btn btn-secondary" onclick="localStorage.removeItem('currentPoolId'); showScreen('dashboard')" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                    ‚Üê Back to My Pools
                </button>
            </div>

            <div class="tabs-container" id="tabs-container">
                <div class="tabs" id="pool-tabs">
                    <button class="tab active" onclick="switchPoolTab('standings')">Pool Standings</button>
                    <button class="tab" onclick="switchPoolTab('leaderboard')">Live Leaderboard</button>
                    <button class="tab" onclick="switchPoolTab('pick')">Make Pick</button>
                    <button class="tab" onclick="switchPoolTab('history')">Pick History</button>
                    <div class="pool-options-menu">
                        <button class="pool-options-btn" onclick="togglePoolOptions(event)">
                            <span>‚ãÆ</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pool Options Dropdown (outside tabs for proper z-index) -->
            <div class="pool-options-dropdown" id="pool-options-dropdown">
                <button onclick="confirmLeaveCurrentPool()">
                    <span style="color: var(--red);">üö™ Leave Pool</span>
                </button>
            </div>

            <!-- Standings Tab -->
            <div id="tab-standings" class="pool-tab">
                <div class="leaderboard">
                    <div class="standings-header">
                        <div>
                            <h2 id="pool-title">Pool Name</h2>
                            <p id="pool-season-display">2025-2026 Season</p>
                        </div>
                    </div>

                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>This Week</th>
                                <th>Total Earnings</th>
                                <th>Picks Used</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body">
                            <!-- Standings will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Leaderboard Tab -->
            <div id="tab-leaderboard" class="pool-tab" style="display: none;">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <div class="tournament-title">
                            <h2 id="current-tournament-name">The American Express</h2>
                            <div class="leaderboard-meta">
                                <span id="tournament-dates">Jan 22 - 25, 2026</span>
                                <span id="tournament-course">Pete Dye Stadium Course</span>
                                <span id="tournament-round">Round 1</span>
                            </div>
                        </div>
                        <img id="tournament-logo" class="tournament-logo" src="" alt="Tournament Logo">
                    </div>

                    <div id="my-pick-section" class="my-pick-highlight" style="display: none;">
                        <img id="my-pick-photo" src="" alt="">
                        <div class="my-pick-info">
                            <p>YOUR PICK</p>
                            <h3 id="my-pick-name">Player Name</h3>
                        </div>
                        <div class="my-pick-stats">
                            <div class="position" id="my-pick-position">T5</div>
                            <div class="earnings" id="my-pick-earnings">Projected: $450,000</div>
                        </div>
                    </div>

                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Today</th>
                                <th>Thru</th>
                                <th>Projected $</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- Leaderboard will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Make Pick Tab -->
            <div id="tab-pick" class="pool-tab" style="display: none;">
                <div class="player-selection">
                    <div class="selection-header">
                        <div class="tournament-title">
                            <h2>Select Your Golfer</h2>
                            <p id="pick-tournament-info">The American Express ‚Ä¢ Jan 22-25, 2026</p>
                        </div>
                        <img id="pick-tournament-logo" class="tournament-logo" src="" alt="Tournament Logo">
                    </div>

                    <div id="current-pick-display" class="current-pick" style="display: none;">
                        <strong>Current Selection:</strong>
                        <span id="selected-player-name">None</span>
                    </div>

                    <div class="search-filter">
                        <input type="text" id="player-search" placeholder="Search players..." oninput="filterPlayers()">
                    </div>

                    <div class="players-list" id="players-list">
                        <!-- Players will be rendered here -->
                    </div>

                    <div class="confirm-selection">
                        <div id="pick-warning" style="color: var(--gray);">
                            Select a player to lock in your pick for this week
                        </div>
                        <button id="confirm-pick-btn" class="btn btn-primary" disabled onclick="confirmPick()">
                            Confirm Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="pool-tab" style="display: none;">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <h2>Your Pick History</h2>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Tournament</th>
                                <th>Your Pick</th>
                                <th>Finish</th>
                                <th>Earnings</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <!-- History will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Upcoming Schedule -->
                <div class="leaderboard" style="margin-top: 1.5rem;">
                    <div class="leaderboard-header">
                        <h2>Upcoming Tournaments</h2>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Tournament</th>
                                <th>Dates</th>
                                <th>Course</th>
                                <th>Previous Winner</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body">
                            <!-- Schedule will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Friends Pick History -->
                <div class="leaderboard" style="margin-top: 1.5rem;">
                    <div class="leaderboard-header">
                        <h2>Pool Members' Pick History</h2>
                    </div>
                    <div id="friends-history">
                        <!-- Friends history will be rendered here -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Profile Picture Modal -->
    <div id="profile-modal" class="profile-modal" onclick="closeProfileModal()">
        <img id="profile-modal-image" class="profile-modal-content" src="" alt="Profile Picture">
        <div id="profile-modal-name" class="profile-modal-name"></div>
    </div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Invite Friends</h3>
                <button class="modal-close" onclick="closeModal('invite-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Email invite section -->
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 0.5rem; font-weight: 600;">Send Email Invite</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="email" id="modal-invite-email" placeholder="friend@email.com" style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <button class="btn btn-primary" onclick="sendEmailInvite()" style="padding: 0.75rem 1.5rem;">Send</button>
                    </div>
                    <p style="color: var(--gray); font-size: 0.85rem; margin-top: 0.5rem;">They'll receive an email with a link to join</p>
                    <div id="sent-invites-list"></div>
                </div>

                <!-- Invite link to share -->
                <div style="padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                    <p style="margin-bottom: 0.5rem; font-weight: 600;">Or share the invite link:</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="invite-link-input" readonly style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.85rem; background: #f9fafb;">
                        <button class="btn btn-secondary" onclick="copyInviteLink()" style="padding: 0.75rem 1.5rem;">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Editor Modal -->
    <div id="profile-editor-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Profile Picture</h3>
                <button class="modal-close" onclick="closeModal('profile-editor-modal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <img id="profile-editor-preview" src="" alt="Profile" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--gold); margin-bottom: 1rem;">
                
                <div style="margin-bottom: 1rem;">
                    <input type="file" id="profile-editor-input" accept="image/*" onchange="previewNewProfilePicture(event)" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('profile-editor-input').click()" style="margin-right: 0.5rem;">
                        üì∑ Choose Photo
                    </button>
                    <button class="btn btn-secondary" onclick="removeUserProfilePicture()" id="remove-profile-btn" style="display: none;">
                        Remove
                    </button>
                </div>
                
                <p id="profile-change-limit" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 1rem;"></p>
                
                <button class="btn btn-primary" onclick="saveNewProfilePicture()" id="save-profile-btn" style="width: 100%; display: none;">
                    Save Profile Picture
                </button>
            </div>
        </div>
    </div>

    <!-- Leave Pool Confirmation Modal -->
    <div id="leave-pool-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Leave Pool</h3>
                <button class="modal-close" onclick="closeModal('leave-pool-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Are you sure you want to leave</p>
                    <p style="font-size: 1.3rem; font-weight: bold; color: var(--green-deep);" id="leave-pool-name"></p>
                </div>
                
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: var(--red); font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è This action cannot be undone!</p>
                    <ul style="color: #7f1d1d; font-size: 0.9rem; margin-left: 1rem;">
                        <li>All your picks will be deleted</li>
                        <li>Your earnings history will be lost</li>
                        <li>You'll need a new invite to rejoin</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('leave-pool-modal')" style="flex: 1;">Cancel</button>
                    <button class="btn btn-danger-outline" onclick="leavePool()" style="flex: 1; background: var(--red); color: white; border-color: var(--red);">Leave Pool</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <script>
        // ==================== DATA STORE ====================
        // In production, this would be backed by a database
        const store = {
            currentUser: null,
            users: [],
            pools: [],
            picks: [],
            invites: []
        };

        // ==================== SUPABASE CONFIGURATION ====================
        const SUPABASE_URL = 'https://ttwtifdhlaijdswhehve.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0d3RpZmRobGFpamRzd2hlaHZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0OTc5MTYsImV4cCI6MjA4MzA3MzkxNn0.h4YVDwZ4_TLmbjHnFSbUKPUpqBsY2Lh4WQIqUwZ3faE';

        // Initialize Supabase client (will be null if Supabase SDK not loaded)
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: false,
                        storageKey: 'golf-pool-auth'
                    }
                });
                console.log('Supabase client initialized');
            }
        } catch (e) {
            console.log('Supabase not available, using local storage', e);
        }

        // Helper function to retry Supabase operations that fail with AbortError
        async function supabaseRetry(operation, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const result = await operation();
                    if (result.error) {
                        if (result.error.message?.includes('AbortError') && i < maxRetries - 1) {
                            console.log(`Retry ${i + 1}/${maxRetries} after AbortError...`);
                            await new Promise(r => setTimeout(r, 500));
                            continue;
                        }
                        return result; // Return the error result if not AbortError
                    }
                    return result;
                } catch (error) {
                    if (error.message?.includes('AbortError') && i < maxRetries - 1) {
                        console.log(`Retry ${i + 1}/${maxRetries} after AbortError...`);
                        await new Promise(r => setTimeout(r, 500));
                        continue;
                    }
                    throw error;
                }
            }
        }

        // ==================== SUPABASE AUTH FUNCTIONS ====================
        async function supabaseSignUp(email, password, name) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: { data: { name } }
            });
            if (error) throw error;
            return data;
        }

        async function supabaseSignIn(email, password) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            if (error) throw error;
            return data;
        }

        async function supabaseSignOut() {
            if (!supabaseClient) return;
            const { error } = await supabaseClient.auth.signOut();
            if (error) throw error;
        }

        async function supabaseGetCurrentUser() {
            if (!supabaseClient) return null;
            const { data: { user } } = await supabaseClient.auth.getUser();
            return user;
        }

        // ==================== SUPABASE POOL FUNCTIONS ====================
        async function supabaseCreatePool(name, season) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const user = await supabaseGetCurrentUser();
            const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { data: pool, error } = await supabaseClient
                .from('pools')
                .insert({
                    name,
                    season,
                    invite_code: inviteCode,
                    created_by: user.id
                })
                .select()
                .single();
            
            if (error) throw error;
            
            // Add creator as member
            await supabaseClient
                .from('pool_members')
                .insert({ pool_id: pool.id, user_id: user.id });
            
            return pool;
        }

        async function supabaseJoinPool(inviteCode) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const user = await supabaseGetCurrentUser();
            
            const { data: pool, error: poolError } = await supabaseClient
                .from('pools')
                .select('id')
                .eq('invite_code', inviteCode.toUpperCase())
                .single();
            
            if (poolError) throw new Error('Invalid invite code');
            
            const { error } = await supabaseClient
                .from('pool_members')
                .insert({ pool_id: pool.id, user_id: user.id });
            
            if (error) throw error;
            return pool;
        }

        async function supabaseGetUserPools() {
            if (!supabaseClient) return [];
            const user = await supabaseGetCurrentUser();
            if (!user) return [];
            
            const { data, error } = await supabaseClient
                .from('pool_members')
                .select('pool:pools(*)')
                .eq('user_id', user.id);
            
            if (error) throw error;
            return data.map(pm => pm.pool);
        }

        // ==================== SUPABASE PICK FUNCTIONS ====================
        async function supabaseMakePick(poolId, tournamentId, playerId, playerName) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const user = await supabaseGetCurrentUser();
            
            // Check if player already used this season
            const { data: usedCheck } = await supabaseClient
                .from('used_players')
                .select('id')
                .eq('pool_id', poolId)
                .eq('user_id', user.id)
                .eq('player_id', playerId)
                .eq('season', '2025-2026')
                .single();
            
            if (usedCheck) {
                throw new Error('You have already used this player this season');
            }
            
            const { data, error } = await supabaseClient
                .from('picks')
                .upsert({
                    pool_id: poolId,
                    user_id: user.id,
                    tournament_id: tournamentId,
                    player_id: playerId,
                    player_name: playerName
                }, {
                    onConflict: 'pool_id,user_id,tournament_id'
                })
                .select()
                .single();
            
            if (error) throw error;
            return data;
        }

        async function supabaseGetUserPicks(poolId) {
            if (!supabaseClient) return [];
            const user = await supabaseGetCurrentUser();
            if (!user) return [];
            
            const { data, error } = await supabaseClient
                .from('picks')
                .select('*')
                .eq('pool_id', poolId)
                .eq('user_id', user.id)
                .order('picked_at', { ascending: false });
            
            if (error) throw error;
            return data;
        }

        async function supabaseGetPoolStandings(poolId) {
            if (!supabaseClient) return [];
            const { data, error } = await supabaseClient
                .rpc('get_pool_standings', { p_pool_id: poolId });
            
            if (error) throw error;
            return data;
        }

        // ==================== MOCK DATA ====================
        // PGA Players with ESPN IDs (master list from pgatour.com/players for pre-tournament picks)
        const pgaPlayers = [
            { id: "9478", name: "Scottie Scheffler", country: "USA", rank: 1 },
            { id: "4686087", name: "Xander Schauffele", country: "USA", rank: 2 },
            { id: "401", name: "Rory McIlroy", country: "NIR", rank: 3 },
            { id: "9780", name: "Jon Rahm", country: "ESP", rank: 4 },
            { id: "10592", name: "Collin Morikawa", country: "USA", rank: 5 },
            { id: "10046", name: "Viktor Hovland", country: "NOR", rank: 6 },
            { id: "6007", name: "Patrick Cantlay", country: "USA", rank: 7 },
            { id: "11119", name: "Wyndham Clark", country: "USA", rank: 8 },
            { id: "4375972", name: "Ludvig √Öberg", country: "SWE", rank: 9 },
            { id: "4148", name: "Hideki Matsuyama", country: "JPN", rank: 10 },
            { id: "6798", name: "Tommy Fleetwood", country: "ENG", rank: 11 },
            { id: "8973", name: "Max Homa", country: "USA", rank: 12 },
            { id: "1225", name: "Brian Harman", country: "USA", rank: 13 },
            { id: "10980", name: "Sahith Theegala", country: "USA", rank: 14 },
            { id: "5409", name: "Russell Henley", country: "USA", rank: 15 },
            { id: "2230", name: "Tony Finau", country: "USA", rank: 16 },
            { id: "9037", name: "Matt Fitzpatrick", country: "ENG", rank: 17 },
            { id: "9427", name: "Sungjae Im", country: "KOR", rank: 18 },
            { id: "4612", name: "Keegan Bradley", country: "USA", rank: 19 },
            { id: "5321", name: "Justin Thomas", country: "USA", rank: 20 },
            { id: "5467", name: "Jordan Spieth", country: "USA", rank: 21 },
            { id: "6798", name: "Cameron Smith", country: "AUS", rank: 22 },
            { id: "5013", name: "Shane Lowry", country: "IRL", rank: 23 },
            { id: "10644", name: "Cameron Young", country: "USA", rank: 24 },
            { id: "9576", name: "Corey Conners", country: "CAN", rank: 25 },
            { id: "1680", name: "Jason Day", country: "AUS", rank: 26 },
            { id: "4419142", name: "Akshay Bhatia", country: "USA", rank: 27 },
            { id: "6993", name: "Tyrrell Hatton", country: "ENG", rank: 28 },
            { id: "7081", name: "Si Woo Kim", country: "KOR", rank: 29 },
            { id: "8961", name: "Sepp Straka", country: "AUT", rank: 30 },
            { id: "3702", name: "Rickie Fowler", country: "USA", rank: 31 },
            { id: "9877", name: "Will Zalatoris", country: "USA", rank: 32 },
            { id: "9938", name: "Sam Burns", country: "USA", rank: 33 },
            { id: "4602673", name: "Tom Kim", country: "KOR", rank: 34 },
            { id: "11378", name: "Robert MacIntyre", country: "SCO", rank: 35 },
            { id: "9025", name: "Daniel Berger", country: "USA", rank: 36 },
            { id: "388", name: "Adam Scott", country: "AUS", rank: 37 },
            { id: "569", name: "Justin Rose", country: "ENG", rank: 38 },
            { id: "1651", name: "Billy Horschel", country: "USA", rank: 39 },
            { id: "6086", name: "Tom Hoge", country: "USA", rank: 40 }
        ];

        // Current tournament (from live data)
        // COMPLETED: The American Express (Jan 22-26, 2026)
        // Winner: Scottie Scheffler
        const completedTournaments = [
            {
                id: "sony2026",
                name: "Sony Open in Hawaii",
                dates: "Jan 15 - 18, 2026",
                status: "Complete"
            },
            {
                id: "amex2026",
                name: "The American Express",
                dates: "Jan 22 - 26, 2026",
                status: "Complete"
            }
        ];

        // Tournament that just finished (show until Tuesday)
        const justFinishedTournament = {
            id: "amex2026",
            name: "The American Express",
            dates: "Jan 22 - 26, 2026",
            course: "Pete Dye Stadium Course, PGA West",
            location: "La Quinta, CA",
            purse: 9200000,
            round: 4,
            status: "Complete",
            logo: "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R002.png",
            endDate: new Date("2026-01-26T23:59:59-08:00"),
            showUntil: new Date("2026-01-27T07:00:00Z") // Show until Tuesday 7am UK
        };

        // Upcoming tournament (pick window opens Monday)
        const upcomingTournament = {
            id: "farmers-2026",
            name: "Farmers Insurance Open",
            dates: "Jan 29 - Feb 1, 2026",
            course: "Torrey Pines GC (South)",
            location: "San Diego, CA",
            purse: 9600000,
            round: 0,
            status: "Upcoming",
            logo: "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R004.png",
            startTime: new Date("2026-01-29T07:00:00-08:00"),
            pickWindowOpen: new Date("2026-01-26T07:00:00Z") // Monday 7am UK time
        };

        // Determine which tournament to show on leaderboard
        // If tournament just finished (within last 24 hours), show it
        // Otherwise show upcoming/current
        function getCurrentDisplayTournament() {
            const now = new Date();
            if (justFinishedTournament && now < justFinishedTournament.showUntil) {
                return justFinishedTournament;
            }
            return upcomingTournament;
        }

        // For picks, we use the upcoming tournament
        const currentTournament = upcomingTournament;

        // Next tournament (for when current is in progress)
        const nextTournament = {
            id: 'phoenix-2026',
            name: "WM Phoenix Open",
            dates: "Feb 5 - 8, 2026",
            course: "TPC Scottsdale",
            location: "Scottsdale, AZ",
            purse: 9200000,
            logo: "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R003.png",
            startTime: new Date("2026-02-05T07:00:00-07:00"),
            pickWindowOpen: new Date("2026-02-02T07:00:00Z")
        };

        // TESTING MODE: Set to true to allow picks even after tournament starts
        const ALLOW_LATE_PICKS = true; // Change to false for production

        // Check if tournament has started (picks should be locked)
        function hasTournamentStarted() {
            if (ALLOW_LATE_PICKS) return false; // Bypass for testing
            return new Date() >= currentTournament.startTime;
        }

        // Check if pick window is open for current tournament
        function isPickWindowOpen() {
            if (ALLOW_LATE_PICKS) return true; // Bypass for testing
            const now = new Date();
            return now >= currentTournament.pickWindowOpen && now < currentTournament.startTime;
        }

        // Check if pick window is open for next tournament
        function isNextPickWindowOpen() {
            if (ALLOW_LATE_PICKS) return false; // Only show next when testing is off
            const now = new Date();
            return now >= nextTournament.pickWindowOpen && now < nextTournament.startTime;
        }

        // Get the tournament user should be picking for
        function getActiveTournamentForPicks() {
            if (isPickWindowOpen()) {
                return currentTournament;
            } else if (isNextPickWindowOpen()) {
                return nextTournament;
            }
            return null; // No pick window open
        }

        // Format date for display
        function formatPickWindowTime(date) {
            return date.toLocaleString('en-GB', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        // ESPN API configuration
        const ESPN_API_URL = 'https://site.web.api.espn.com/apis/site/v2/sports/golf/leaderboard?league=pga';

        // Purse payout percentages (based on PGA Tour standard)
        const PURSE_PAYOUTS = {
            1: 0.18, 2: 0.109, 3: 0.069, 4: 0.049, 5: 0.041,
            6: 0.0363, 7: 0.0338, 8: 0.0313, 9: 0.0293, 10: 0.0273,
            11: 0.0253, 12: 0.0233, 13: 0.0213, 14: 0.0193, 15: 0.0183,
            16: 0.0173, 17: 0.0163, 18: 0.0153, 19: 0.0143, 20: 0.0133,
            21: 0.0123, 22: 0.0113, 23: 0.0105, 24: 0.0097, 25: 0.0089,
            26: 0.0081, 27: 0.0078, 28: 0.0075, 29: 0.0072, 30: 0.0069,
            31: 0.0066, 32: 0.0063, 33: 0.006, 34: 0.0057, 35: 0.0055,
            36: 0.0052, 37: 0.005, 38: 0.0048, 39: 0.0046, 40: 0.0044,
            41: 0.0042, 42: 0.004, 43: 0.0038, 44: 0.0036, 45: 0.0034,
            46: 0.0032, 47: 0.003, 48: 0.0028, 49: 0.0027, 50: 0.0026,
            51: 0.0025, 52: 0.0025, 53: 0.0024, 54: 0.0024, 55: 0.0024,
            56: 0.0023, 57: 0.0023, 58: 0.0023, 59: 0.0023, 60: 0.0023,
            61: 0.0022, 62: 0.0022, 63: 0.0022, 64: 0.0022, 65: 0.0022
        };

        function calculateProjectedEarnings(position, purse) {
            if (!position || position === '-' || position === 'WD' || position === 'CUT' || position === 'MC') return 0;
            const posNum = parseInt(position.replace('T', ''));
            if (isNaN(posNum) || posNum > 65) return 0;
            const pct = PURSE_PAYOUTS[posNum] || 0.002;
            return Math.round(purse * pct);
        }

        // Live leaderboard data from ESPN
        let liveLeaderboard = [];
        let espnDataLoaded = false;

        // Fetch live leaderboard from ESPN API
        async function fetchESPNLeaderboard() {
            try {
                const response = await fetch(ESPN_API_URL);
                if (!response.ok) throw new Error('ESPN API request failed');
                
                const data = await response.json();
                
                if (!data.events || !data.events[0] || !data.events[0].competitions) {
                    throw new Error('Invalid ESPN data structure');
                }

                const event = data.events[0];
                const competition = event.competitions[0];
                
                // Update tournament info
                if (event.purse) currentTournament.purse = event.purse;
                if (competition.status && competition.status.period) {
                    currentTournament.round = competition.status.period;
                }

                // Build leaderboard from competitors
                liveLeaderboard = [];
                const competitors = competition.competitors || [];
                
                // Sort by position
                competitors.sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999));

                competitors.forEach(comp => {
                    const athlete = comp.athlete || {};
                    const status = comp.status || {};
                    const position = status.position ? status.position.displayName : '-';
                    const scoreToPar = comp.statistics ? comp.statistics.find(s => s.name === 'scoreToPar') : null;
                    
                    // Parse today's score from todayDetail (e.g., "-6(14)" or "E(F)")
                    let todayScore = 0;
                    if (status.todayDetail) {
                        const match = status.todayDetail.match(/^([+-]?\d+|E)/);
                        if (match) {
                            todayScore = match[1] === 'E' ? 0 : parseInt(match[1]);
                        }
                    }

                    liveLeaderboard.push({
                        playerId: athlete.id,
                        playerName: athlete.displayName || 'Unknown',
                        pos: position,
                        score: scoreToPar ? scoreToPar.value : 0,
                        today: todayScore,
                        thru: status.displayThru || status.thru || '-',
                        projectedEarnings: calculateProjectedEarnings(position, currentTournament.purse),
                        headshot: athlete.headshot ? athlete.headshot.href : null,
                        flag: athlete.flag ? athlete.flag.href : null
                    });
                });

                espnDataLoaded = true;
                console.log('ESPN leaderboard loaded:', liveLeaderboard.length, 'players');
                return liveLeaderboard;

            } catch (error) {
                console.error('Error fetching ESPN leaderboard:', error);
                espnDataLoaded = false;
                return null;
            }
        }

        // Tournament logos and data (from PGA Tour schedule)
        const tournamentLogos = {
            "sony2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R006.png",
            "amex2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R002.png",
            "farmers2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R004.png",
            "atandt2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R054.png",
            "wmphoenix2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R003.png",
            "genesis2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R011.png"
        };

        // 2026 PGA Tour Schedule (upcoming tournaments)
        const upcomingSchedule = [
            {
                id: "farmers2026",
                name: "Farmers Insurance Open",
                dates: "Jan 29 - Feb 1",
                week: 3,
                course: "Torrey Pines GC (South)",
                location: "San Diego, CA",
                purse: 9600000,
                previousWinner: "Harris English",
                previousWinnings: 1674000
            },
            {
                id: "atandt2026",
                name: "AT&T Pebble Beach Pro-Am",
                dates: "Feb 5 - 8",
                week: 4,
                course: "Pebble Beach GL",
                location: "Pebble Beach, CA",
                purse: 20000000,
                previousWinner: "Wyndham Clark",
                previousWinnings: 3600000
            },
            {
                id: "wmphoenix2026",
                name: "WM Phoenix Open",
                dates: "Feb 12 - 15",
                week: 5,
                course: "TPC Scottsdale",
                location: "Scottsdale, AZ",
                purse: 20000000,
                previousWinner: "Scottie Scheffler",
                previousWinnings: 3600000
            },
            {
                id: "genesis2026",
                name: "The Genesis Invitational",
                dates: "Feb 19 - 22",
                week: 6,
                course: "Riviera CC",
                location: "Pacific Palisades, CA",
                purse: 20000000,
                previousWinner: "Hideki Matsuyama",
                previousWinnings: 4000000
            }
        ];

        // PGA Tour player photo URL helper - uses ESPN player IDs
        // Format: https://a.espncdn.com/i/headshots/golf/players/full/{espnId}.png
        function getPlayerPhoto(espnId) {
            return `https://a.espncdn.com/i/headshots/golf/players/full/${espnId}.png`;
        }

        // Complete tournament field - Farmers Insurance Open 2026 (147 players)
        // Field from pgatour.com - includes Brooks Koepka's return to PGA Tour
        const tournamentField = [
            // Top players and notable entries
            { id: "9478", name: "Scottie Scheffler", country: "USA" },
            { id: "10230", name: "Xander Schauffele", country: "USA" },
            { id: "9780", name: "Ludvig √Öberg", country: "SWE" },
            { id: "6007", name: "Patrick Cantlay", country: "USA" },
            { id: "9973", name: "Keegan Bradley", country: "USA" },
            { id: "5162", name: "Chris Gotterup", country: "USA" },
            { id: "1680", name: "Jason Day", country: "AUS" },
            { id: "5408", name: "Harris English", country: "USA" },
            { id: "10596", name: "Matthieu Pavon", country: "FRA" },
            { id: "8973", name: "Max Homa", country: "USA" },
            { id: "10980", name: "Sahith Theegala", country: "USA" },
            { id: "11119", name: "Wyndham Clark", country: "USA" },
            { id: "3702", name: "Justin Rose", country: "ENG" },
            { id: "5430", name: "Brooks Koepka", country: "USA" },
            { id: "388", name: "Adam Scott", country: "AUS" },
            { id: "10030", name: "Zach Bauchou", country: "USA" },
            { id: "10139", name: "Christiaan Bezuidenhout", country: "RSA" },
            { id: "10424", name: "Akshay Bhatia", country: "USA" },
            { id: "4602673", name: "Tom Kim", country: "KOR" },
            { id: "9938", name: "Sam Burns", country: "USA" },
            { id: "11378", name: "Robert MacIntyre", country: "SCO" },
            { id: "4837368", name: "Pierceson Coody", country: "USA" },
            { id: "10522", name: "Eric Cole", country: "USA" },
            { id: "5409", name: "Russell Henley", country: "USA" },
            { id: "6086", name: "Tom Hoge", country: "USA" },
            { id: "4410932", name: "Min Woo Lee", country: "AUS" },
            { id: "9427", name: "Sungjae Im", country: "KOR" },
            { id: "2230", name: "Tony Finau", country: "USA" },
            { id: "9877", name: "Will Zalatoris", country: "USA" },
            { id: "10505", name: "J.T. Poston", country: "USA" },
            { id: "9221", name: "Haotong Li", country: "CHN" },
            { id: "4901368", name: "Matt McCarty", country: "USA" },
            { id: "1651", name: "Billy Horschel", country: "USA" },
            { id: "5860", name: "Rickie Fowler", country: "USA" },
            { id: "3550", name: "Gary Woodland", country: "USA" },
            { id: "7081", name: "Si Woo Kim", country: "KOR" },
            { id: "4375304", name: "Davis Thompson", country: "USA" },
            { id: "10548", name: "Matt Wallace", country: "ENG" },
            { id: "9506", name: "Jordan Smith", country: "ENG" },
            { id: "4698579", name: "S.H. Kim", country: "KOR" },
            { id: "5054388", name: "Jacob Bridgeman", country: "USA" },
            { id: "4585", name: "Hideki Matsuyama", country: "JPN" },
            { id: "4404992", name: "Ben Griffin", country: "USA" },
            { id: "4426181", name: "Sam Stevens", country: "USA" },
            { id: "6011", name: "Beau Hossler", country: "USA" },
            { id: "3792", name: "Nick Taylor", country: "CAN" },
            { id: "11332", name: "Andrew Novak", country: "USA" },
            { id: "9349", name: "Sepp Straka", country: "AUT" },
            { id: "10863", name: "Cam Davis", country: "AUS" },
            { id: "3470", name: "Chez Reavie", country: "USA" },
            { id: "4361187", name: "Lee Hodges", country: "USA" },
            { id: "10664", name: "Taylor Moore", country: "USA" },
            { id: "9037", name: "Luke List", country: "USA" },
            { id: "7631", name: "Brandt Snedeker", country: "USA" },
            { id: "2296", name: "Charley Hoffman", country: "USA" },
            { id: "10372", name: "Adam Schenk", country: "USA" },
            { id: "4848122", name: "Michael Kim", country: "USA" },
            { id: "4589", name: "J.J. Spaun", country: "USA" },
            { id: "3944", name: "Cameron Tringale", country: "USA" },
            { id: "4854714", name: "Blades Brown", country: "USA" },
            { id: "11084", name: "Ryan Gerard", country: "USA" },
            { id: "9611", name: "Andrew Putnam", country: "USA" },
            { id: "4567047", name: "Karl Vilips", country: "USA" },
            { id: "4608030", name: "David Ford", country: "USA" },
            { id: "11205", name: "Austin Smotherman", country: "USA" },
            { id: "4686087", name: "Rico Hoey", country: "PHI" },
            { id: "4832046", name: "Nick Dunlap", country: "USA" },
            { id: "10478", name: "Harry Hall", country: "ENG" },
            { id: "10890", name: "Max Greyserman", country: "USA" },
            { id: "4701789", name: "Sam Ryder", country: "USA" },
            { id: "9997", name: "Ben Silverman", country: "CAN" },
            { id: "10323", name: "Doug Ghim", country: "USA" },
            { id: "4383042", name: "Zac Blair", country: "USA" },
            { id: "3565", name: "Brendon Todd", country: "USA" },
            { id: "4466442", name: "Justin Lower", country: "USA" },
            { id: "4369123", name: "Greyson Sigg", country: "USA" },
            { id: "10093", name: "Kevin Yu", country: "TPE" },
            { id: "4420979", name: "Hayden Springer", country: "USA" },
            { id: "4590141", name: "Patrick Fishburn", country: "USA" },
            { id: "3988", name: "Kevin Streelman", country: "USA" },
            { id: "9179", name: "Mackenzie Hughes", country: "CAN" },
            { id: "4847213", name: "Luke Clanton", country: "USA" },
            { id: "3832", name: "Webb Simpson", country: "USA" },
            { id: "2250", name: "Kevin Chappell", country: "USA" },
            { id: "9424", name: "Stephan Jaeger", country: "GER" },
            { id: "6009", name: "Bud Cauley", country: "USA" },
            { id: "4686086", name: "Joe Highsmith", country: "USA" },
            { id: "4374132", name: "Carson Young", country: "USA" },
            { id: "4364873", name: "Justin Suh", country: "USA" },
            { id: "10216", name: "Vince Whaley", country: "USA" },
            { id: "4410985", name: "Brandon Wu", country: "USA" },
            { id: "9155", name: "Kevin Kisner", country: "USA" },
            { id: "4593911", name: "Chandler Phillips", country: "USA" },
            { id: "10603", name: "Ryan Fox", country: "NZL" },
            { id: "4361914", name: "Chandler Blanchet", country: "USA" },
            { id: "9191", name: "Denny McCarthy", country: "USA" },
            { id: "10425", name: "Davis Riley", country: "USA" },
            { id: "6004", name: "Brendan Steele", country: "USA" },
            { id: "5548", name: "Francesco Molinari", country: "ITA" },
            { id: "3669", name: "Daniel Berger", country: "USA" },
            { id: "10577", name: "Ricky Castillo", country: "USA" },
            { id: "9567", name: "Emiliano Grillo", country: "ARG" },
            { id: "3676", name: "Martin Laird", country: "SCO" },
            { id: "10092", name: "Rafael Campos", country: "PUR" },
            { id: "4364876", name: "Michael Thorbjornsen", country: "USA" },
            { id: "5113338", name: "Davis Chatfield", country: "USA" },
            { id: "11125", name: "Adrien Dumont de Chassart", country: "BEL" },
            { id: "4848080", name: "A.J. Ewart", country: "CAN" },
            { id: "10591", name: "Dan Brown", country: "ENG" },
            { id: "4563229", name: "Austin Eckroat", country: "USA" },
            { id: "4848423", name: "Zecheng Dou", country: "CHN" },
            { id: "9766", name: "Cam Young", country: "USA" },
            { id: "4375117", name: "Parker Coody", country: "USA" },
            { id: "4362403", name: "Johnny Keefer", country: "USA" },
            { id: "4374304", name: "Noah Goodwin", country: "USA" },
            { id: "9028", name: "Martin Trainer", country: "USA" },
            { id: "4361934", name: "John VanDerLaan", country: "USA" },
            { id: "5118", name: "Patton Kizzire", country: "USA" },
            { id: "4848077", name: "Max McGreevy", country: "USA" },
            { id: "6979", name: "Joel Dahmen", country: "USA" },
            { id: "9127", name: "Adam Svensson", country: "CAN" },
            { id: "10592", name: "Thomas Detry", country: "BEL" },
            { id: "9417", name: "Scott Stallings", country: "USA" },
            { id: "4364892", name: "Mac Meissner", country: "USA" },
            { id: "4610892", name: "Trace Crowe", country: "USA" },
            { id: "4592633", name: "Ben Kohles", country: "USA" },
            { id: "11099", name: "Lanto Griffin", country: "USA" },
            { id: "3625", name: "Matt Kuchar", country: "USA" },
            { id: "4375254", name: "Kevin Dougherty", country: "USA" },
            { id: "4848244", name: "Marcus Byrd", country: "USA" }
        ];

        // Enrich tournament field with world rankings from pgaPlayers
        // OWGR data from pgatour.com/tournaments/2026/farmers-insurance-open field page
        const additionalRankings = {
            // Top 20
            "9478": 1,      // Scottie Scheffler
            "10230": 2,     // Xander Schauffele
            "4585": 3,      // Hideki Matsuyama
            "9780": 18,     // Ludvig √Öberg
            "6007": 9,      // Patrick Cantlay
            "9973": 16,     // Keegan Bradley
            "11119": 8,     // Wyndham Clark
            "10980": 14,    // Sahith Theegala
            "9427": 19,     // Sungjae Im
            "2230": 17,     // Tony Finau
            "8973": 13,     // Max Homa
            "3702": 10,     // Justin Rose
            // 20-50
            "9349": 21,     // Sepp Straka
            "9877": 24,     // Will Zalatoris
            "1680": 26,     // Jason Day
            "388": 28,      // Adam Scott
            "4602673": 29,  // Tom Kim
            "9938": 31,     // Sam Burns
            "5430": 33,     // Brooks Koepka
            "10592": 35,    // Thomas Detry
            "5408": 37,     // Harris English
            "11378": 39,    // Robert MacIntyre
            "10596": 41,    // Matthieu Pavon
            "10424": 52,    // Akshay Bhatia
            "5860": 54,     // Rickie Fowler
            // 50-100
            "10522": 56,    // Eric Cole
            "5409": 58,     // Russell Henley
            "10505": 60,    // J.T. Poston
            "4410932": 61,  // Min Woo Lee
            "10863": 63,    // Cam Davis
            "4375304": 65,  // Davis Thompson
            "10591": 67,    // Dan Brown
            "9221": 69,     // Haotong Li
            "6086": 71,     // Tom Hoge
            "9037": 73,     // Luke List
            "7081": 75,     // Si Woo Kim
            "10139": 82,    // Christiaan Bezuidenhout
            "4837368": 89,  // Pierceson Coody
            "4901368": 91,  // Matt McCarty
            "10548": 93,    // Matt Wallace
            "1651": 95,     // Billy Horschel
            // 100+
            "10030": 202,   // Zach Bauchou
            "4361914": 119, // Chandler Blanchet
            "5162": 105,    // Chris Gotterup
            "4686087": 150, // Rico Hoey
            "4832046": 125, // Nick Dunlap
            "9766": 45,     // Cam Young
            "3792": 78,     // Nick Taylor
            "4404992": 85,  // Ben Griffin
            "4426181": 110, // Sam Stevens
            "9506": 88,     // Jordan Smith
            "4698579": 55,  // S.H. Kim
            "3550": 130,    // Gary Woodland
            "5054388": 145, // Jacob Bridgeman
            "6011": 100,    // Beau Hossler
            "11332": 115,   // Andrew Novak
            "4361187": 90,  // Lee Hodges
            "3470": 120,    // Chez Reavie
            "10664": 95,    // Taylor Moore
            "2296": 180,    // Charley Hoffman
            "7631": 200,    // Brandt Snedeker
        };

        // Add rank to each player in tournamentField
        tournamentField.forEach(player => {
            const pgaPlayer = pgaPlayers.find(p => p.id === player.id);
            if (pgaPlayer && pgaPlayer.rank) {
                player.rank = pgaPlayer.rank;
            } else if (additionalRankings[player.id]) {
                player.rank = additionalRankings[player.id];
            } else {
                player.rank = 200; // Default for unranked players
            }
        });

        // Mock leaderboard - actual R1 results from ESPN (Jan 23, 2026)
        // Complete leaderboard so any pick can be tracked
        const mockLeaderboard = [
            // T1 (-10) - Projected 1st place: $1,656,000 (solo winner payout)
            { playerId: "4410932", pos: "T1", score: -10, today: -10, thru: "F", round1: 62, projectedEarnings: 1656000 },
            { playerId: "4837368", pos: "T1", score: -10, today: -10, thru: "F", round1: 62, projectedEarnings: 1656000 },
            // T3 (-9) - Projected 3rd place: $634,800
            { playerId: "4408315", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "7081", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "9478", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "4698579", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "11378", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "1680", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "4901368", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "6007", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            { playerId: "4404992", pos: "T3", score: -9, today: -9, thru: "F", round1: 63, projectedEarnings: 634800 },
            // T12 (-8) - Projected 12th place: $213,900
            { playerId: "4426181", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "1651", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "9506", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "10596", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "11332", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "6086", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "10522", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            { playerId: "5054388", pos: "T12", score: -8, today: -8, thru: "F", round1: 64, projectedEarnings: 213900 },
            // T20 (-7) - Projected 20th place: $121,900
            { playerId: "5408", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "9877", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "6011", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "5409", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "388", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "3792", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "9938", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "4699418", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "5113338", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            { playerId: "10030", pos: "T20", score: -7, today: -7, thru: "F", round1: 65, projectedEarnings: 121900 },
            // T30 (-6) - Projected 30th place: $63,020
            { playerId: "9143", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4425904", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "8889", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4982182", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "3683", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "10548", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "10058", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "10505", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4844", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "5692", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "3550", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "11119", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4349547", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "11056", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4423323", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "257", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4425898", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "5076025", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "11383", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "4587989", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            { playerId: "8973", pos: "T30", score: -6, today: -6, thru: "F", round1: 66, projectedEarnings: 63020 },
            // T51 (-5) - Projected 51st place: $23,092
            { playerId: "5338", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "4410612", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "5882", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "1077", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "6001", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "9364", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "4566443", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "4671", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "11101", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "3702", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "10054", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "10057", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "4408316", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "5147097", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "5150294", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "5211425", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "686", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "9484", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "9658", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            { playerId: "1407", pos: "T51", score: -5, today: -5, thru: "F", round1: 67, projectedEarnings: 23092 },
            // T71 (-4) - Projected 71st place: $18,676
            { playerId: "11456", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "5217048", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "9025", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4375972", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "9221", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4358083", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "6701", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4858572", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "2230", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4589406", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "5113335", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4419142", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "6962", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "7001", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "11387", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "3832", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "8906", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "9243", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "11253", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4426182", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4691931", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            { playerId: "4877953", pos: "T71", score: -4, today: -4, thru: "F", round1: 68, projectedEarnings: 18676 },
            // T93 (-3) - Likely MC
            { playerId: "5075548", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "4585548", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "4602218", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "5724", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "6196", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "3449", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "110", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "5139663", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "1264", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "9037", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "11143", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "3980", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            { playerId: "4618114", pos: "T93", score: -3, today: -3, thru: "F", round1: 69, projectedEarnings: 0 },
            // T106 (-2) - MC projected
            { playerId: "6825", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "4791222", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "4404991", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "4868733", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "10664", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "10863", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "5143175", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "2283", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 0 },
            { playerId: "5076021", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 27600 },
            { playerId: "1030", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 27600 },
            { playerId: "5215039", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 27600 },
            { playerId: "4351896", pos: "T106", score: -2, today: -2, thru: "F", round1: 70, projectedEarnings: 27600 },
            // T118 (-1)
            { playerId: "10980", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "5962", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "10364", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "4921329", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "7120", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "10469", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "8974", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "9144", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "1222", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "4682", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            { playerId: "6937", pos: "T118", score: -1, today: -1, thru: "F", round1: 71, projectedEarnings: 24840 },
            // T130 (E)
            { playerId: "4408320", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "6931", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "4602673", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "4699329", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "569", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "4589438", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "4408319", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "5209442", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "205", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "5502", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            { playerId: "8961", pos: "T130", score: 0, today: 0, thru: "F", round1: 72, projectedEarnings: 23000 },
            // T142 (+1)
            { playerId: "5080439", pos: "T142", score: 1, today: 1, thru: "F", round1: 73, projectedEarnings: 22080 },
            { playerId: "4408318", pos: "T142", score: 1, today: 1, thru: "F", round1: 73, projectedEarnings: 22080 },
            { playerId: "6015", pos: "T142", score: 1, today: 1, thru: "F", round1: 73, projectedEarnings: 22080 },
            { playerId: "3312", pos: "T142", score: 1, today: 1, thru: "F", round1: 73, projectedEarnings: 22080 },
            { playerId: "1225", pos: "T142", score: 1, today: 1, thru: "F", round1: 73, projectedEarnings: 22080 },
            // T147 (+2)
            { playerId: "4361934", pos: "T147", score: 2, today: 2, thru: "F", round1: 74, projectedEarnings: 21344 },
            { playerId: "9127", pos: "T147", score: 2, today: 2, thru: "F", round1: 74, projectedEarnings: 21344 },
            { playerId: "9525", pos: "T147", score: 2, today: 2, thru: "F", round1: 74, projectedEarnings: 21344 },
            // 150 (+3)
            { playerId: "10372", pos: "150", score: 3, today: 3, thru: "F", round1: 75, projectedEarnings: 20792 },
            // T151 (+5)
            { playerId: "11395", pos: "T151", score: 5, today: 5, thru: "F", round1: 77, projectedEarnings: 20424 },
            { playerId: "11385", pos: "T151", score: 5, today: 5, thru: "F", round1: 77, projectedEarnings: 20424 },
            { playerId: "4832046", pos: "T151", score: 5, today: 5, thru: "F", round1: 77, projectedEarnings: 20424 },
            { playerId: "10990", pos: "T151", score: 5, today: 5, thru: "F", round1: 77, projectedEarnings: 20424 },
            // T155 (+6)
            { playerId: "4375977", pos: "T155", score: 6, today: 6, thru: "F", round1: 78, projectedEarnings: 20056 },
            { playerId: "4358081", pos: "T155", score: 6, today: 6, thru: "F", round1: 78, projectedEarnings: 20056 }
        ];

        // Payout structure (approximate based on typical PGA purse distribution)
        const payoutStructure = {
            1: 0.18, 2: 0.109, 3: 0.069, 4: 0.049, 5: 0.041,
            6: 0.0365, 7: 0.034, 8: 0.0315, 9: 0.029, 10: 0.027,
            11: 0.025, 12: 0.023, 13: 0.021, 14: 0.019, 15: 0.017
        };

        // Historical players (from past tournaments this season, not in current field)
        // This ensures we can look up players who were picked in previous weeks
        const historicalPlayers = [
            // Sony Open notables not in AmEx field
            { id: "11515", name: "Chris Gotterup", country: "USA" }, // Sony Open Winner!
            { id: "5076021", name: "Ryan Gerard", country: "USA" }, // 2nd at Sony
        ];

        // Combine all player sources for lookup
        const allPlayers = [...tournamentField, ...pgaPlayers, ...historicalPlayers];

        // Helper function to find player by ID and add photo URL
        function getPlayerById(playerId) {
            // Convert to string for consistent comparison
            const pid = String(playerId);
            const player = allPlayers.find(p => String(p.id) === pid);
            if (player) {
                return {
                    ...player,
                    photo: getPlayerPhoto(player.id)
                };
            }
            console.warn('Player not found:', playerId);
            return { id: playerId, name: 'Unknown Player', country: '', photo: '' };
        }

        // ==================== STATE ====================
        let currentPoolId = null;
        let selectedPlayerId = null;
        let inviteEmails = [];

        // ==================== UTILITY FUNCTIONS ====================
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(amount);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==================== NAVIGATION ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
            } else {
                console.error('Screen not found:', screenId);
                return;
            }

            if (screenId === 'dashboard') {
                try {
                    renderDashboard();
                } catch (e) {
                    console.error('Error rendering dashboard:', e);
                }
            }
        }

        function updateNavigation() {
            const guestNav = document.getElementById('nav-guest');
            const userNav = document.getElementById('nav-user');

            if (store.currentUser) {
                guestNav.style.display = 'none';
                userNav.style.display = 'flex';
                document.getElementById('user-display-name').textContent = store.currentUser.name;
                // Update nav profile picture
                updateNavProfilePicture();
            } else {
                guestNav.style.display = 'flex';
                userNav.style.display = 'none';
            }
        }

        // ==================== AUTH ====================
        async function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value.toLowerCase();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;

            if (password !== confirm) {
                showToast('Passwords do not match', true);
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', true);
                return;
            }

            try {
                if (supabaseClient) {
                    // Use Supabase auth - onAuthStateChange will handle the rest
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: { data: { name } }
                    });
                    if (error) throw error;
                    
                    showToast('Account created! Check your email to confirm.');
                    // onAuthStateChange listener will call setUserFromSession
                } else {
                    // Fallback to local storage
                    if (store.users.find(u => u.email === email)) {
                        showToast('An account with this email already exists', true);
                        return;
                    }
                    const user = { id: generateId(), name, email, password };
                    store.users.push(user);
                    store.currentUser = user;
                    updateNavigation();
                    showToast('Account created successfully!');
                    showScreen('dashboard');
                    checkPendingJoinCode();
                }
            } catch (error) {
                showToast(error.message || 'Signup failed', true);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            const password = document.getElementById('login-password').value;

            try {
                if (supabaseClient) {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });
                    if (error) throw error;
                    
                    // Set user directly instead of waiting for onAuthStateChange
                    store.currentUser = {
                        id: data.user.id,
                        name: data.user.user_metadata?.name || email.split('@')[0],
                        email: email
                    };
                    
                    if (!store.users.find(u => u.id === data.user.id)) {
                        store.users.push(store.currentUser);
                    }
                    
                    console.log('Login successful, loading user data...');
                    await loadUserData();
                    console.log('User data loaded, updating nav...');
                    updateNavigation();
                    console.log('Showing dashboard...');
                    showToast('Welcome back!');
                    showScreen('dashboard');
                    console.log('Dashboard shown');
                    // Check if there's a pending pool to join
                    checkPendingJoinCode();
                } else {
                    // Fallback to local storage
                    const user = store.users.find(u => u.email === email && u.password === password);
                    if (!user) {
                        showToast('Invalid email or password', true);
                        return;
                    }
                    store.currentUser = user;
                    updateNavigation();
                    showToast('Welcome back!');
                    showScreen('dashboard');
                    checkPendingJoinCode();
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast(error.message || 'Login failed', true);
            }
        }

        async function logout() {
            try {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
            } catch (e) {
                console.log('Logout error:', e);
            }
            store.currentUser = null;
            store.pools = [];
            store.picks = [];
            updateNavigation();
            showScreen('landing');
            showToast('Logged out successfully');
        }

        // Load user's pools and picks from Supabase
        let isLoadingUserData = false;
        
        async function loadUserData() {
            if (!supabaseClient || !store.currentUser) {
                console.log('loadUserData: No client or user');
                return;
            }
            
            if (isLoadingUserData) {
                console.log('loadUserData: Already loading, skipping...');
                return;
            }
            
            isLoadingUserData = true;
            console.log('Loading data for user:', store.currentUser.id);
            
            try {
                // Load user's pool memberships
                const { data: poolMembers, error: poolError } = await supabaseRetry(() =>
                    supabaseClient
                        .from('pool_members')
                        .select('pool_id')
                        .eq('user_id', store.currentUser.id)
                );
                
                if (poolError) {
                    console.error('Error loading pool members:', poolError);
                } else if (poolMembers && poolMembers.length > 0) {
                    console.log('Found pool memberships:', poolMembers.length);
                    
                    // Load the actual pools
                    const poolIds = poolMembers.map(pm => pm.pool_id);
                    const { data: pools, error: poolsError } = await supabaseRetry(() =>
                        supabaseClient
                            .from('pools')
                            .select('*')
                            .in('id', poolIds)
                    );
                    
                    if (poolsError) {
                        console.error('Error loading pools:', poolsError);
                    } else if (pools) {
                        for (const dbPool of pools) {
                            // Get members for this pool
                            const { data: members } = await supabaseRetry(() =>
                                supabaseClient
                                    .from('pool_members')
                                    .select('user_id')
                                    .eq('pool_id', dbPool.id)
                            );
                            
                            const memberIds = members ? members.map(m => m.user_id) : [store.currentUser.id];
                            
                            // Load user info for all pool members
                            for (const memberId of memberIds) {
                                if (!store.users.find(u => u.id === memberId)) {
                                    // Try to get user metadata from auth.users (via profiles or just store basic info)
                                    const { data: profile } = await supabaseRetry(() =>
                                        supabaseClient
                                            .from('profiles')
                                            .select('*')
                                            .eq('id', memberId)
                                            .maybeSingle()
                                    );
                                    
                                    if (profile) {
                                        store.users.push({
                                            id: memberId,
                                            name: profile.name || profile.username || 'User',
                                            email: profile.email || '',
                                            profilePicture: profile.profile_picture || null
                                        });
                                    } else {
                                        // Fallback - just use ID as placeholder
                                        store.users.push({
                                            id: memberId,
                                            name: `Player ${memberIds.indexOf(memberId) + 1}`,
                                            email: '',
                                            profilePicture: null
                                        });
                                    }
                                }
                            }
                            
                            const pool = {
                                id: dbPool.id,
                                name: dbPool.name,
                                season: dbPool.season,
                                inviteCode: dbPool.invite_code,
                                createdBy: dbPool.created_by,
                                members: memberIds
                            };
                            
                            const existingIndex = store.pools.findIndex(p => p.id === pool.id);
                            if (existingIndex >= 0) {
                                store.pools[existingIndex] = pool;
                            } else {
                                store.pools.push(pool);
                            }
                        }
                        console.log('Loaded pools:', store.pools.length);
                    }
                } else {
                    console.log('No pool memberships found');
                }
                
                // Load ALL picks for the user's pools (needed for standings)
                // Filter out demo/local pool IDs that aren't valid UUIDs
                const poolIds = store.pools
                    .map(p => p.id)
                    .filter(id => id && id.length > 20 && !id.startsWith('demo'));
                    
                if (poolIds.length > 0) {
                    console.log('Loading picks for pools:', poolIds);
                    const { data: allPicks, error: allPicksError } = await supabaseRetry(() =>
                        supabaseClient
                            .from('picks')
                            .select('*')
                            .in('pool_id', poolIds)
                    );
                    
                    if (allPicksError) {
                        console.error('Error loading all picks:', allPicksError);
                    } else if (allPicks) {
                        allPicks.forEach(pick => {
                            const pickData = {
                                id: pick.id,
                                poolId: pick.pool_id,
                                userId: pick.user_id,
                                tournamentId: pick.tournament_id,
                                playerId: pick.player_id,
                                playerName: pick.player_name,
                                tournamentName: pick.tournament_name,
                                earnings: pick.final_earnings || 0
                            };
                            
                            const existingIndex = store.picks.findIndex(
                                p => p.poolId === pickData.poolId && 
                                     p.userId === pickData.userId && 
                                     p.tournamentId === pickData.tournamentId
                            );
                            if (existingIndex >= 0) {
                                store.picks[existingIndex] = pickData;
                            } else {
                                store.picks.push(pickData);
                            }
                        });
                        console.log('Loaded all picks:', allPicks.length);
                    }
                }
                
                console.log('loadUserData complete');
            } catch (error) {
                console.error('Error in loadUserData:', error);
            } finally {
                isLoadingUserData = false;
            }
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            // Load user's profile picture
            loadUserProfilePicture();
            
            const container = document.getElementById('tournaments-container');
            const userPools = store.pools.filter(p => p.members.includes(store.currentUser.id));

            if (userPools.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No Pools Yet</h3>
                        <p>Create a new pool or join one using an invite link from a friend.</p>
                        <button class="btn btn-primary" onclick="showScreen('create-tournament')">Create Your First Pool</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = userPools.map(pool => {
                const members = pool.members.map(id => store.users.find(u => u.id === id)).filter(Boolean);
                const userPicks = store.picks.filter(p => p.poolId === pool.id && p.userId === store.currentUser.id);
                
                // Calculate user's total earnings from COMPLETED tournaments only
                const userCompletedEarnings = userPicks
                    .filter(p => p.tournamentId !== currentTournament.id)
                    .reduce((sum, p) => sum + (p.earnings || 0), 0);

                // Calculate standings to determine user's rank
                const standings = pool.members.map(memberId => {
                    const memberPicks = store.picks.filter(p => p.poolId === pool.id && p.userId === memberId);
                    const completedEarnings = memberPicks
                        .filter(p => p.tournamentId !== currentTournament.id)
                        .reduce((sum, p) => sum + (p.earnings || 0), 0);
                    return { memberId, completedEarnings };
                }).sort((a, b) => b.completedEarnings - a.completedEarnings);

                // Find user's rank (1-indexed)
                const userRank = standings.findIndex(s => s.memberId === store.currentUser.id) + 1;

                return `
                    <div class="tournament-card">
                        <div class="tournament-header">
                            <h3>${pool.name}</h3>
                            <p>${pool.season}</p>
                        </div>
                        <div class="tournament-body">
                            <div class="tournament-stat">
                                <span>Your Rank</span>
                                <span>${userRank} / ${members.length}</span>
                            </div>
                            <div class="tournament-stat">
                                <span>Your Earnings</span>
                                <span>${formatCurrency(userCompletedEarnings)}</span>
                            </div>
                            <div class="tournament-stat">
                                <span>Picks Used</span>
                                <span>${userPicks.length} / 30</span>
                            </div>
                            <div class="tournament-stat">
                                <span>Current Week</span>
                                <span>${currentTournament.name}</span>
                            </div>
                        </div>
                        <div class="tournament-actions">
                            <button class="btn btn-primary" onclick="openPool('${pool.id}')">View Pool</button>
                            <button class="btn btn-secondary" onclick="showInviteModal('${pool.id}')">Invite</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== PROFILE PICTURE ====================
        let userProfilePicture = null; // Base64 string

        function previewProfilePicture(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image too large. Please use an image under 2MB.', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                userProfilePicture = e.target.result;
                document.getElementById('profile-preview').src = userProfilePicture;
                document.getElementById('remove-photo-btn').style.display = 'inline-block';
                
                // Save to store and localStorage
                if (store.currentUser) {
                    store.currentUser.profilePicture = userProfilePicture;
                    localStorage.setItem('userProfilePicture_' + store.currentUser.id, userProfilePicture);
                }
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePicture() {
            userProfilePicture = null;
            document.getElementById('profile-preview').src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='12'>No Photo</text></svg>";
            document.getElementById('remove-photo-btn').style.display = 'none';
            document.getElementById('profile-picture-input').value = '';
            
            if (store.currentUser) {
                store.currentUser.profilePicture = null;
                localStorage.removeItem('userProfilePicture_' + store.currentUser.id);
            }
        }

        function loadUserProfilePicture() {
            if (store.currentUser) {
                const saved = localStorage.getItem('userProfilePicture_' + store.currentUser.id);
                if (saved) {
                    userProfilePicture = saved;
                    store.currentUser.profilePicture = saved;
                    const preview = document.getElementById('profile-preview');
                    const removeBtn = document.getElementById('remove-photo-btn');
                    if (preview) {
                        preview.src = saved;
                    }
                    if (removeBtn) {
                        removeBtn.style.display = 'inline-block';
                    }
                }
            }
        }

        function getUserProfilePicture(userId) {
            // Check if it's current user
            if (store.currentUser && store.currentUser.id === userId && store.currentUser.profilePicture) {
                return store.currentUser.profilePicture;
            }
            // Check store.users (loaded from Supabase profiles)
            const user = store.users.find(u => u.id === userId);
            if (user && user.profilePicture) {
                return user.profilePicture;
            }
            // Check localStorage as fallback
            const saved = localStorage.getItem('userProfilePicture_' + userId);
            if (saved) return saved;
            // Default avatar
            return "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='24'>üë§</text></svg>";
        }

        // Profile picture change tracking (max 2 per 24 hours)
        const MAX_PROFILE_CHANGES = 2;
        const PROFILE_CHANGE_WINDOW = 24 * 60 * 60 * 1000; // 24 hours in ms
        let pendingProfilePicture = null;

        function getProfileChangeCount() {
            if (!store.currentUser) return 0;
            const key = 'profileChanges_' + store.currentUser.id;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            const now = Date.now();
            // Filter to only changes within the last 24 hours
            const recentChanges = data.filter(timestamp => now - timestamp < PROFILE_CHANGE_WINDOW);
            // Clean up old entries
            localStorage.setItem(key, JSON.stringify(recentChanges));
            return recentChanges.length;
        }

        function recordProfileChange() {
            if (!store.currentUser) return;
            const key = 'profileChanges_' + store.currentUser.id;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            data.push(Date.now());
            localStorage.setItem(key, JSON.stringify(data));
        }

        function canChangeProfilePicture() {
            return getProfileChangeCount() < MAX_PROFILE_CHANGES;
        }

        function getNextProfileChangeTime() {
            if (!store.currentUser) return null;
            const key = 'profileChanges_' + store.currentUser.id;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            if (data.length === 0) return null;
            const oldestChange = Math.min(...data);
            const resetTime = new Date(oldestChange + PROFILE_CHANGE_WINDOW);
            return resetTime;
        }

        function openProfileEditor() {
            const currentPic = getUserProfilePicture(store.currentUser.id);
            document.getElementById('profile-editor-preview').src = currentPic;
            pendingProfilePicture = null;
            
            // Update change limit display
            const changesRemaining = MAX_PROFILE_CHANGES - getProfileChangeCount();
            const limitEl = document.getElementById('profile-change-limit');
            
            if (changesRemaining > 0) {
                limitEl.textContent = `${changesRemaining} change${changesRemaining !== 1 ? 's' : ''} remaining today`;
                limitEl.style.color = 'var(--gray)';
            } else {
                const resetTime = getNextProfileChangeTime();
                if (resetTime) {
                    limitEl.textContent = `Limit reached. You can change again at ${resetTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
                } else {
                    limitEl.textContent = 'Limit reached. Try again later.';
                }
                limitEl.style.color = 'var(--red)';
            }
            
            // Show/hide remove button
            const hasCustomPic = store.currentUser.profilePicture || localStorage.getItem('userProfilePicture_' + store.currentUser.id);
            document.getElementById('remove-profile-btn').style.display = hasCustomPic ? 'inline-block' : 'none';
            document.getElementById('save-profile-btn').style.display = 'none';
            
            document.getElementById('profile-editor-modal').classList.add('active');
        }

        function previewNewProfilePicture(event) {
            if (!canChangeProfilePicture()) {
                showToast('You\'ve reached the limit of 2 profile changes per 24 hours', true);
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be smaller than 2MB', true);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                pendingProfilePicture = e.target.result;
                document.getElementById('profile-editor-preview').src = pendingProfilePicture;
                document.getElementById('save-profile-btn').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        async function saveNewProfilePicture() {
            if (!pendingProfilePicture) return;
            
            if (!canChangeProfilePicture()) {
                showToast('You\'ve reached the limit of 2 profile changes per 24 hours', true);
                return;
            }
            
            // Save to store and localStorage
            store.currentUser.profilePicture = pendingProfilePicture;
            localStorage.setItem('userProfilePicture_' + store.currentUser.id, pendingProfilePicture);
            
            // Save to Supabase profiles table
            if (supabaseClient) {
                try {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .upsert({
                            id: store.currentUser.id,
                            name: store.currentUser.name,
                            email: store.currentUser.email,
                            profile_picture: pendingProfilePicture
                        });
                    if (error) {
                        console.error('Error saving profile picture to Supabase:', error);
                    }
                } catch (err) {
                    console.error('Error saving profile picture:', err);
                }
            }
            
            // Record the change
            recordProfileChange();
            
            // Update nav profile picture
            document.getElementById('nav-profile-pic').src = pendingProfilePicture;
            
            pendingProfilePicture = null;
            closeModal('profile-editor-modal');
            showToast('Profile picture updated!');
        }

        async function removeUserProfilePicture() {
            if (!canChangeProfilePicture()) {
                showToast('You\'ve reached the limit of 2 profile changes per 24 hours', true);
                return;
            }
            
            // Remove from store and localStorage
            store.currentUser.profilePicture = null;
            localStorage.removeItem('userProfilePicture_' + store.currentUser.id);
            
            // Remove from Supabase
            if (supabaseClient) {
                try {
                    const { error } = await supabaseClient
                        .from('profiles')
                        .update({ profile_picture: null })
                        .eq('id', store.currentUser.id);
                    if (error) {
                        console.error('Error removing profile picture from Supabase:', error);
                    }
                } catch (err) {
                    console.error('Error removing profile picture:', err);
                }
            }
            
            // Record the change
            recordProfileChange();
            
            // Reset to default
            const defaultPic = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='24'>üë§</text></svg>";
            document.getElementById('nav-profile-pic').src = defaultPic;
            document.getElementById('profile-editor-preview').src = defaultPic;
            document.getElementById('remove-profile-btn').style.display = 'none';
            document.getElementById('save-profile-btn').style.display = 'none';
            
            closeModal('profile-editor-modal');
            showToast('Profile picture removed');
        }

        function updateNavProfilePicture() {
            if (store.currentUser) {
                const pic = getUserProfilePicture(store.currentUser.id);
                document.getElementById('nav-profile-pic').src = pic;
            }
        }

        function showProfileModal(imageSrc, userName) {
            const modal = document.getElementById('profile-modal');
            const image = document.getElementById('profile-modal-image');
            const name = document.getElementById('profile-modal-name');
            
            image.src = imageSrc;
            name.textContent = userName;
            modal.classList.add('active');
            
            // Prevent scrolling while modal is open
            document.body.style.overflow = 'hidden';
        }

        function showProfileModalFromElement(imgElement, userName) {
            showProfileModal(imgElement.src, userName);
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProfileModal();
                closeModal('profile-editor-modal');
            }
        });

        // ==================== CREATE TOURNAMENT ====================
        function addInvite() {
            const input = document.getElementById('invite-email');
            const email = input.value.toLowerCase().trim();

            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email', true);
                return;
            }

            if (inviteEmails.includes(email)) {
                showToast('This email is already in the invite list', true);
                return;
            }

            inviteEmails.push(email);
            renderInviteList();
            input.value = '';
        }

        function removeInvite(email) {
            inviteEmails = inviteEmails.filter(e => e !== email);
            renderInviteList();
        }

        function renderInviteList() {
            const container = document.getElementById('invite-list');
            container.innerHTML = inviteEmails.map(email => `
                <span class="invite-tag">
                    ${email}
                    <button onclick="removeInvite('${email}')">&times;</button>
                </span>
            `).join('');
        }

        async function handleCreateTournament(event) {
            event.preventDefault();
            const name = document.getElementById('pool-name').value;
            const season = document.getElementById('pool-season').value;

            if (!name || !season) {
                showToast('Please fill in all fields', true);
                return;
            }

            console.log('Creating pool:', name, season);

            try {
                let pool;
                
                if (supabaseClient && store.currentUser) {
                    // Create pool in Supabase
                    const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    console.log('Inserting pool to Supabase...');
                    const { data: newPool, error: poolError } = await supabaseRetry(() =>
                        supabaseClient
                            .from('pools')
                            .insert({
                                name: name,
                                season: season,
                                invite_code: inviteCode,
                                created_by: store.currentUser.id
                            })
                            .select()
                            .single()
                    );
                    
                    if (poolError) {
                        console.error('Pool creation error:', poolError);
                        throw poolError;
                    }
                    
                    console.log('Pool created:', newPool);
                    
                    // Add creator as member
                    console.log('Adding member...');
                    const { error: memberError } = await supabaseRetry(() =>
                        supabaseClient
                            .from('pool_members')
                            .insert({ pool_id: newPool.id, user_id: store.currentUser.id })
                    );
                    
                    if (memberError) {
                        console.error('Member add error:', memberError);
                        throw memberError;
                    }
                    
                    console.log('Member added');
                    
                    pool = {
                        id: newPool.id,
                        name: newPool.name,
                        season: newPool.season,
                        ownerId: store.currentUser.id,
                        members: [store.currentUser.id],
                        inviteCode: newPool.invite_code
                    };
                } else {
                    // Fallback to local
                    pool = {
                        id: generateId(),
                        name,
                        season,
                        ownerId: store.currentUser.id,
                        members: [store.currentUser.id],
                        inviteCode: generateId().toUpperCase()
                    };
                }

                store.pools.push(pool);

                // Send invite emails
                if (inviteEmails.length > 0) {
                    const inviteLink = `${window.location.origin}${window.location.pathname}?join=${pool.inviteCode}`;
                    const subject = encodeURIComponent(`Join my One & Done Golf Pool: ${pool.name}`);
                    const body = encodeURIComponent(
`Hey!

I've created a One & Done golf pool called "${pool.name}" and I'd love for you to join!

Click this link to join:
${inviteLink}

Or use invite code: ${pool.inviteCode}

How it works:
- Pick one golfer each week
- Each golfer can only be used once per season
- Earn their prize money winnings
- Most earnings at season end wins!

See you on the course!`
                    );
                    
                    // Open mailto with all emails
                    const mailtoLink = `mailto:${inviteEmails.join(',')}?subject=${subject}&body=${body}`;
                    window.open(mailtoLink, '_blank');
                    
                    // Also store invites locally
                    inviteEmails.forEach(email => {
                        store.invites.push({
                            id: generateId(),
                            poolId: pool.id,
                            email,
                            status: 'pending'
                        });
                    });
                }

                inviteEmails = [];
                renderInviteList();

                showToast('Pool created successfully!');
                
                // Show the invite modal with the code
                setTimeout(() => {
                    showInviteModal(pool.id);
                }, 500);
                
                showScreen('dashboard');
            } catch (error) {
                console.error('Create pool error:', error);
                showToast(error.message || 'Failed to create pool', true);
            }
        }

        // ==================== LEAVE POOL ====================
        let poolToLeave = null;

        function togglePoolOptions(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('pool-options-dropdown');
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();
            
            // Reset any transforms
            dropdown.style.transform = 'none';
            
            // Position dropdown below the button
            dropdown.style.top = (rect.bottom + 5) + 'px';
            
            // On mobile, position from left to keep it on screen
            if (window.innerWidth < 768) {
                const dropdownWidth = 160;
                let leftPos = rect.left;
                // Make sure it doesn't go off the right edge
                if (leftPos + dropdownWidth > window.innerWidth - 10) {
                    leftPos = window.innerWidth - dropdownWidth - 10;
                }
                dropdown.style.left = leftPos + 'px';
                dropdown.style.right = 'auto';
            } else {
                // Desktop: align to right edge of button
                dropdown.style.right = (window.innerWidth - rect.right) + 'px';
                dropdown.style.left = 'auto';
            }
            
            dropdown.classList.toggle('active');
        }

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('pool-options-dropdown');
            if (dropdown && !e.target.closest('.pool-options-menu')) {
                dropdown.classList.remove('active');
            }
        });

        function confirmLeaveCurrentPool() {
            // Close the dropdown
            document.getElementById('pool-options-dropdown').classList.remove('active');
            
            // Get current pool
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (pool) {
                confirmLeavePool(currentPoolId, pool.name);
            }
        }

        function confirmLeavePool(poolId, poolName) {
            poolToLeave = poolId;
            document.getElementById('leave-pool-name').textContent = `"${poolName}"?`;
            document.getElementById('leave-pool-modal').classList.add('active');
        }

        async function leavePool() {
            if (!poolToLeave) return;

            try {
                // Remove from Supabase if connected
                if (supabaseClient) {
                    // Delete user's picks for this pool
                    const { error: picksError } = await supabaseRetry(() =>
                        supabaseClient
                            .from('picks')
                            .delete()
                            .eq('pool_id', poolToLeave)
                            .eq('user_id', store.currentUser.id)
                    );
                    
                    if (picksError) {
                        console.error('Error deleting picks:', picksError);
                    }

                    // Remove user from pool members
                    const { error: memberError } = await supabaseRetry(() =>
                        supabaseClient
                            .from('pool_members')
                            .delete()
                            .eq('pool_id', poolToLeave)
                            .eq('user_id', store.currentUser.id)
                    );
                    
                    if (memberError) {
                        console.error('Error removing from pool:', memberError);
                    }
                }

                // Remove from local store
                store.picks = store.picks.filter(p => !(p.poolId === poolToLeave && p.userId === store.currentUser.id));
                
                const pool = store.pools.find(p => p.id === poolToLeave);
                if (pool) {
                    pool.members = pool.members.filter(m => m !== store.currentUser.id);
                    // If user is no longer a member, remove from their pools list
                    if (!pool.members.includes(store.currentUser.id)) {
                        store.pools = store.pools.filter(p => p.id !== poolToLeave);
                    }
                }

                closeModal('leave-pool-modal');
                poolToLeave = null;
                currentPoolId = null;
                showToast('You have left the pool');
                showScreen('dashboard');
                renderDashboard();

            } catch (error) {
                console.error('Leave pool error:', error);
                showToast('Failed to leave pool', true);
            }
        }

        // ==================== POOL VIEW ====================
        function openPool(poolId) {
            currentPoolId = poolId;
            selectedPlayerId = null;
            // Save to localStorage so we can restore after refresh
            localStorage.setItem('currentPoolId', poolId);
            showScreen('pool-view');
            switchPoolTab('standings');
            renderPoolView();
            checkTabsOverflow();
        }

        function checkTabsOverflow() {
            // No longer needed - tabs naturally show they're scrollable by being cut off
        }

        function switchPoolTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.pool-tab').forEach(t => t.style.display = 'none');

            // Find and activate the correct tab button
            const tabButton = document.querySelector(`.tab[onclick*="'${tabName}'"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            if (tabName === 'standings') renderStandings();
            if (tabName === 'leaderboard') renderLeaderboard();
            if (tabName === 'pick') renderPlayerSelection();
            if (tabName === 'history') renderHistory();
        }

        function renderPoolView() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;

            document.getElementById('pool-title').textContent = pool.name;
            document.getElementById('pool-season-display').textContent = pool.season;
            renderStandings();
        }

        function renderStandings() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;

            // Use ESPN live data if available, otherwise mock data
            const leaderboardData = espnDataLoaded && liveLeaderboard.length > 0 ? liveLeaderboard : mockLeaderboard;

            const standings = pool.members.map(memberId => {
                const user = store.users.find(u => u.id === memberId) || { id: memberId, name: 'Unknown User' };
                const userPicks = store.picks.filter(p => p.poolId === currentPoolId && p.userId === memberId);
                
                // Calculate total from COMPLETED tournaments only (excludes current week)
                const completedEarnings = userPicks
                    .filter(p => p.tournamentId !== currentTournament.id)
                    .reduce((sum, p) => sum + (p.earnings || 0), 0);

                // Get current week pick and projected earnings (for display only)
                const currentPick = userPicks.find(p => p.tournamentId === currentTournament.id);
                let currentWeekEarnings = 0;
                let currentPlayer = null;

                if (currentPick) {
                    currentPlayer = getPlayerById(currentPick.playerId);
                    // Look in live leaderboard by ID or name
                    let leaderboardEntry = leaderboardData.find(l => String(l.playerId) === String(currentPick.playerId));
                    if (!leaderboardEntry && currentPlayer) {
                        leaderboardEntry = leaderboardData.find(l => 
                            l.playerName && l.playerName.toLowerCase() === currentPlayer.name.toLowerCase()
                        );
                    }
                    // Also try matching by the stored player name from the pick
                    if (!leaderboardEntry && currentPick.playerName) {
                        leaderboardEntry = leaderboardData.find(l => 
                            l.playerName && l.playerName.toLowerCase() === currentPick.playerName.toLowerCase()
                        );
                    }
                    currentWeekEarnings = leaderboardEntry ? leaderboardEntry.projectedEarnings : 0;
                    
                    // Debug logging
                    if (!leaderboardEntry) {
                        console.warn('No leaderboard entry found for pick:', currentPick.playerId, currentPlayer?.name, 'in', leaderboardData.length, 'entries');
                    }
                }

                return {
                    user,
                    picks: userPicks,
                    completedEarnings,
                    totalEarnings: completedEarnings + currentWeekEarnings,
                    currentWeekEarnings,
                    currentPlayer
                };
            }).filter(s => s.user).sort((a, b) => b.completedEarnings - a.completedEarnings); // Sort by COMPLETED earnings only

            const tbody = document.getElementById('standings-body');
            
            if (standings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray);">
                            No members in this pool yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = standings.map((standing, index) => {
                const isCurrentUser = standing.user.id === store.currentUser.id;
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const profilePic = getUserProfilePicture(standing.user.id);
                const userName = standing.user.name || 'Unknown';

                return `
                    <tr class="${isCurrentUser ? 'current-user' : ''}">
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <img src="${profilePic}" alt="" class="clickable-profile" 
                                     style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;"
                                     onclick="event.stopPropagation(); showProfileModalFromElement(this, '${userName.replace(/'/g, "\\'")}')"
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                <strong>${userName}</strong>
                                ${isCurrentUser ? ' (You)' : ''}
                            </div>
                        </td>
                        <td>
                            ${standing.currentPlayer ? `
                                <div class="weekly-pick">
                                    <img src="${standing.currentPlayer.photo || getPlayerPhoto(standing.currentPlayer.id)}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                    <span>${standing.currentPlayer.name}</span>
                                    <span style="color: var(--gold); font-size: 0.8rem; margin-left: 0.25rem;">(${formatCurrency(standing.currentWeekEarnings)} proj)</span>
                                </div>
                            ` : '<span style="color: var(--gray);">No pick yet</span>'}
                        </td>
                        <td style="font-weight: 600; color: var(--green-fairway);">
                            ${formatCurrency(standing.completedEarnings)}
                        </td>
                        <td>${standing.picks.length}</td>
                    </tr>
                `;
            }).join('');
        }

        async function renderLeaderboard() {
            // Use the display tournament (might be just-finished or upcoming)
            const displayTournament = getCurrentDisplayTournament();
            
            document.getElementById('current-tournament-name').textContent = displayTournament.name;
            document.getElementById('tournament-dates').textContent = displayTournament.dates;
            document.getElementById('tournament-course').textContent = displayTournament.course;
            document.getElementById('tournament-round').textContent = displayTournament.status === 'Complete' ? 'Final' : `Round ${displayTournament.round}`;
            document.getElementById('tournament-logo').src = displayTournament.logo;

            // Try to fetch live ESPN data if not already loaded
            if (!espnDataLoaded && liveLeaderboard.length === 0) {
                await fetchESPNLeaderboard();
            }

            // Use ESPN data if available, otherwise fall back to mock data
            const leaderboardData = espnDataLoaded && liveLeaderboard.length > 0 ? liveLeaderboard : mockLeaderboard;

            // Update round display after ESPN fetch
            document.getElementById('tournament-round').textContent = displayTournament.status === 'Complete' ? 'Final' : `Round ${displayTournament.round}`;

            // Get the current pool
            const pool = store.pools.find(p => p.id === currentPoolId);

            // Check if user has a pick for this tournament (use display tournament for leaderboard view)
            const userPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === displayTournament.id
            );

            // Get all pool members' picks for this tournament (for friend tags)
            const poolPicks = store.picks.filter(
                p => p.poolId === currentPoolId && p.tournamentId === displayTournament.id
            );

            // Create a color index map for friends
            const friendColorMap = {};
            let colorIndex = 0;
            pool.members.forEach(memberId => {
                if (memberId !== store.currentUser.id) {
                    friendColorMap[memberId] = colorIndex % 5;
                    colorIndex++;
                }
            });

            const myPickSection = document.getElementById('my-pick-section');

            if (userPick) {
                const player = getPlayerById(userPick.playerId);
                // Look for player in leaderboard by ID or by name
                let leaderboardEntry = leaderboardData.find(l => String(l.playerId) === String(userPick.playerId));
                if (!leaderboardEntry && player) {
                    leaderboardEntry = leaderboardData.find(l => 
                        l.playerName && l.playerName.toLowerCase() === player.name.toLowerCase()
                    );
                }

                myPickSection.style.display = 'flex';
                const photoUrl = leaderboardEntry?.headshot || player?.photo || getPlayerPhoto(userPick.playerId);
                document.getElementById('my-pick-photo').src = photoUrl;
                document.getElementById('my-pick-photo').onerror = function() {
                    this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23e5e7eb" width="100" height="100"/></svg>';
                };
                document.getElementById('my-pick-name').textContent = player?.name || userPick.playerName || 'Unknown';
                document.getElementById('my-pick-position').textContent = leaderboardEntry ? leaderboardEntry.pos : 'N/A';
                document.getElementById('my-pick-earnings').textContent = leaderboardEntry 
                    ? `Projected: ${formatCurrency(leaderboardEntry.projectedEarnings)}`
                    : 'Projected: TBD';
            } else {
                // Show "No pick yet" message
                myPickSection.style.display = 'flex';
                document.getElementById('my-pick-photo').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23e5e7eb" width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="%239ca3af" font-size="12">?</text></svg>';
                document.getElementById('my-pick-name').textContent = 'No Pick Made';
                document.getElementById('my-pick-position').textContent = '-';
                document.getElementById('my-pick-earnings').textContent = 'Make your pick!';
            }

            // Render leaderboard
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = leaderboardData.map(entry => {
                // Try to get player from our database, or use ESPN data
                const player = getPlayerById(entry.playerId);
                const playerName = player?.name || entry.playerName || 'Unknown';
                const playerPhoto = entry.headshot || player?.photo || getPlayerPhoto(entry.playerId);

                // Check if this is user's pick (by ID or name match)
                const isMyPick = userPick && (
                    String(userPick.playerId) === String(entry.playerId) ||
                    (player && getPlayerById(userPick.playerId)?.name.toLowerCase() === playerName.toLowerCase())
                );
                
                // Check if any pool members picked this player
                const memberPicks = poolPicks.filter(p => {
                    const pickPlayer = getPlayerById(p.playerId);
                    return (String(p.playerId) === String(entry.playerId) ||
                        (pickPlayer && pickPlayer.name.toLowerCase() === playerName.toLowerCase())) && 
                        p.userId !== store.currentUser.id;
                });

                const scoreDisplay = entry.score === 0 ? 'E' : 
                    (typeof entry.score === 'number' && entry.score < 0 ? entry.score : `+${entry.score}`);
                const scoreClass = entry.score === 0 ? '' : 
                    (typeof entry.score === 'number' && entry.score < 0 ? 'under' : 'over');

                const todayDisplay = entry.today === 0 ? 'E' : 
                    (typeof entry.today === 'number' && entry.today < 0 ? entry.today : `+${entry.today}`);

                // Build pick tags
                let pickTags = '';
                if (isMyPick) {
                    pickTags += '<span class="pick-tag your-pick">YOUR PICK</span>';
                }
                memberPicks.forEach(pick => {
                    const friendUser = store.users.find(u => u.id === pick.userId);
                    if (friendUser) {
                        const firstName = friendUser.name.split(' ')[0];
                        const colorClass = `friend-pick-${friendColorMap[pick.userId]}`;
                        pickTags += `<span class="pick-tag ${colorClass}">${firstName}'s PICK</span>`;
                    }
                });

                return `
                    <tr class="${isMyPick ? 'my-pick' : ''}">
                        <td class="pos-cell">${entry.pos}</td>
                        <td>
                            <div class="player-cell">
                                <img src="${playerPhoto}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                <span>${playerName}</span>
                                ${pickTags}
                            </div>
                        </td>
                        <td class="score-cell ${scoreClass}">${scoreDisplay}</td>
                        <td class="score-cell ${scoreClass}">${todayDisplay}</td>
                        <td class="thru-cell">${entry.thru}</td>
                        <td class="earnings-cell">${formatCurrency(entry.projectedEarnings)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderPlayerSelection() {
            // Determine which tournament we're picking for
            const activeTournament = getActiveTournamentForPicks();
            const tournamentStarted = hasTournamentStarted();
            const pickWindowOpen = isPickWindowOpen();

            // Update tournament info display
            document.getElementById('pick-tournament-info').textContent = 
                `${currentTournament.name} ‚Ä¢ ${currentTournament.dates}`;
            document.getElementById('pick-tournament-logo').src = currentTournament.logo;

            // Get ALL players this user has picked in this pool (any tournament)
            // But EXCLUDE the current tournament pick (so they can change it)
            const usedPlayerIds = store.picks
                .filter(p => p.poolId === currentPoolId && 
                            p.userId === store.currentUser.id && 
                            p.tournamentId !== currentTournament.id) // Exclude current tournament
                .map(p => String(p.playerId));

            // Check if user already has a pick for THIS tournament
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );

            // SCENARIO 1: Tournament started with existing pick - LOCKED
            if (existingPick && tournamentStarted) {
                const player = getPlayerById(existingPick.playerId);
                document.getElementById('players-list').innerHTML = `
                    <div class="empty-state">
                        <h3>üîí Pick Locked</h3>
                        <p>You've selected <strong>${player ? player.name : 'a player'}</strong> for this tournament.</p>
                        <p style="color: var(--gray); margin-top: 0.5rem;">The tournament is in progress - picks can no longer be changed.</p>
                        <p style="color: var(--gray); margin-top: 0.5rem;">View the leaderboard to track their progress.</p>
                    </div>
                `;
                document.getElementById('confirm-pick-btn').style.display = 'none';
                document.getElementById('current-pick-display').style.display = 'none';
                return;
            }

            // SCENARIO 2: Tournament started, NO pick - missed the window
            if (!existingPick && tournamentStarted) {
                // Check if next tournament pick window is open
                const nextWindowOpen = isNextPickWindowOpen();
                
                let nextPickMessage = '';
                if (nextWindowOpen) {
                    nextPickMessage = `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f9f4; border-radius: 8px; border-left: 4px solid var(--green-fairway);">
                            <h4 style="color: var(--green-fairway); margin-bottom: 0.5rem;">‚úÖ Pick Now Open for Next Week</h4>
                            <p><strong>${nextTournament.name}</strong> (${nextTournament.dates})</p>
                            <p style="color: var(--gray); margin-top: 0.25rem;">Pick closes: ${formatPickWindowTime(nextTournament.startTime)}</p>
                        </div>
                    `;
                } else {
                    nextPickMessage = `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem;">üìÖ Next Pick Window</h4>
                            <p><strong>${nextTournament.name}</strong> (${nextTournament.dates})</p>
                            <p style="color: var(--gray); margin-top: 0.25rem;">Opens: ${formatPickWindowTime(nextTournament.pickWindowOpen)}</p>
                        </div>
                    `;
                }

                document.getElementById('players-list').innerHTML = `
                    <div class="empty-state">
                        <h3>‚è∞ Pick Window Closed</h3>
                        <p><strong>${currentTournament.name}</strong> has already started.</p>
                        <p style="color: var(--gray); margin-top: 0.5rem;">You missed the pick window for this week.</p>
                        ${nextPickMessage}
                    </div>
                `;
                document.getElementById('confirm-pick-btn').style.display = 'none';
                document.getElementById('current-pick-display').style.display = 'none';
                return;
            }

            // SCENARIO 3: Pick window not yet open
            if (!pickWindowOpen && !tournamentStarted) {
                document.getElementById('players-list').innerHTML = `
                    <div class="empty-state">
                        <h3>üïê Pick Window Not Open Yet</h3>
                        <p>Picks for <strong>${currentTournament.name}</strong> open:</p>
                        <p style="font-size: 1.2rem; font-weight: 600; color: var(--green-fairway); margin: 1rem 0;">
                            ${formatPickWindowTime(currentTournament.pickWindowOpen)}
                        </p>
                        <p style="color: var(--gray);">Check back then to make your pick!</p>
                    </div>
                `;
                document.getElementById('confirm-pick-btn').style.display = 'none';
                document.getElementById('current-pick-display').style.display = 'none';
                return;
            }

            // SCENARIO 4: Pick window open with existing pick - can change
            if (existingPick && pickWindowOpen) {
                const player = getPlayerById(existingPick.playerId);
                selectedPlayerId = existingPick.playerId; // Pre-select current pick
                
                // Show change pick UI
                const currentPickDisplay = document.getElementById('current-pick-display');
                currentPickDisplay.style.display = 'flex';
                document.getElementById('selected-player-name').textContent = player.name;
                
                document.getElementById('confirm-pick-btn').style.display = 'block';
                document.getElementById('confirm-pick-btn').textContent = 'UPDATE PICK';
                document.getElementById('confirm-pick-btn').disabled = true; // Disabled until they select someone different
                
                document.getElementById('pick-warning').innerHTML = 
                    `<strong>Current pick:</strong> ${player.name}. You can change your pick until the tournament starts.`;
            } else {
                // SCENARIO 5: Pick window open, no pick yet - can pick
                document.getElementById('current-pick-display').style.display = 'none';
                document.getElementById('confirm-pick-btn').style.display = 'block';
                document.getElementById('confirm-pick-btn').textContent = 'CONFIRM PICK';
            }

            renderPlayersListFiltered('', usedPlayerIds, existingPick);
        }

        function renderPlayersListFiltered(searchTerm, usedPlayerIds, existingPick = null) {
            const container = document.getElementById('players-list');
            
            // Use tournament field (players in THIS WEEK'S tournament)
            // Filter by search term, then sort by world ranking
            const filtered = tournamentField
                .filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                .sort((a, b) => (a.rank || 999) - (b.rank || 999)); // Sort by rank, unranked at bottom

            // Check if tournament has started - only show leaderboard data if it has
            const tournamentStarted = new Date() >= currentTournament.startTime;

            container.innerHTML = filtered.map(player => {
                const isUsed = usedPlayerIds.includes(String(player.id));
                const isSelected = String(selectedPlayerId) === String(player.id);
                const isCurrentPick = existingPick && String(existingPick.playerId) === String(player.id);
                
                // Only get leaderboard data if tournament has started
                let currentPos = '-';
                let currentScore = '-';
                if (tournamentStarted) {
                    const leaderboardEntry = mockLeaderboard.find(l => String(l.playerId) === String(player.id));
                    if (leaderboardEntry) {
                        currentPos = leaderboardEntry.pos;
                        currentScore = leaderboardEntry.score < 0 ? leaderboardEntry.score : 
                            (leaderboardEntry.score === 0 ? 'E' : `+${leaderboardEntry.score}`);
                    }
                }

                // Show world ranking
                const worldRank = player.rank ? `#${player.rank}` : '-';

                return `
                    <div class="player-item ${isUsed ? 'disabled' : ''} ${isSelected ? 'selected' : ''} ${isCurrentPick ? 'current-pick' : ''}"
                         onclick="${isUsed ? '' : `selectPlayer('${player.id}')`}">
                        <img class="player-photo" src="${getPlayerPhoto(player.id)}" alt="${player.name}"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                        <div class="player-info">
                            <h4>${player.name}</h4>
                            <p>${player.country} ‚Ä¢ OWGR ${worldRank}</p>
                        </div>
                        ${isUsed ? '<span class="used-badge">Already Used</span>' : ''}
                        ${isCurrentPick ? '<span class="current-badge">Current Pick</span>' : ''}
                        <div class="player-rank">
                            ${tournamentStarted ? `
                                <strong>${currentPos}</strong>
                                <span>${currentScore}</span>
                            ` : `
                                <span style="color: var(--gray); font-size: 0.8rem;">Not started</span>
                            `}
                        </div>
                    </div>
                `;
            }).join('');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No players found matching "${searchTerm}"</p>
                    </div>
                `;
            }
        }

        function filterPlayers() {
            const searchTerm = document.getElementById('player-search').value;
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );
            const usedPlayerIds = store.picks
                .filter(p => p.poolId === currentPoolId && 
                            p.userId === store.currentUser.id &&
                            p.tournamentId !== currentTournament.id)
                .map(p => String(p.playerId));
            renderPlayersListFiltered(searchTerm, usedPlayerIds, existingPick);
        }

        function selectPlayer(playerId) {
            selectedPlayerId = String(playerId);
            const player = getPlayerById(playerId);

            // Check if there's an existing pick for this tournament
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );

            // Update UI
            const usedPlayerIds = store.picks
                .filter(p => p.poolId === currentPoolId && 
                            p.userId === store.currentUser.id &&
                            p.tournamentId !== currentTournament.id)
                .map(p => String(p.playerId));
            renderPlayersListFiltered(document.getElementById('player-search').value, usedPlayerIds, existingPick);

            // Show current selection
            const currentPickDisplay = document.getElementById('current-pick-display');
            currentPickDisplay.style.display = 'flex';
            document.getElementById('selected-player-name').textContent = player.name;

            // Update button and warning based on whether this is a new pick or change
            const confirmBtn = document.getElementById('confirm-pick-btn');
            if (existingPick) {
                const isSamePlayer = String(existingPick.playerId) === String(playerId);
                confirmBtn.textContent = isSamePlayer ? 'CURRENT PICK' : 'UPDATE PICK';
                confirmBtn.disabled = isSamePlayer;
                document.getElementById('pick-warning').innerHTML = isSamePlayer
                    ? `<strong>${player.name}</strong> is your current pick. Select a different player to change.`
                    : `<strong>Change pick to ${player.name}?</strong> You can still change until the tournament starts.`;
            } else {
                confirmBtn.textContent = 'CONFIRM PICK';
                confirmBtn.disabled = false;
                document.getElementById('pick-warning').innerHTML = 
                    `<strong>Warning:</strong> Once the tournament starts, you cannot change your pick. ${player.name} will be unavailable for the rest of the season.`;
            }
        }

        async function confirmPick() {
            if (!selectedPlayerId) return;

            // Double-check tournament hasn't started (in case user had page open)
            if (hasTournamentStarted()) {
                showToast('Tournament has already started - picks are locked!', true);
                renderPlayerSelection(); // Re-render to show locked state
                return;
            }

            const player = getPlayerById(selectedPlayerId);

            try {
                if (supabaseClient) {
                    // Save pick to Supabase
                    const { data, error } = await supabaseClient
                        .from('picks')
                        .upsert({
                            pool_id: currentPoolId,
                            user_id: store.currentUser.id,
                            tournament_id: currentTournament.id,
                            player_id: String(selectedPlayerId),
                            player_name: player.name
                        }, {
                            onConflict: 'pool_id,user_id,tournament_id'
                        })
                        .select()
                        .single();
                    
                    if (error) throw error;
                    
                    // Update local store
                    const existingPickIndex = store.picks.findIndex(
                        p => p.poolId === currentPoolId && 
                        p.userId === store.currentUser.id && 
                        p.tournamentId === currentTournament.id
                    );

                    const pickData = {
                        id: data.id,
                        poolId: currentPoolId,
                        userId: store.currentUser.id,
                        playerId: String(selectedPlayerId),
                        tournamentId: currentTournament.id,
                        tournamentName: currentTournament.name,
                        timestamp: new Date().toISOString(),
                        earnings: 0
                    };

                    if (existingPickIndex !== -1) {
                        store.picks[existingPickIndex] = pickData;
                        showToast(`Pick updated to ${player.name}!`);
                    } else {
                        store.picks.push(pickData);
                        showToast(`${player.name} locked in for ${currentTournament.name}!`);
                    }
                } else {
                    // Fallback to local storage
                    const existingPickIndex = store.picks.findIndex(
                        p => p.poolId === currentPoolId && 
                        p.userId === store.currentUser.id && 
                        p.tournamentId === currentTournament.id
                    );

                    if (existingPickIndex !== -1) {
                        store.picks[existingPickIndex].playerId = String(selectedPlayerId);
                        store.picks[existingPickIndex].timestamp = new Date().toISOString();
                        showToast(`Pick updated to ${player.name}!`);
                    } else {
                        const pick = {
                            id: generateId(),
                            poolId: currentPoolId,
                            userId: store.currentUser.id,
                            playerId: String(selectedPlayerId),
                            tournamentId: currentTournament.id,
                            tournamentName: currentTournament.name,
                            timestamp: new Date().toISOString(),
                            earnings: 0
                        };
                        store.picks.push(pick);
                        showToast(`${player.name} locked in for ${currentTournament.name}!`);
                    }
                }

                selectedPlayerId = null;
                switchPoolTab('leaderboard');
            } catch (error) {
                showToast(error.message || 'Failed to save pick', true);
            }
        }

        function renderHistory() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            
            // Get user's picks
            const userPicks = store.picks
                .filter(p => p.poolId === currentPoolId && p.userId === store.currentUser.id)
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            const tbody = document.getElementById('history-body');

            if (userPicks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state" style="padding: 3rem;">
                            <h3>No Picks Yet</h3>
                            <p>Make your first pick to start tracking your history.</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = userPicks.map((pick, index) => {
                    const player = getPlayerById(pick.playerId);
                    const leaderboardEntry = mockLeaderboard.find(l => String(l.playerId) === String(pick.playerId));
                    const isCurrentTournament = pick.tournamentId === currentTournament.id;
                    const tournamentLogo = tournamentLogos[pick.tournamentId] || '';
                    // Get tournament name - fallback to current tournament if it matches, otherwise use ID
                    const tournamentName = pick.tournamentName || 
                        (isCurrentTournament ? currentTournament.name : pick.tournamentId);

                    return `
                        <tr>
                            <td>${userPicks.length - index}</td>
                            <td>
                                <div class="player-cell">
                                    ${tournamentLogo ? `<img src="${tournamentLogo}" class="tournament-logo-small" alt="" onerror="this.style.display='none'">` : ''}
                                    <span>${tournamentName}</span>
                                </div>
                            </td>
                            <td>
                                <div class="player-cell">
                                    <img src="${player ? (player.photo || getPlayerPhoto(pick.playerId)) : ''}" alt="" 
                                         onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                    <span>${player ? player.name : 'Unknown'}</span>
                                </div>
                            </td>
                            <td>
                                ${isCurrentTournament ? 
                                    `<span style="color: var(--gold); font-weight: 600;">In Progress (${leaderboardEntry ? leaderboardEntry.pos : 'TBD'})</span>` :
                                    (pick.finish || '-')
                                }
                            </td>
                            <td class="earnings-cell">
                                ${isCurrentTournament && leaderboardEntry ? 
                                    formatCurrency(leaderboardEntry.projectedEarnings) + ' (proj)' :
                                    formatCurrency(pick.earnings || 0)
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Render friends' pick history
            const friendsContainer = document.getElementById('friends-history');
            const otherMembers = pool.members.filter(m => m !== store.currentUser.id);
            
            if (otherMembers.length === 0) {
                friendsContainer.innerHTML = `<p style="padding: 1.5rem; color: var(--gray);">No other pool members yet.</p>`;
            } else {
                friendsContainer.innerHTML = otherMembers.map(memberId => {
                    const user = store.users.find(u => u.id === memberId);
                    const memberPicks = store.picks
                        .filter(p => p.poolId === currentPoolId && p.userId === memberId)
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    return `
                        <div style="border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem;">
                            <h4 style="margin-bottom: 0.75rem; font-family: 'Oswald', sans-serif; color: var(--green-deep);">${user ? user.name : 'Unknown'}</h4>
                            ${memberPicks.length === 0 ? 
                                `<p style="color: var(--gray); font-size: 0.9rem;">No picks yet</p>` :
                                `<div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                                    ${memberPicks.map(pick => {
                                        const player = getPlayerById(pick.playerId);
                                        const isCurrentTournament = pick.tournamentId === currentTournament.id;
                                        const leaderboardEntry = isCurrentTournament ? mockLeaderboard.find(l => String(l.playerId) === String(pick.playerId)) : null;
                                        const tournamentLogo = tournamentLogos[pick.tournamentId] || '';
                                        const tournamentName = pick.tournamentName || 
                                            (isCurrentTournament ? currentTournament.name : pick.tournamentId);
                                        const shortName = tournamentName.split(' ').slice(0, 2).join(' ');
                                        
                                        // Get earnings - either projected (current) or final (completed)
                                        const earnings = isCurrentTournament && leaderboardEntry ? 
                                            leaderboardEntry.projectedEarnings : 
                                            (pick.earnings || 0);
                                        const earningsLabel = isCurrentTournament && leaderboardEntry ? 'proj' : '';
                                        
                                        return `
                                            <div style="background: #f9fafb; padding: 0.5rem 0.75rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                                ${tournamentLogo ? `<img src="${tournamentLogo}" style="width: 24px; height: 24px; object-fit: contain;" alt="">` : ''}
                                                <span style="color: var(--gray);">${shortName}:</span>
                                                <strong>${player ? player.name : 'Unknown'}</strong>
                                                ${isCurrentTournament && leaderboardEntry ? 
                                                    `<span style="color: var(--gold);">(${leaderboardEntry.pos})</span>` :
                                                    (pick.finish ? `<span style="color: var(--gray);">(${pick.finish})</span>` : '')
                                                }
                                                <span style="color: var(--green-fairway); font-weight: 600;">${formatCurrency(earnings)}${earningsLabel ? ' (' + earningsLabel + ')' : ''}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>`
                            }
                        </div>
                    `;
                }).join('');
            }

            // Render upcoming schedule
            const scheduleBody = document.getElementById('schedule-body');
            scheduleBody.innerHTML = upcomingSchedule.map(tournament => {
                const logo = tournamentLogos[tournament.id] || '';
                return `
                    <tr>
                        <td>${tournament.week}</td>
                        <td>
                            <div class="player-cell">
                                ${logo ? `<img src="${logo}" class="tournament-logo-small" alt="" onerror="this.style.display='none'">` : ''}
                                <strong>${tournament.name}</strong>
                            </div>
                        </td>
                        <td>${tournament.dates}</td>
                        <td>${tournament.course}</td>
                        <td>
                            <span style="color: var(--green-fairway);">${tournament.previousWinner}</span>
                            <span style="color: var(--gray); font-size: 0.8rem;">(${formatCurrency(tournament.previousWinnings)})</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== MODALS ====================
        function showInviteModal(poolId) {
            const pool = store.pools.find(p => p.id === poolId);
            if (!pool) return;

            currentPoolId = poolId;
            const inviteLink = `${window.location.origin}${window.location.pathname}?join=${pool.inviteCode}`;
            
            document.getElementById('invite-link-input').value = inviteLink;
            document.getElementById('sent-invites-list').innerHTML = '';
            document.getElementById('modal-invite-email').value = '';
            document.getElementById('invite-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function copyInviteLink() {
            const link = document.getElementById('invite-link-input').value;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Link copied!');
            });
        }

        async function sendEmailInvite() {
            const emailInput = document.getElementById('modal-invite-email');
            const email = emailInput.value.toLowerCase().trim();
            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email', true);
                return;
            }

            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) {
                showToast('Could not find pool', true);
                return;
            }

            const sendBtn = event.target.closest('button') || document.querySelector('#invite-modal button[onclick*="sendEmailInvite"]');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;

            try {
                const inviteLink = `${window.location.origin}${window.location.pathname}?join=${pool.inviteCode}`;
                
                // Call the Edge Function to send email
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-invite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        email: email,
                        poolName: pool.name,
                        inviteCode: pool.inviteCode,
                        inviteLink: inviteLink,
                        inviterName: store.currentUser.name
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send invite');
                }

                // Store invite in database
                if (supabaseClient) {
                    await supabaseRetry(() =>
                        supabaseClient
                            .from('invites')
                            .insert({
                                pool_id: pool.id,
                                email: email,
                                invite_code: pool.inviteCode,
                                invited_by: store.currentUser.id,
                                status: 'sent'
                            })
                    );
                }

                // Store locally too
                store.invites.push({
                    id: generateId(),
                    poolId: pool.id,
                    email,
                    status: 'sent'
                });

                // Add to sent list in modal
                const sentList = document.getElementById('sent-invites-list');
                sentList.innerHTML += `<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f0f9f4; border-radius: 6px; margin-top: 0.5rem;">
                    <span style="color: var(--green-fairway);">‚úì</span>
                    <span style="font-size: 0.9rem;">${email}</span>
                </div>`;

                showToast(`Invite sent to ${email}!`);
                emailInput.value = '';

            } catch (error) {
                console.error('Send invite error:', error);
                showToast(error.message || 'Failed to send invite', true);
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        function emailInviteLink() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) {
                console.error('No pool found for currentPoolId:', currentPoolId);
                showToast('Could not find pool', true);
                return;
            }
            
            const inviteLink = document.getElementById('invite-link').textContent;
            const subject = encodeURIComponent(`Join my One & Done Golf Pool: ${pool.name}`);
            const body = encodeURIComponent(
`Hey!

I've created a One & Done golf pool and I'd love for you to join!

Click this link to join:
${inviteLink}

Or use invite code: ${pool.inviteCode}

See you on the course!`
            );
            
            // Use location.href for better compatibility
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ==================== INIT ====================
        // Add some demo data for testing
        function initDemoData() {
            // Demo users
            store.users.push({
                id: 'demo1',
                name: 'Demo User',
                email: 'demo@example.com',
                password: 'password123'
            });

            store.users.push({
                id: 'friend1',
                name: 'Tiger Woods Fan',
                email: 'tiger@example.com',
                password: 'password123'
            });

            store.users.push({
                id: 'friend2',
                name: 'Golf Buddy',
                email: 'buddy@example.com',
                password: 'password123'
            });

            // Demo pool
            store.pools.push({
                id: 'demo-pool',
                name: 'Office Golf League 2026',
                season: '2025-2026 PGA Tour Season',
                ownerId: 'demo1',
                members: ['demo1', 'friend1', 'friend2'],
                inviteCode: 'DEMO2026'
            });

            // 2026 Season: The Sentry was CANCELLED due to drought at Kapalua
            // Sony Open in Hawaii (Jan 15-18) was the FIRST tournament - Chris Gotterup won
            // The American Express (Jan 22-25) is currently in progress

            // Sony Open picks (Week 1 - the only completed tournament so far)
            store.picks.push({
                id: 'pick1',
                poolId: 'demo-pool',
                userId: 'demo1',
                playerId: '11378', // Robert MacIntyre - T4 at Sony Open ($409,500)
                tournamentId: 'sony2026',
                tournamentName: 'Sony Open in Hawaii',
                timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                earnings: 409500,
                finish: 'T4'
            });

            store.picks.push({
                id: 'pick2',
                poolId: 'demo-pool',
                userId: 'friend1',
                playerId: '9025', // Daniel Berger - T6 at Sony Open ($287,105)
                tournamentId: 'sony2026',
                tournamentName: 'Sony Open in Hawaii',
                timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                earnings: 287105,
                finish: 'T6'
            });

            store.picks.push({
                id: 'pick3',
                poolId: 'demo-pool',
                userId: 'friend2',
                playerId: '7081', // Si Woo Kim - T11 at Sony Open ($220,675)
                tournamentId: 'sony2026',
                tournamentName: 'Sony Open in Hawaii',
                timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                earnings: 220675,
                finish: 'T11'
            });

            // Current week picks (The American Express - in progress)
            // Friend1 picked Scottie Scheffler (currently T3 at -9)
            store.picks.push({
                id: 'pick4',
                poolId: 'demo-pool',
                userId: 'friend1',
                playerId: '9478', // Scottie Scheffler
                tournamentId: 'amex2026',
                tournamentName: 'The American Express',
                timestamp: new Date().toISOString(),
                earnings: 0
            });

            // Friend2 picked Min Woo Lee (currently T1 at -10!)
            store.picks.push({
                id: 'pick5',
                poolId: 'demo-pool',
                userId: 'friend2',
                playerId: '4410932', // Min Woo Lee
                tournamentId: 'amex2026',
                tournamentName: 'The American Express',
                timestamp: new Date().toISOString(),
                earnings: 0
            });

            // Demo user hasn't made their pick yet for The American Express!
        }

        // Only load demo data if not using Supabase
        if (!supabaseClient) {
            initDemoData();
        }

        // Helper to set user from session
        let isLoadingSession = false;
        
        async function setUserFromSession(session) {
            if (!session || !session.user) return;
            if (isLoadingSession) return; // Prevent duplicate calls
            
            isLoadingSession = true;
            
            try {
                store.currentUser = {
                    id: session.user.id,
                    name: session.user.user_metadata?.name || session.user.email.split('@')[0],
                    email: session.user.email
                };
                
                if (!store.users.find(u => u.id === session.user.id)) {
                    store.users.push(store.currentUser);
                }
                
                await loadUserData();
                updateNavigation();
                
                // Check if we were viewing a pool before refresh
                const savedPoolId = localStorage.getItem('currentPoolId');
                if (savedPoolId && store.pools.find(p => p.id === savedPoolId)) {
                    openPool(savedPoolId);
                } else {
                    showScreen('dashboard');
                }
                
                console.log('Session active for:', store.currentUser.email);
            } finally {
                isLoadingSession = false;
            }
        }

        // Listen for auth state changes (login, logout, token refresh)
        if (supabaseClient) {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                
                // Only handle INITIAL_SESSION (page load with existing session)
                // SIGNED_IN is handled by handleLogin directly
                if (event === 'INITIAL_SESSION' && session) {
                    await setUserFromSession(session);
                    // Check for join code after user is loaded
                    checkJoinCodeFromURL();
                    checkPendingJoinCode();
                } else if (event === 'SIGNED_OUT') {
                    store.currentUser = null;
                    store.pools = [];
                    store.picks = [];
                    updateNavigation();
                    showScreen('landing');
                } else if (event === 'TOKEN_REFRESHED' && session) {
                    // Just update the user info, don't reload everything
                    store.currentUser = {
                        id: session.user.id,
                        name: session.user.user_metadata?.name || session.user.email.split('@')[0],
                        email: session.user.email
                    };
                }
            });
        }

        // Check for join code in URL and handle joining a pool
        let pendingJoinCode = null;

        function checkJoinCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinCode = urlParams.get('join');
            
            if (joinCode) {
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                
                if (store.currentUser) {
                    // User is logged in, join immediately
                    joinPoolWithCode(joinCode);
                } else {
                    // Save for after login/signup
                    pendingJoinCode = joinCode;
                    localStorage.setItem('pendingJoinCode', joinCode);
                    showToast('Please log in or sign up to join the pool');
                    showScreen('login');
                }
            }
        }

        // Check for pending join code after login
        function checkPendingJoinCode() {
            const savedCode = pendingJoinCode || localStorage.getItem('pendingJoinCode');
            if (savedCode && store.currentUser) {
                pendingJoinCode = null;
                localStorage.removeItem('pendingJoinCode');
                joinPoolWithCode(savedCode);
            }
        }

        async function joinPoolWithCode(inviteCode) {
            try {
                showToast('Joining pool...');
                
                console.log('Looking for pool with invite code:', inviteCode.toUpperCase());
                
                // Find the pool by invite code
                const { data: pool, error: poolError } = await supabaseRetry(() =>
                    supabaseClient
                        .from('pools')
                        .select('*')
                        .eq('invite_code', inviteCode.toUpperCase())
                        .maybeSingle()
                );

                console.log('Pool lookup result:', pool, poolError);

                if (poolError) {
                    console.error('Pool lookup error:', poolError);
                    showToast('Error finding pool', true);
                    return;
                }

                if (!pool) {
                    showToast('Invalid invite code', true);
                    return;
                }

                // Check if already a member
                const { data: existingMember } = await supabaseRetry(() =>
                    supabaseClient
                        .from('pool_members')
                        .select('*')
                        .eq('pool_id', pool.id)
                        .eq('user_id', store.currentUser.id)
                        .maybeSingle()
                );

                if (existingMember) {
                    showToast('You\'re already in this pool!');
                    // Open the pool
                    await loadUserData();
                    openPool(pool.id);
                    return;
                }

                // Add user to pool
                const { error: memberError } = await supabaseRetry(() =>
                    supabaseClient
                        .from('pool_members')
                        .insert({
                            pool_id: pool.id,
                            user_id: store.currentUser.id,
                            role: 'member'
                        })
                );

                if (memberError) {
                    console.error('Join pool error:', memberError);
                    showToast('Failed to join pool', true);
                    return;
                }

                // Reload data and open the pool
                await loadUserData();
                showToast(`Welcome to ${pool.name}!`);
                openPool(pool.id);

            } catch (error) {
                console.error('Join pool error:', error);
                showToast('Failed to join pool', true);
            }
        }

        // Check URL for join code on page load
        // This handles the case where user clicks invite link
        checkJoinCodeFromURL();

        // Check tabs overflow on resize
        window.addEventListener('resize', () => {
            checkTabsOverflow();
        });
    </script>
</body>
</html>
