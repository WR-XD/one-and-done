<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>One & Done Golf | PGA Tour Fantasy</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --green-deep: #0a3622;
            --green-fairway: #1a5c3a;
            --green-light: #2d8a5e;
            --gold: #c4a747;
            --gold-light: #e8d78a;
            --cream: #f5f2e8;
            --white: #ffffff;
            --dark: #1a1a1a;
            --gray: #6b7280;
            --red: #dc2626;
            --shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans 3', sans-serif;
            background: var(--cream);
            color: var(--dark);
            min-height: 100vh;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            background: var(--gold);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo-image {
            height: 80px;
            width: auto;
        }

        .logo h1 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--white);
            letter-spacing: 1px;
        }

        .logo span {
            color: var(--gold);
        }

        nav {
            display: flex;
            gap: 1rem;
        }

        .nav-btn {
            padding: 0.4rem 0.9rem;
            border: 2px solid var(--gold);
            background: transparent;
            color: var(--gold);
            font-family: 'Oswald', sans-serif;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
        }

        .nav-btn:hover {
            background: var(--gold);
            color: var(--green-deep);
        }

        .nav-btn.primary {
            background: var(--gold);
            color: var(--green-deep);
        }

        .nav-btn.primary:hover {
            background: var(--gold-light);
        }

        .nav-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            margin-right: 1rem;
        }

        .nav-profile img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--gold);
            transition: transform 0.2s, border-color 0.2s;
        }

        .nav-profile:hover img {
            transform: scale(1.05);
            border-color: var(--gold-light);
        }

        .nav-profile-edit {
            font-size: 0.7rem;
            color: var(--gold);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Main Content Areas */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Screen visibility */
        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        /* Landing Page */
        .hero {
            text-align: center;
            padding: 4rem 2rem;
            background: linear-gradient(180deg, rgba(10,54,34,0.05) 0%, transparent 100%);
        }

        .hero h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--green-deep);
            margin-bottom: 1rem;
            line-height: 1.1;
        }

        .hero p {
            font-size: 1.25rem;
            color: var(--gray);
            max-width: 600px;
            margin: 0 auto 2rem;
            line-height: 1.6;
        }

        .hero-cta {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 1rem 2rem;
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--green-deep);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--green-fairway);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--green-deep);
            border: 2px solid var(--green-deep);
        }

        .btn-secondary:hover {
            background: var(--green-deep);
            color: var(--white);
        }

        .btn-danger-outline {
            background: var(--white);
            color: var(--red);
            border: 2px solid var(--red);
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .btn-danger-outline:hover {
            background: var(--red);
            color: var(--white);
        }

        /* Features Grid */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .feature-card {
            background: var(--white);
            padding: 2rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-top: 4px solid var(--gold);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .feature-card h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            color: var(--green-deep);
            margin-bottom: 0.5rem;
        }

        .feature-card p {
            color: var(--gray);
            line-height: 1.5;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 450px;
            margin: 3rem auto;
            background: var(--white);
            padding: 2.5rem;
            box-shadow: var(--shadow);
        }

        .auth-container h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--green-deep);
            text-align: center;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--green-fairway);
        }

        .form-btn {
            width: 100%;
            padding: 1rem;
            background: var(--green-deep);
            color: var(--white);
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-transform: uppercase;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        .form-btn:hover {
            background: var(--green-fairway);
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: var(--gray);
        }

        .auth-switch a {
            color: var(--green-fairway);
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* Dashboard */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--green-deep);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--gray);
        }

        .user-info strong {
            color: var(--dark);
        }

        /* Tournament Cards */
        .tournaments-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .tournament-card {
            background: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            max-width: 380px;
        }

        .tournament-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }

        .tournament-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tournament-header h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.15rem;
            margin-bottom: 0.2rem;
        }

        .tournament-header p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .tournament-body {
            padding: 0.9rem;
        }

        .tournament-stat {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.9rem;
        }

        .tournament-stat:last-child {
            border-bottom: none;
        }

        .tournament-stat span:first-child {
            color: var(--gray);
        }

        .tournament-stat span:last-child {
            font-weight: 600;
        }

        .tournament-actions {
            padding: 0.9rem;
            padding-top: 0;
            display: flex;
            gap: 0.5rem;
        }

        .tournament-actions .btn {
            flex: 1;
            padding: 0.6rem;
            font-size: 0.85rem;
        }

        /* Create Tournament Form */
        .create-tournament {
            background: var(--white);
            padding: 1.25rem;
            box-shadow: var(--shadow);
            max-width: 400px;
            margin: 0 auto;
            font-size: 0.9rem;
        }

        .create-tournament h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.4rem;
            color: var(--green-deep);
            margin-bottom: 1rem;
        }
        
        .create-tournament .form-group {
            margin-bottom: 0.875rem;
        }
        
        .create-tournament .form-group label {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
        }
        
        .create-tournament input,
        .create-tournament select {
            padding: 0.5rem 0.75rem !important;
            font-size: 0.85rem !important;
        }
        
        .create-tournament .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .invite-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .invite-section h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .invite-section h3 {
            font-family: 'Oswald', sans-serif;
            color: var(--green-deep);
            margin-bottom: 1rem;
        }

        .invite-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .invite-tag {
            background: var(--green-deep);
            color: var(--white);
            padding: 0.35rem 0.75rem;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .invite-tag button {
            background: none;
            border: none;
            color: var(--white);
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
        }

        /* Player Selection */
        .player-selection {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .selection-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1.25rem 2rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selection-header .tournament-title {
            flex: 1;
        }

        .selection-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
            margin-bottom: 0.25rem;
        }

        .selection-header p {
            opacity: 0.9;
        }

        .current-pick {
            background: var(--gold);
            color: var(--green-deep);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .current-pick strong {
            font-family: 'Oswald', sans-serif;
        }

        .search-filter {
            padding: 1.5rem 2rem;
            background: #f9fafb;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-filter input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            font-size: 1rem;
            font-family: inherit;
        }

        .search-filter input:focus {
            outline: none;
            border-color: var(--green-fairway);
        }

        .players-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .player-item {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }

        .player-item:hover:not(.disabled) {
            background: rgba(26, 92, 58, 0.05);
        }

        .player-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }

        .player-item.selected {
            background: rgba(196, 167, 71, 0.15);
            border-left: 4px solid var(--gold);
        }

        .player-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem;
            background: #e5e7eb;
        }

        .player-info {
            flex: 1;
        }

        .player-info h4 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: var(--dark);
        }

        .player-info p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .player-rank {
            text-align: right;
        }

        .player-rank strong {
            display: block;
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            color: var(--green-deep);
        }

        .player-rank span {
            color: var(--gray);
            font-size: 0.85rem;
        }

        .used-badge {
            background: var(--red);
            color: var(--white);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .current-badge {
            background: var(--gold);
            color: var(--green-deep);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .player-item.current-pick {
            border: 2px solid var(--gold);
            background: rgba(196, 167, 71, 0.1);
        }
        
        .inline-confirm-btn {
            background: var(--gold);
            color: var(--green-deep);
            border: none;
            padding: 0.5rem 1rem;
            font-family: 'Oswald', sans-serif;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 4px;
            white-space: nowrap;
            margin-left: 0.5rem;
        }
        
        .inline-confirm-btn:hover {
            background: #b8982f;
        }
        
        .btn-remove-pick {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        .btn-remove-pick:hover {
            background: #b91c1c;
        }
        
        .inline-remove-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        
        .inline-remove-btn:hover {
            background: #b91c1c;
        }

        .confirm-selection {
            padding: 1.5rem 2rem;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        /* Leaderboard */
        .leaderboard {
            background: var(--white);
            box-shadow: var(--shadow);
        }

        .leaderboard-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 1.25rem 2rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .leaderboard-header .tournament-title {
            flex: 1;
        }

        .tournament-logo {
            width: 70px;
            height: 70px;
            object-fit: contain;
            background: var(--white);
            border-radius: 8px;
            padding: 6px;
        }

        .tournament-logo-small {
            width: 32px;
            height: 32px;
            object-fit: contain;
            border-radius: 4px;
        }
        
        .tournament-logo-liv {
            width: 36px;
            height: 36px;
            object-fit: cover;
            object-position: center;
            border-radius: 50%;
        }

        .leaderboard-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
        }

        .leaderboard-meta {
            display: flex;
            gap: 2rem;
            margin-top: 0.5rem;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .my-pick-highlight {
            background: linear-gradient(90deg, var(--gold) 0%, var(--gold-light) 100%);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .my-pick-highlight img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--white);
        }

        .my-pick-info {
            flex: 1;
        }

        .my-pick-info h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.25rem;
            color: var(--green-deep);
        }

        .my-pick-info p {
            color: var(--green-deep);
            opacity: 0.8;
        }

        .my-pick-stats {
            text-align: right;
        }

        .my-pick-stats .position {
            font-family: 'Oswald', sans-serif;
            font-size: 2rem;
            color: var(--green-deep);
        }

        .my-pick-stats .earnings {
            color: var(--green-deep);
            font-weight: 600;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: #f9fafb;
            padding: 0.5rem 1rem;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            color: var(--gray);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .leaderboard-table td {
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .leaderboard-table tr:hover {
            background: rgba(26, 92, 58, 0.03);
        }

        .leaderboard-table tr.my-pick {
            background: rgba(196, 167, 71, 0.15);
        }

        .leaderboard-table tr.my-pick td {
            font-weight: 600;
        }

        .pos-cell {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
            color: var(--green-deep);
        }

        .player-cell {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .player-cell img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .pick-tag {
            margin-left: 0.5rem;
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            border-radius: 2px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .pick-tag.your-pick {
            background: var(--gold);
            color: var(--green-deep);
        }

        .pick-tag.friend-pick-0 {
            background: #3b82f6;
            color: var(--white);
        }

        .pick-tag.friend-pick-1 {
            background: #8b5cf6;
            color: var(--white);
        }

        .pick-tag.friend-pick-2 {
            background: #ec4899;
            color: var(--white);
        }

        .pick-tag.friend-pick-3 {
            background: #f97316;
            color: var(--white);
        }

        .pick-tag.friend-pick-4 {
            background: #14b8a6;
            color: var(--white);
        }

        .score-cell {
            font-family: 'Oswald', sans-serif;
            font-size: 1.1rem;
        }

        .score-cell.under {
            color: var(--red);
        }

        .score-cell.over {
            color: var(--green-deep);
        }

        .thru-cell {
            color: var(--gray);
        }

        .earnings-cell {
            font-weight: 600;
            color: var(--green-fairway);
        }

        /* Pool Standings */
        .standings-header {
            background: linear-gradient(135deg, var(--green-deep) 0%, var(--green-fairway) 100%);
            padding: 0.75rem 2rem;
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .standings-header h2 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.75rem;
        }
        
        .pool-image-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }
        
        .pool-image-container img {
            width: 55px;
            height: 55px;
            border-radius: 6px;
            object-fit: contain;
            background: white;
            padding: 4px;
            border: 1px solid #e5e7eb;
        }

        .pool-total {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
        }

        .pool-total span {
            color: var(--gold);
        }

        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }

        .standings-table th {
            background: #f9fafb;
            padding: 1rem;
            text-align: left;
            font-family: 'Oswald', sans-serif;
            font-weight: 500;
            color: var(--gray);
            text-transform: uppercase;
            font-size: 0.85rem;
        }

        .standings-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .standings-table tr.current-user {
            background: rgba(196, 167, 71, 0.15);
        }

        .rank-badge {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Oswald', sans-serif;
            font-weight: 600;
        }

        .rank-badge.gold {
            background: var(--gold);
            color: var(--green-deep);
        }

        .rank-badge.silver {
            background: #c0c0c0;
            color: var(--dark);
        }

        .rank-badge.bronze {
            background: #cd7f32;
            color: var(--white);
        }

        .weekly-pick {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .weekly-pick img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--white);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            background: var(--green-deep);
            color: var(--white);
            padding: 1.25rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.35rem;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 1.5rem;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--green-deep);
            color: var(--white);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            transform: translateX(calc(100% + 2rem));
            transition: transform 0.3s;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--red);
        }

        /* ============================================
           IMPROVED MOBILE RESPONSIVE STYLES
           ============================================ */
        
        @media (max-width: 768px) {
            /* --- HEADER IMPROVEMENTS --- */
            .header-content {
                flex-direction: row;
                padding: 0.5rem 0.75rem;
                gap: 0.5rem;
            }

            .logo-image {
                height: 50px;
            }

            .nav-profile {
                margin-right: 0.25rem;
            }

            .nav-profile img {
                width: 36px;
                height: 36px;
            }

            .nav-profile-edit {
                font-size: 0.55rem;
            }

            .nav-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.7rem;
                letter-spacing: 0.3px;
            }

            /* --- HERO/LANDING IMPROVEMENTS --- */
            .hero h2 {
                font-size: 2rem;
            }

            .hero p {
                font-size: 1rem;
            }

            .hero-cta {
                flex-direction: column;
                gap: 0.75rem;
            }

            .hero-cta .btn {
                width: 100%;
                max-width: 280px;
            }

            /* --- DASHBOARD --- */
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                padding: 1rem;
            }

            .tournaments-grid {
                grid-template-columns: 1fr;
                padding: 0.75rem;
                gap: 1rem;
            }

            .tournament-card {
                max-width: 100%;
            }

            /* --- TAB NAVIGATION IMPROVEMENTS --- */
            .tabs-container {
                position: sticky;
                top: 0;
                z-index: 50;
            }

            .tabs {
                overflow-x: visible;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding: 0 0.4rem;
                display: flex;
                justify-content: flex-start;
                align-items: center;
                gap: 0.15rem;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                padding: 0.65rem 0.12rem;
                font-size: 0.58rem;
                white-space: nowrap;
                text-align: center;
            }

            .tab.active::after {
                height: 2px;
            }

            /* Hide "Pool ", "Live ", "Pick " prefixes on mobile */
            .tab-full {
                display: none;
            }

            /* Pool options menu - compact */
            .pool-options-menu {
                flex: 0 0 auto;
                padding: 0;
                margin-left: auto;
            }

            .pool-options-btn {
                padding: 0.3rem 0.2rem;
                font-size: 1rem;
            }

            /* Hide scroll indicator since tabs fit now */
            .scroll-indicator {
                display: none !important;
            }

            /* --- POOL STANDINGS - CARD LAYOUT --- */
            .standings-header {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
                gap: 0.75rem;
            }

            .standings-header h2 {
                font-size: 1.4rem;
            }
            
            .pool-image-container img {
                width: 65px;
                height: 65px;
            }

            /* Convert standings table to cards on mobile */
            .standings-table {
                display: block;
                width: 100%;
            }

            .standings-table thead {
                display: none;
            }

            .standings-table tbody {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
                padding: 0.75rem;
            }

            .standings-table tr {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                background: var(--white);
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 0.875rem;
                position: relative;
                box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            }

            .standings-table tr.current-user {
                background: linear-gradient(135deg, rgba(196, 167, 71, 0.15), rgba(196, 167, 71, 0.05));
                border: 2px solid var(--gold);
            }

            .standings-table td {
                border: none;
                padding: 0;
            }

            /* Rank badge - left side */
            .standings-table td:nth-child(1) {
                order: 1;
                margin-right: 0.75rem;
            }

            .standings-table .rank-badge {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                border-radius: 8px;
            }

            /* Player name & avatar - grows to fill */
            .standings-table td:nth-child(2) {
                order: 2;
                flex: 1;
                min-width: 0;
            }

            .standings-table td:nth-child(2) .player-cell {
                gap: 0.5rem;
            }

            .standings-table td:nth-child(2) img {
                width: 36px;
                height: 36px;
            }

            .standings-table td:nth-child(2) span {
                font-size: 1rem;
                font-weight: 600;
            }

            /* Total earnings - right aligned */
            .standings-table td:nth-child(4) {
                order: 3;
                margin-left: auto;
                font-size: 1.1rem;
                font-weight: 700;
                color: var(--green-fairway);
            }

            /* This week pick - full width below */
            .standings-table td:nth-child(3) {
                order: 4;
                width: 100%;
                margin-top: 0.75rem;
                padding-top: 0.75rem;
                border-top: 1px solid #e5e7eb;
            }

            .standings-table .weekly-pick {
                flex-direction: row;
                align-items: center;
                gap: 0.5rem;
                font-size: 0.85rem;
            }

            .standings-table .weekly-pick img {
                width: 32px;
                height: 32px;
            }

            .standings-table .weekly-pick span {
                max-width: none;
                white-space: normal;
            }

            /* Hide "Total" column on mobile - show inline */
            .standings-table td:last-child {
                display: none;
            }

            /* --- MY PICK HIGHLIGHT (Your Pick Section) --- */
            .my-pick-highlight {
                flex-direction: column;
                text-align: center;
                padding: 1.25rem;
                gap: 0.75rem;
                background: linear-gradient(135deg, var(--gold) 0%, var(--gold-light) 100%);
            }

            .my-pick-highlight img {
                width: 80px;
                height: 80px;
                border-width: 4px;
                margin: 0 auto;
            }

            .my-pick-info {
                text-align: center;
            }

            .my-pick-info h3 {
                font-size: 1.4rem;
            }

            .my-pick-info p {
                font-size: 0.9rem;
            }

            .my-pick-stats {
                display: flex;
                justify-content: center;
                gap: 2rem;
                text-align: center;
                margin-top: 0.5rem;
            }

            .my-pick-stats .position {
                font-size: 2.5rem;
                line-height: 1;
            }

            .my-pick-stats .earnings {
                font-size: 1.1rem;
            }

            /* --- LEADERBOARD IMPROVEMENTS --- */
            .leaderboard-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }

            .tournament-logo {
                width: 60px;
                height: 60px;
            }

            .leaderboard-header h2 {
                font-size: 1.3rem;
            }

            .leaderboard-meta {
                flex-direction: column;
                gap: 0.25rem;
                font-size: 0.85rem;
            }

            /* Leaderboard table improvements */
            .leaderboard-table {
                display: table;
                width: 100%;
                table-layout: fixed;
                font-size: 0.85rem;
            }

            .leaderboard-table th {
                padding: 0.5rem 0.1rem;
                font-size: 0.58rem;
                text-align: center;
                letter-spacing: -0.3px;
            }

            .leaderboard-table th:nth-child(2) {
                text-align: left;
            }

            .leaderboard-table td {
                padding: 0.6rem 0.15rem;
                vertical-align: middle;
            }

            /* Fixed column widths for leaderboard - balanced for readability */
            .leaderboard-table th:nth-child(1),
            .leaderboard-table td:nth-child(1) { width: 28px; text-align: center; } /* Pos */
            .leaderboard-table th:nth-child(2),
            .leaderboard-table td:nth-child(2) { width: auto; } /* Player - flexible */
            .leaderboard-table th:nth-child(3),
            .leaderboard-table td:nth-child(3) { width: 38px; text-align: center; } /* Score */
            .leaderboard-table th:nth-child(4),
            .leaderboard-table td:nth-child(4) { width: 36px; text-align: center; } /* Today */
            .leaderboard-table th:nth-child(5),
            .leaderboard-table td:nth-child(5) { 
                display: table-cell !important;
                width: 30px; 
                text-align: center; 
            } /* Thru */
            .leaderboard-table th:nth-child(6),
            .leaderboard-table td:nth-child(6) { width: 68px; text-align: right; padding-right: 0.3rem; } /* Projected $ */

            .leaderboard-table .pos-cell {
                font-size: 0.85rem;
                text-align: center;
            }

            .leaderboard-table .player-cell {
                gap: 0.35rem;
                flex-wrap: wrap;
            }

            .leaderboard-table .player-cell img {
                width: 26px;
                height: 26px;
                flex-shrink: 0;
            }

            .leaderboard-table .player-cell span {
                font-size: 0.8rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .leaderboard-table .score-cell {
                font-size: 0.9rem;
                font-weight: 600;
                text-align: center;
            }

            .leaderboard-table .thru-cell {
                font-size: 0.75rem;
            }

            .leaderboard-table .earnings-cell {
                font-size: 0.75rem;
                text-align: right;
            }

            /* Pick tags - show as username badges below player name */
            .pick-tag {
                font-size: 0.6rem;
                padding: 0.15rem 0.35rem;
                margin-left: 0;
                margin-top: 2px;
                display: inline-block;
                border-radius: 3px;
                max-width: 100%;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Stack pick tags below player name on mobile */
            .leaderboard-table .player-cell {
                flex-direction: row;
                flex-wrap: wrap;
                align-items: center;
            }

            /* --- PICK HISTORY TABLE IMPROVEMENTS --- */
            #tab-history .leaderboard-table {
                table-layout: fixed;
            }

            /* Pick History columns */
            #tab-history .leaderboard-table th:nth-child(1),
            #tab-history .leaderboard-table td:nth-child(1) { width: 28px; } /* Week */
            #tab-history .leaderboard-table th:nth-child(2),
            #tab-history .leaderboard-table td:nth-child(2) { width: auto; } /* Tournament */
            #tab-history .leaderboard-table th:nth-child(3),
            #tab-history .leaderboard-table td:nth-child(3) { width: auto; } /* Your Pick */
            #tab-history .leaderboard-table th:nth-child(4),
            #tab-history .leaderboard-table td:nth-child(4) { width: 58px; } /* Finish */
            #tab-history .leaderboard-table th:nth-child(5),
            #tab-history .leaderboard-table td:nth-child(5) { 
                display: table-cell !important;
                width: 58px; 
            } /* Earnings */

            /* Tournament logo in history - always inline left of text */
            #tab-history .tournament-logo-small {
                width: 20px;
                height: 20px;
                display: inline-block !important;
                flex-shrink: 0;
                vertical-align: middle;
            }
            
            #tab-history .tournament-logo-liv {
                width: 24px;
                height: 24px;
                display: inline-block !important;
                flex-shrink: 0;
                vertical-align: middle;
                border-radius: 50%;
            }

            #tab-history .player-cell {
                gap: 0.3rem;
                flex-wrap: nowrap !important;
                align-items: center;
            }

            #tab-history .player-cell span {
                font-size: 0.75rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* --- UPCOMING TOURNAMENTS TABLE --- */
            #schedule-body .tournament-logo-small {
                width: 18px;
                height: 18px;
                display: inline-block !important;
                vertical-align: middle;
            }
            
            #schedule-body .tournament-logo-liv {
                width: 20px;
                height: 20px;
                display: inline-block !important;
                vertical-align: middle;
                border-radius: 50%;
            }

            /* Upcoming Schedule columns - KEEP Course, fit everything */
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table {
                table-layout: fixed;
            }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(1),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(1) { width: 28px; text-align: center; } /* Week */
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(2),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(2) { 
                width: auto; 
            } /* Tournament - flexible, can wrap */
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(2) .player-cell {
                flex-wrap: nowrap !important;
            }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(2) span,
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(2) strong {
                white-space: normal !important;
                word-wrap: break-word;
                font-size: 0.75rem;
            }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(3),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(3) { width: 50px; text-align: center; font-size: 0.7rem; } /* Dates */
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(4),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(4) { 
                display: table-cell !important; /* SHOW Course */
                width: 60px;
                font-size: 0.65rem;
            }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(4) {
                white-space: normal;
                word-wrap: break-word;
                line-height: 1.2;
            }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(5),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(5) { 
                display: table-cell !important; 
                width: 62px;
                text-align: right;
                padding-right: 0.3rem;
                font-size: 0.7rem;
            } /* Purse */

            /* --- PLAYER SELECTION --- */
            .selection-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }

            .selection-header h2 {
                font-size: 1.3rem;
            }

            .search-filter {
                padding: 0.75rem;
                gap: 0.5rem;
            }

            .search-filter input {
                padding: 0.875rem;
                font-size: 1rem;
            }

            .player-item {
                padding: 0.875rem;
            }

            .player-photo {
                width: 44px;
                height: 44px;
            }

            .player-info h4 {
                font-size: 1rem;
            }

            .player-info p {
                font-size: 0.8rem;
            }

            .confirm-selection {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
            }

            .confirm-selection .btn {
                width: 100%;
            }

            /* --- GENERAL SPACING --- */
            .container {
                padding: 0;
            }

            .screen {
                padding: 0;
            }

            /* --- FORMS --- */
            .auth-container {
                margin: 1rem;
                padding: 1.5rem;
            }

            .form-group input {
                padding: 1rem;
                font-size: 1rem;
            }

            .form-btn {
                padding: 1rem;
                font-size: 1rem;
            }

            /* --- TOURNAMENT CARDS --- */
            .tournament-header {
                padding: 1rem;
            }

            .tournament-header h3 {
                font-size: 1.1rem;
            }

            .tournament-body {
                padding: 0.875rem;
            }

            .tournament-actions {
                padding: 0.875rem;
                padding-top: 0;
            }

            .tournament-actions .btn {
                padding: 0.75rem;
                font-size: 0.85rem;
            }

            /* --- MODALS --- */
            .modal {
                width: 95%;
                max-height: 85vh;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            /* --- TOAST --- */
            .toast {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
            }
        }

        /* --- EXTRA SMALL SCREENS (< 400px) --- */
        @media (max-width: 400px) {
            .header-content {
                padding: 0.4rem 0.5rem;
            }

            .logo-image {
                height: 42px;
            }

            .nav-profile img {
                width: 30px;
                height: 30px;
            }

            .nav-btn {
                padding: 0.35rem 0.5rem;
                font-size: 0.65rem;
            }

            .tab {
                padding: 0.6rem 0.08rem;
                font-size: 0.55rem;
            }

            .tabs {
                gap: 0.1rem;
                padding: 0 0.25rem;
            }

            .standings-table tr {
                padding: 0.75rem;
            }

            .standings-table .rank-badge {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }

            .standings-table td:nth-child(2) img {
                width: 32px;
                height: 32px;
            }

            .standings-table td:nth-child(2) span {
                font-size: 0.9rem;
            }

            .my-pick-highlight img {
                width: 70px;
                height: 70px;
            }

            .my-pick-info h3 {
                font-size: 1.2rem;
            }

            .my-pick-stats .position {
                font-size: 2rem;
            }

            .leaderboard-table {
                font-size: 0.7rem;
            }

            .leaderboard-table th {
                font-size: 0.52rem;
                letter-spacing: -0.5px;
            }

            .leaderboard-table .player-cell img {
                width: 22px;
                height: 22px;
            }

            .leaderboard-table .player-cell span {
                font-size: 0.7rem;
            }

            /* Tighter columns on extra small screens */
            .leaderboard-table th:nth-child(1),
            .leaderboard-table td:nth-child(1) { width: 24px; }
            .leaderboard-table th:nth-child(3),
            .leaderboard-table td:nth-child(3) { width: 34px; }
            .leaderboard-table th:nth-child(4),
            .leaderboard-table td:nth-child(4) { width: 32px; }
            .leaderboard-table th:nth-child(5),
            .leaderboard-table td:nth-child(5) { width: 26px; }
            .leaderboard-table th:nth-child(6),
            .leaderboard-table td:nth-child(6) { width: 60px; }

            .leaderboard-table .earnings-cell {
                font-size: 0.65rem;
            }

            .leaderboard-table .score-cell {
                font-size: 0.8rem;
            }

            .leaderboard-table .thru-cell {
                font-size: 0.65rem;
            }

            .pick-tag {
                font-size: 0.55rem;
                padding: 0.1rem 0.25rem;
            }

            .hero h2 {
                font-size: 1.75rem;
            }

            .auth-container {
                margin: 0.5rem;
                padding: 1.25rem;
            }

            /* History table adjustments */
            #tab-history .leaderboard-table th:nth-child(1),
            #tab-history .leaderboard-table td:nth-child(1) { width: 22px; }
            #tab-history .leaderboard-table th:nth-child(4),
            #tab-history .leaderboard-table td:nth-child(4) { width: 50px; }
            #tab-history .leaderboard-table th:nth-child(5),
            #tab-history .leaderboard-table td:nth-child(5) { width: 50px; }

            #tab-history .player-cell span {
                font-size: 0.65rem;
            }

            #tab-history .tournament-logo-small {
                width: 16px;
                height: 16px;
            }

            /* Upcoming tournaments - tighter on small screens */
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(1),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(1) { width: 22px; }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(3),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(3) { width: 44px; font-size: 0.6rem; }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(4),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(4) { width: 52px; font-size: 0.6rem; }
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table th:nth-child(5),
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(5) { width: 55px; font-size: 0.6rem; }

            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(2) span,
            #tab-history .leaderboard:nth-of-type(2) .leaderboard-table td:nth-child(2) strong {
                font-size: 0.65rem;
            }
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--gray);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: var(--green-fairway);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Additional mobile-friendly enhancements */
        @media (max-width: 768px) {
            /* Make "Your Pick" section more prominent on Live Leaderboard */
            .my-pick-highlight {
                border-radius: 0;
                margin: 0;
            }

            .my-pick-highlight::before {
                content: 'YOUR PICK';
                display: block;
                font-family: 'Oswald', sans-serif;
                font-size: 0.7rem;
                letter-spacing: 1.5px;
                color: var(--green-deep);
                opacity: 0.7;
                margin-bottom: 0.5rem;
            }

            /* Projected earnings badge */
            .my-pick-stats .earnings {
                background: var(--green-deep);
                color: var(--white);
                padding: 0.3rem 0.75rem;
                border-radius: 4px;
                display: inline-block;
            }

            /* Better visual hierarchy for standings cards */
            .standings-table tbody {
                background: #f9fafb;
            }

            /* Add "This Week" label to pick section in card */
            .standings-table td:nth-child(3)::before {
                content: 'This Week: ';
                font-size: 0.75rem;
                color: var(--gray);
                font-weight: 500;
            }

            /* Pool header improvements */
            .standings-header .pool-image-container {
                margin-bottom: 0.25rem;
            }

            .standings-header .pool-total {
                font-size: 1.3rem;
            }

            /* Projected earnings styling in standings */
            .standings-table .weekly-pick .earnings-projected {
                color: var(--gold);
                font-weight: 600;
                font-size: 0.8rem;
            }

            /* Bottom safe area padding for iOS */
            .screen.active {
                padding-bottom: env(safe-area-inset-bottom, 0);
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Larger touch targets */
            .nav-btn {
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .tab {
                min-height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .player-item {
                min-height: 60px;
            }

            .tournament-actions .btn {
                min-height: 44px;
            }

            /* Remove hover states that don't work on touch */
            .player-item:hover:not(.disabled) {
                background: transparent;
            }

            .player-item:active:not(.disabled) {
                background: rgba(26, 92, 58, 0.08);
            }

            .standings-table tr:active {
                background: rgba(26, 92, 58, 0.05);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray);
        }

        .empty-state h3 {
            font-family: 'Oswald', sans-serif;
            font-size: 1.5rem;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .empty-state .btn {
            margin-top: 1.5rem;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            background: var(--white);
            position: relative;
            flex: 1;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tabs-container {
            position: relative;
            width: 100%;
            background: var(--white);
            border-bottom: 2px solid #e5e7eb;
            overflow: visible;
        }
        
        .scroll-indicator {
            display: none;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(to right, transparent, var(--white) 30%);
            padding: 0.5rem 0.5rem 0.5rem 1.5rem;
            pointer-events: none;
            z-index: 10;
        }
        
        .scroll-indicator span {
            display: inline-block;
            color: var(--gold);
            font-size: 1.2rem;
            font-weight: bold;
            animation: pulse-arrow 1.5s ease-in-out infinite;
        }
        
        @keyframes pulse-arrow {
            0%, 100% { opacity: 0.4; transform: translateX(0); }
            50% { opacity: 1; transform: translateX(3px); }
        }
        
        @media (max-width: 600px) {
            .scroll-indicator {
                display: block;
            }
            
            .scroll-indicator.hidden {
                display: none;
            }
        }

        .pool-options-menu {
            position: relative;
            display: flex;
            align-items: center;
            margin-left: auto;
            padding: 0 0.5rem;
            flex-shrink: 0;
        }

        .pool-options-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            font-size: 1.5rem;
            color: var(--gray);
            border-radius: 4px;
            transition: background 0.2s, color 0.2s;
            line-height: 1;
        }

        .pool-options-btn:hover {
            background: #f3f4f6;
            color: var(--green-deep);
        }

        .pool-options-dropdown {
            display: none;
            position: fixed;
            background: var(--white);
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 150px;
            z-index: 1000;
            overflow: hidden;
        }

        .pool-options-dropdown.active {
            display: block;
        }

        .pool-options-dropdown button {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .pool-options-dropdown button:hover {
            background: #f9fafb;
        }

        .tab {
            padding: 1rem 2rem;
            font-family: 'Oswald', sans-serif;
            font-size: 1rem;
            color: var(--gray);
            background: none;
            border: none;
            cursor: pointer;
            position: relative;
            transition: color 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--green-fairway);
        }

        .tab.active {
            color: var(--green-deep);
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--green-deep);
        }

        /* Profile Picture Modal */
        .profile-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .profile-modal.active {
            display: flex;
        }
        .profile-modal-content {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .profile-modal-name {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
        }
        .clickable-profile {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .clickable-profile:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <div class="logo">
                <img src="logo.png" alt="One & Done Golf" class="logo-image">
            </div>
            <nav id="nav-guest">
                <button class="nav-btn" onclick="showScreen('login')">Log In</button>
                <button class="nav-btn primary" onclick="showScreen('signup')">Sign Up</button>
            </nav>
            <nav id="nav-user" style="display: none;">
                <div class="nav-profile" onclick="openProfileEditor()">
                    <img id="nav-profile-pic" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='24'></text></svg>" alt="Profile">
                    <span class="nav-profile-edit">Edit</span>
                </div>
                <button class="nav-btn" onclick="showScreen('dashboard')">My Pools</button>
                <button class="nav-btn" onclick="logout()">Log Out</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Landing Page -->
        <section id="landing" class="screen active">
            <div class="hero">
                <h2>One Pick Per Week.<br>One Season.<br>Unlimited Glory.</h2>
                <p>The ultimate PGA Tour fantasy pool. Select one player per tournamentuse each golfer only once all season. Accumulate earnings and dominate your friends.</p>
                <div class="hero-cta">
                    <button class="btn btn-primary" onclick="showScreen('signup')">Start a Pool</button>
                    <button class="btn btn-secondary" onclick="showScreen('login')">Join a Pool</button>
                </div>
            </div>

            <div class="features">
                <div class="feature-card">
                    <div class="feature-icon"></div>
                    <h3>Simple Rules</h3>
                    <p>Pick one PGA Tour player each week. Their tournament earnings become your score. Use each player only once per season.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"></div>
                    <h3>Live Tracking</h3>
                    <p>Watch your player climb the leaderboard in real-time. See projected earnings update as the tournament unfolds.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"></div>
                    <h3>Challenge Friends</h3>
                    <p>Create private pools, invite friends, and compete head-to-head throughout the entire PGA Tour season.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon"></div>
                    <h3>Accumulate Earnings</h3>
                    <p>Your total earnings accumulate week after week. The highest total at season's end wins the pool.</p>
                </div>
            </div>
        </section>

        <!-- Login -->
        <section id="login" class="screen">
            <div class="auth-container">
                <h2>Welcome Back</h2>
                <form id="login-form" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" required placeholder="Enter your password">
                    </div>
                    <button type="submit" class="form-btn">Log In</button>
                </form>
                <p class="auth-switch">
                    Don't have an account? <a onclick="showScreen('signup')">Sign up</a>
                </p>
                <p id="forgot-password-link" class="auth-switch" style="display: none; margin-top: 0.5rem;">
                    <a onclick="handleForgotPassword()" style="color: var(--gold);">Forgot your password?</a>
                </p>
            </div>
        </section>

        <!-- Signup -->
        <section id="signup" class="screen">
            <div class="auth-container">
                <h2>Create Account</h2>
                <form id="signup-form" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="signup-name" required placeholder="How friends will see you">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signup-email" required placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signup-password" required placeholder="At least 8 characters" minlength="8">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signup-confirm" required placeholder="Confirm your password">
                    </div>
                    <button type="submit" class="form-btn">Create Account</button>
                </form>
                <p class="auth-switch">
                    Already have an account? <a onclick="showScreen('login')">Log in</a>
                </p>
            </div>
        </section>

        <!-- Dashboard -->
        <section id="dashboard" class="screen">
            <div class="dashboard-header">
                <h2>My Pools</h2>
                <div class="user-info">
                    <span>Logged in as <strong id="user-display-name">User</strong></span>
                </div>
            </div>

            <div style="display: flex; gap: 0.75rem; margin-bottom: 2rem; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="showScreen('create-tournament')" style="padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                    + Create New Pool
                </button>
                <button class="btn btn-secondary" onclick="showJoinPoolModal()" style="border: 2px solid var(--green-deep); color: var(--green-deep); padding: 0.6rem 1.2rem; font-size: 0.9rem;">
                     Join a Pool
                </button>
            </div>

            <div id="tournaments-container" class="tournaments-grid">
                <!-- Tournaments will be rendered here -->
            </div>
        </section>

        <!-- Create Tournament -->
        <section id="create-tournament" class="screen">
            <div class="create-tournament">
                <h2>Create a New Pool</h2>
                <form id="create-form" onsubmit="handleCreateTournament(event)">
                    <div class="form-group">
                        <label>Pool Name</label>
                        <input type="text" id="pool-name" required placeholder="e.g., Office Golf League 2026">
                    </div>
                    <div class="form-group">
                        <label>Tour & Season</label>
                        <select id="pool-season" style="width: 100%; padding: 0.875rem 1rem; border: 2px solid #e5e7eb; font-size: 1rem;">
                            <option value="pga|2026">PGA Tour - 2026</option>
                            <option value="champions|2026">PGA Tour Champions - 2026</option>
                            <option value="liv|2026">LIV Golf - 2026</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Pool Rules</label>
                        <div style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; padding: 1rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; font-weight: normal;">
                                <input type="checkbox" id="unique-picks" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                                <div>
                                    <span style="font-weight: 600;">Unique Picks Each Week</span>
                                    <p style="color: var(--gray); font-size: 0.85rem; margin-top: 0.25rem;">
                                        No two players can pick the same golfer in a given week. First come, first served!
                                    </p>
                                    <p style="color: var(--gold); font-size: 0.8rem; margin-top: 0.25rem; font-style: italic;">
                                         Only recommended for small pools (10 or fewer members)
                                    </p>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Pool Image (optional)</label>
                        <p style="color: var(--gray); font-size: 0.85rem; margin-bottom: 0.5rem;">This will be shown on your pool card</p>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <img id="create-pool-image-preview" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23C4A747'/><text x='50' y='62' text-anchor='middle' font-size='45'></text></svg>" 
                                 style="width: 60px; height: 60px; border-radius: 6px; object-fit: contain; background: white; padding: 4px; border: 1px solid #e5e7eb;">
                            <div style="flex: 1;">
                                <input type="file" id="create-pool-image-input" accept="image/*" onchange="previewCreatePoolImage(event)" style="display: none;">
                                <button type="button" class="btn btn-secondary" onclick="document.getElementById('create-pool-image-input').click()" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                    Upload Photo
                                </button>
                                <button type="button" id="remove-create-pool-image-btn" class="btn" onclick="removeCreatePoolImage()" style="padding: 0.5rem 1rem; font-size: 0.9rem; display: none; margin-left: 0.5rem; color: var(--gray);">
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="invite-section">
                        <h3>Invite Friends</h3>
                        <p style="color: var(--gray); font-size: 0.95rem; margin-bottom: 1rem;">Enter email addresses to send invitations</p>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="email" id="invite-email" placeholder="friend@email.com" style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb;">
                            <button type="button" class="btn btn-secondary" onclick="addInvite()" style="padding: 0.75rem 1.5rem;">Add</button>
                        </div>
                        <div id="invite-list" class="invite-list"></div>
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="showScreen('dashboard')" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="flex: 1;">Create Pool</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Pool View -->
        <section id="pool-view" class="screen">
            <div class="tabs-container" id="tabs-container">
                <div class="tabs" id="pool-tabs">
                    <button class="tab active" onclick="switchPoolTab('standings')"><span class="tab-full">Pool </span>Standings</button>
                    <button class="tab" onclick="switchPoolTab('leaderboard')"><span class="tab-full">Live </span>Leaderboard</button>
                    <button class="tab" onclick="switchPoolTab('pick')">Make Pick</button>
                    <button class="tab" onclick="switchPoolTab('history')"><span class="tab-full">Pick </span>History</button>
                    <div class="pool-options-menu">
                        <button class="pool-options-btn" onclick="togglePoolOptions(event)">
                            <span></span>
                        </button>
                    </div>
                </div>
                <div class="scroll-indicator" id="scroll-indicator">
                    <span></span>
                </div>
            </div>
            <div class="pool-options-dropdown" id="pool-options-dropdown">
                <button id="edit-pool-image-dropdown-btn" onclick="openPoolImageModal(); closePoolOptionsDropdown();" style="display: none;">
                    <span> Edit Pool Image</span>
                </button>
                <button onclick="confirmLeaveCurrentPool()">
                    <span style="color: var(--red);"> Leave Pool</span>
                </button>
                <button id="delete-pool-btn" onclick="confirmDeletePool()" style="display: none;">
                    <span style="color: var(--red);"> Delete Pool</span>
                </button>
            </div>

            <!-- Standings Tab -->
            <div id="tab-standings" class="pool-tab">
                <div class="leaderboard">
                    <div class="standings-header">
                        <div>
                            <h2 id="pool-title">Pool Name</h2>
                            <p id="pool-season-display">2025-2026 Season</p>
                        </div>
                        <div class="pool-image-container" id="pool-image-container" onclick="handlePoolImageClick()">
                            <img id="pool-image-display" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23C4A747'/><text x='50' y='62' text-anchor='middle' font-size='45'></text></svg>" alt="Pool Image">
                        </div>
                    </div>

                    <table class="standings-table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Player</th>
                                <th>This Week</th>
                                <th>Total Earnings</th>
                                <th class="hide-mobile">Picks Used</th>
                            </tr>
                        </thead>
                        <tbody id="standings-body">
                            <!-- Standings will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Live Leaderboard Tab -->
            <div id="tab-leaderboard" class="pool-tab" style="display: none;">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <div class="tournament-title">
                            <h2 id="current-tournament-name">The American Express</h2>
                            <div class="leaderboard-meta">
                                <span id="tournament-dates">Jan 22 - 25, 2026</span>
                                <span id="tournament-course">Pete Dye Stadium Course</span>
                                <span id="tournament-round">Round 1</span>
                            </div>
                        </div>
                        <img id="tournament-logo" class="tournament-logo" src="" alt="Tournament Logo">
                    </div>

                    <div id="my-pick-section" class="my-pick-highlight" style="display: none;">
                        <img id="my-pick-photo" src="" alt="">
                        <div class="my-pick-info">
                            <p>YOUR PICK</p>
                            <h3 id="my-pick-name">Player Name</h3>
                        </div>
                        <div class="my-pick-stats">
                            <div class="position" id="my-pick-position">T5</div>
                            <div class="earnings" id="my-pick-earnings">Projected: $450,000</div>
                        </div>
                    </div>

                    <div id="results-banner" style="display: none; background: linear-gradient(135deg, #1a3d2e 0%, #2d5a3f 100%); color: white; padding: 0.75rem 1rem; font-weight: 500; border-radius: 8px; margin-bottom: 1rem; font-size: 0.95rem;">
                         <span id="results-banner-text">Final Results</span>  <span style="font-weight: 400; opacity: 0.9;">Official Earnings</span>
                    </div>

                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Pos</th>
                                <th>Player</th>
                                <th>Score</th>
                                <th>Today</th>
                                <th>Thru</th>
                                <th>Projected $</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            <!-- Leaderboard will be rendered here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Make Pick Tab -->
            <div id="tab-pick" class="pool-tab" style="display: none;">
                <div class="player-selection">
                    <div class="selection-header">
                        <div class="tournament-title">
                            <h2>Select Your Golfer</h2>
                            <p id="pick-tournament-info">The American Express  Jan 22-25, 2026</p>
                        </div>
                        <img id="pick-tournament-logo" class="tournament-logo" src="" alt="Tournament Logo">
                    </div>

                    <div id="current-pick-display" class="current-pick" style="display: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <div>
                                <strong>Current Selection:</strong>
                                <span id="selected-player-name">None</span>
                            </div>
                        </div>
                    </div>

                    <div class="search-filter">
                        <input type="text" id="player-search" placeholder="Search players..." oninput="filterPlayers()">
                    </div>

                    <div class="players-list" id="players-list">
                        <!-- Players will be rendered here -->
                    </div>

                    <!-- Bottom confirm section hidden - now using inline buttons -->
                    <div class="confirm-selection" style="display: none;">
                        <div id="pick-warning" style="color: var(--gray);">
                            Select a player to lock in your pick for this week
                        </div>
                        <button id="confirm-pick-btn" class="btn btn-primary" disabled onclick="confirmPick()">
                            Confirm Selection
                        </button>
                    </div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="tab-history" class="pool-tab" style="display: none;">
                <div class="leaderboard">
                    <div class="leaderboard-header">
                        <h2>Your Pick History</h2>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Tournament</th>
                                <th>Your Pick</th>
                                <th>Finish</th>
                                <th>Earnings</th>
                            </tr>
                        </thead>
                        <tbody id="history-body">
                            <!-- History will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Upcoming Schedule -->
                <div class="leaderboard" style="margin-top: 1.5rem;">
                    <div class="leaderboard-header">
                        <h2>Upcoming Tournaments</h2>
                    </div>
                    <table class="leaderboard-table">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Tournament</th>
                                <th>Dates</th>
                                <th>Course</th>
                                <th>Purse</th>
                            </tr>
                        </thead>
                        <tbody id="schedule-body">
                            <!-- Schedule will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Friends Pick History -->
                <div class="leaderboard" style="margin-top: 1.5rem;">
                    <div class="leaderboard-header">
                        <h2>Pool Members' Pick History</h2>
                    </div>
                    <div id="friends-history">
                        <!-- Friends history will be rendered here -->
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Profile Picture Modal -->
    <div id="profile-modal" class="profile-modal" onclick="closeProfileModal()">
        <img id="profile-modal-image" class="profile-modal-content" src="" alt="Profile Picture">
        <div id="profile-modal-name" class="profile-modal-name"></div>
    </div>

    <!-- Invite Modal -->
    <div id="invite-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Invite Friends</h3>
                <button class="modal-close" onclick="closeModal('invite-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Email invite section -->
                <div style="margin-bottom: 1.5rem;">
                    <p style="margin-bottom: 0.5rem; font-weight: 600;">Send Email Invite</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="email" id="modal-invite-email" placeholder="friend@email.com" style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <button class="btn btn-primary" onclick="sendEmailInvite()" style="padding: 0.75rem 1.5rem;">Send</button>
                    </div>
                    <p style="color: var(--gray); font-size: 0.85rem; margin-top: 0.5rem;">They'll receive an email with a link to join</p>
                    <div id="sent-invites-list"></div>
                </div>

                <!-- Invite link to share -->
                <div style="padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                    <p style="margin-bottom: 0.5rem; font-weight: 600;">Or share the invite link:</p>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="invite-link-input" readonly style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.85rem; background: #f9fafb;">
                        <button class="btn btn-secondary" onclick="copyInviteLink()" style="padding: 0.75rem 1.5rem;">Copy</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Join Pool Modal -->
    <div id="join-pool-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Join a Pool</h3>
                <button class="modal-close" onclick="closeModal('join-pool-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--gray);">Enter the invite code shared by your pool commissioner.</p>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="join-pool-code" placeholder="Enter invite code" style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; text-transform: uppercase;" maxlength="8">
                    <button class="btn btn-primary" onclick="handleJoinPoolByCode()" style="padding: 0.75rem 1.5rem;">Join</button>
                </div>
                <p id="join-pool-error" style="color: var(--red); font-size: 0.85rem; margin-top: 0.5rem; display: none;"></p>
            </div>
        </div>
    </div>

    <!-- Profile Editor Modal -->
    <div id="profile-editor-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Edit Profile Picture</h3>
                <button class="modal-close" onclick="closeModal('profile-editor-modal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <img id="profile-editor-preview" src="" alt="Profile" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid var(--gold); margin-bottom: 1rem;">
                
                <div style="margin-bottom: 1rem;">
                    <input type="file" id="profile-editor-input" accept="image/*" onchange="previewNewProfilePicture(event)" style="display: none;">
                    <button class="btn btn-primary" onclick="document.getElementById('profile-editor-input').click()" style="margin-right: 0.5rem;">
                         Choose Photo
                    </button>
                    <button class="btn btn-secondary" onclick="removeUserProfilePicture()" id="remove-profile-btn" style="display: none;">
                        Remove
                    </button>
                </div>
                
                <p id="profile-change-limit" style="color: var(--gray); font-size: 0.85rem; margin-bottom: 1rem;"></p>
                
                <button class="btn btn-primary" onclick="saveNewProfilePicture()" id="save-profile-btn" style="width: 100%; display: none;">
                    Save Profile Picture
                </button>
            </div>
        </div>
    </div>

    <!-- Leave Pool Confirmation Modal -->
    <div id="leave-pool-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Leave Pool</h3>
                <button class="modal-close" onclick="closeModal('leave-pool-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Are you sure you want to leave</p>
                    <p style="font-size: 1.3rem; font-weight: bold; color: var(--green-deep);" id="leave-pool-name"></p>
                </div>
                
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: var(--red); font-weight: 600; margin-bottom: 0.5rem;"> This action cannot be undone!</p>
                    <ul style="color: #7f1d1d; font-size: 0.9rem; margin-left: 1rem;">
                        <li>All your picks will be deleted</li>
                        <li>Your earnings history will be lost</li>
                        <li>You'll need a new invite to rejoin</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('leave-pool-modal')" style="flex: 1;">Cancel</button>
                    <button class="btn btn-danger-outline" onclick="leavePool()" style="flex: 1; background: var(--red); color: white; border-color: var(--red);">Leave Pool</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Pool Confirmation Modal -->
    <div id="delete-pool-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Delete Pool</h3>
                <button class="modal-close" onclick="closeModal('delete-pool-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;"></div>
                    <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">Are you sure you want to delete</p>
                    <p style="font-size: 1.3rem; font-weight: bold; color: var(--green-deep);" id="delete-pool-name"></p>
                </div>
                
                <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="color: var(--red); font-weight: 600; margin-bottom: 0.5rem;"> This will permanently delete the pool!</p>
                    <ul style="color: #7f1d1d; font-size: 0.9rem; margin-left: 1rem;">
                        <li>All members will be removed</li>
                        <li>All picks and history will be deleted</li>
                        <li>This cannot be undone</li>
                    </ul>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('delete-pool-modal')" style="flex: 1;">Cancel</button>
                    <button class="btn btn-danger-outline" onclick="deletePool()" style="flex: 1; background: var(--red); color: white; border-color: var(--red);">Delete Pool</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pool Image Modal -->
    <div id="pool-image-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>Pool Image</h3>
                <button class="modal-close" onclick="closeModal('pool-image-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <img id="pool-image-preview" src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23C4A747'/><text x='50' y='62' text-anchor='middle' font-size='45'></text></svg>" 
                         style="width: 120px; height: 120px; border-radius: 8px; object-fit: contain; background: white; padding: 8px; border: 1px solid #e5e7eb; margin-bottom: 1rem;">
                    <p style="color: var(--gray); font-size: 0.9rem;">This image will appear on your pool card and standings</p>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem;">
                    <label class="btn btn-primary" style="cursor: pointer;">
                         Upload Photo
                        <input type="file" accept="image/*" onchange="previewPoolImage(event)" style="display: none;">
                    </label>
                    <button class="btn btn-secondary" onclick="removePoolImage()" id="remove-pool-image-btn" style="display: none;">Remove</button>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="closeModal('pool-image-modal')" style="flex: 1;">Cancel</button>
                    <button class="btn btn-primary" onclick="savePoolImage()" style="flex: 1;">Save Image</button>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast">
        <span id="toast-message"></span>
    </div>

    <script>
        // ==================== DATA STORE ====================
        // In production, this would be backed by a database
        const store = {
            currentUser: null,
            users: [],
            pools: [],
            picks: [],
            invites: []
        };

        // Default pool logos - official tour logos
        // PGA Tour logo - full badge with PGA/TOUR text and golfer silhouette
        const DEFAULT_POOL_LOGO = "https://images.seeklogo.com/logo-png/53/1/pga-tour-logo-png_seeklogo-535076.png";
        
        // LIV Golf default pool logo (inline SVG)
        const DEFAULT_LIV_LOGO = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 160 28'%3E%3Cpath d='M34.814.615H32.74l-5.688 26.898h2.075zM0 15.985l1.576 1.998L5.186.615h-.845c-.693 0-1.267.421-1.423 1.152zm2.421 3.074 1.654 2.075L8.415.614H6.342zm2.537 3.227 1.613 2.037L11.605.616H9.53zm2.537 3.227 1.613 1.997h8.263c.537 0 .96-.384 1.076-.883l.23-1.114H9.533l.269-1.192h9.105a30 30 0 0 0 .422-1.96h-9.146l.269-1.191h9.145c.116-.653.269-1.308.422-1.998h-9.146l.231-1.151h9.146l.153-.73c.153-.653-.346-1.23-1.037-1.23h-7.838l2.998-14.18c.153-.73-.346-1.266-1.036-1.266h-.73l-5.264 24.9zm13.449.73c-.153.73.346 1.267 1.038 1.267h.73L28.396.615h-.846c-.692 0-1.267.421-1.422 1.152L20.94 26.243zm2.92 1.267h2.113L31.625.615H29.55l-5.686 26.898zm6.416 0h.846c.692 0 1.267-.424 1.422-1.152l5.187-24.476c.153-.73-.346-1.267-1.037-1.267h-.73L30.28 27.513zm5.187-1.267c-.154.73.346 1.267 1.036 1.267h.73L42.921.615h-.845c-.693 0-1.268.421-1.423 1.152zm2.92 1.267H40.5L46.148.615h-2.075l-5.688 26.898zm3.19 0h2.074L49.337.615h-2.075l-5.686 26.898zm3.226 0h2.612c.5 0 1.23-.384 1.729-.883l24.9-24.745c.653-.615.653-1.267 0-1.267h-1.46L47.147 25.937l.421-1.997L70.933.615h-2.69L48.301 20.557l.384-1.844L66.552.615H63.9L49.453 15.1l.421-1.922L62.287.615h-1.77c-.536 0-1.266.346-1.766.845l-8.184 8.378 1.69-7.954c.154-.73-.346-1.267-1.036-1.267h-.73l-5.688 26.898zM71.701 14.1c0 7.8 6.225 14.026 14.064 14.026 6.686 0 12.181-4.225 13.68-10.067 1.69 5.842 7.07 10.067 13.486 10.067s11.798-4.188 13.487-9.991a14.05 14.05 0 0 0 13.295 9.376h3.152v-8.915h-3.152c-2.92 0-5.186-2.228-5.186-5.148V.615h-8.877v7.377C123.384 3.227 118.579 0 112.931 0c-6.494 0-11.911 4.303-13.564 10.26h-13.45v7.07h3.92c-.999 1.152-2.421 1.923-4.072 1.923-2.921 0-5.187-2.266-5.187-5.187 0-2.92 2.266-5.186 5.187-5.186a5.25 5.25 0 0 1 2.19.499l4.34-7.8C90.337.541 88.146.001 85.766.001 77.926.002 71.7 6.227 71.7 14.104m36.044-.038c0-2.92 2.265-5.186 5.186-5.186s5.186 2.265 5.186 5.186-2.265 5.187-5.186 5.187-5.186-2.266-5.186-5.187m36.502 13.449h8.878v-6.34h6.303V14.14h-6.263c.231-2.652 2.421-4.649 5.148-4.649h3.152V.615h-3.152c-7.838 0-14.063 6.225-14.063 14.026v12.872z' fill='%23000'/%3E%3C/svg%3E";
        
        // Champions Tour default pool logo
        const DEFAULT_CHAMPIONS_LOGO = "https://images.seeklogo.com/logo-png/30/1/pga-tour-champions-logo-png_seeklogo-301769.png";
        
        // Get default logo based on tour
        function getDefaultPoolLogo(tour) {
            if (tour === 'liv') return DEFAULT_LIV_LOGO;
            if (tour === 'champions') return DEFAULT_CHAMPIONS_LOGO;
            return DEFAULT_POOL_LOGO;
        }

        // ==================== SUPABASE CONFIGURATION ====================
        const SUPABASE_URL = 'https://ttwtifdhlaijdswhehve.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0d3RpZmRobGFpamRzd2hlaHZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc0OTc5MTYsImV4cCI6MjA4MzA3MzkxNn0.h4YVDwZ4_TLmbjHnFSbUKPUpqBsY2Lh4WQIqUwZ3faE';

        // Initialize Supabase client (will be null if Supabase SDK not loaded)
        let supabaseClient = null;
        try {
            if (typeof supabase !== 'undefined' && supabase.createClient) {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        persistSession: true,
                        autoRefreshToken: true,
                        detectSessionInUrl: false,
                        storageKey: 'golf-pool-auth'
                    }
                });
                console.log('Supabase client initialized');
            }
        } catch (e) {
            console.log('Supabase not available, using local storage', e);
        }

        // ==================== API PROXY ====================
        // All data operations go through the edge function to hide database schema
        const API_URL = SUPABASE_URL + '/functions/v1/api';
        
        async function callAPI(action, params = {}) {
            let token = null;
            try {
                const session = await supabaseClient.auth.getSession();
                token = session.data.session?.access_token;
            } catch (e) {
                // No session available
            }

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                },
                body: JSON.stringify({ action, ...params })
            });

            const result = await response.json();
            if (!response.ok || result.error) {
                throw new Error(result.error || `API call failed: ${action}`);
            }
            return result;
        }

        // Retry wrapper for callAPI
        async function callAPIRetry(action, params = {}, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await callAPI(action, params);
                } catch (error) {
                    if (i < maxRetries - 1 && (error.message?.includes('AbortError') || error.message?.includes('fetch'))) {
                        console.log(`API retry ${i + 1}/${maxRetries} for ${action}...`);
                        await new Promise(r => setTimeout(r, 500));
                        continue;
                    }
                    throw error;
                }
            }
        }

        // Helper function to retry Supabase operations that fail with AbortError (legacy - being migrated)
        async function supabaseRetry(operation, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const result = await operation();
                    if (result.error) {
                        if (result.error.message?.includes('AbortError') && i < maxRetries - 1) {
                            console.log(`Retry ${i + 1}/${maxRetries} after AbortError...`);
                            await new Promise(r => setTimeout(r, 500));
                            continue;
                        }
                        return result; // Return the error result if not AbortError
                    }
                    return result;
                } catch (error) {
                    if (error.message?.includes('AbortError') && i < maxRetries - 1) {
                        console.log(`Retry ${i + 1}/${maxRetries} after AbortError...`);
                        await new Promise(r => setTimeout(r, 500));
                        continue;
                    }
                    throw error;
                }
            }
        }

        // ==================== SUPABASE AUTH FUNCTIONS ====================
        async function supabaseSignUp(email, password, name) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const { data, error } = await supabaseClient.auth.signUp({
                email,
                password,
                options: { data: { name } }
            });
            if (error) throw error;
            return data;
        }

        async function supabaseSignIn(email, password) {
            if (!supabaseClient) throw new Error('Supabase not initialized');
            const { data, error } = await supabaseClient.auth.signInWithPassword({
                email,
                password
            });
            if (error) throw error;
            return data;
        }

        async function supabaseSignOut() {
            if (!supabaseClient) return;
            const { error } = await supabaseClient.auth.signOut();
            if (error) throw error;
        }

        async function supabaseGetCurrentUser() {
            if (!supabaseClient) return null;
            const { data: { user } } = await supabaseClient.auth.getUser();
            return user;
        }

        // ==================== SUPABASE POOL FUNCTIONS ====================
        async function supabaseCreatePool(name, season) {
            const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            const result = await callAPI('create-pool', { name, season, inviteCode });
            return result.data;
        }

        async function supabaseJoinPool(inviteCode) {
            const result = await callAPI('join-pool', { inviteCode });
            return result.data;
        }

        async function supabaseGetUserPools() {
            const user = await supabaseGetCurrentUser();
            if (!user) return [];
            const result = await callAPI('get-pools');
            return result.data;
        }

        // ==================== SUPABASE PICK FUNCTIONS ====================
        async function supabaseMakePick(poolId, tournamentId, playerId, playerName) {
            const result = await callAPI('make-pick', { poolId, tournamentId, playerId, playerName });
            return result.data;
        }

        async function supabaseGetUserPicks(poolId) {
            const user = await supabaseGetCurrentUser();
            if (!user) return [];
            const result = await callAPI('get-user-picks', { poolIds: [poolId] });
            return result.data;
        }

        async function supabaseGetPoolStandings(poolId) {
            // Keep using RPC for now as standings involve complex queries
            if (!supabaseClient) return [];
            const { data, error } = await supabaseClient
                .rpc('get_pool_standings', { p_pool_id: poolId });
            if (error) throw error;
            return data;
        }

        // ==================== MOCK DATA ====================
        // PGA Players with ESPN IDs (master list from pgatour.com/players for pre-tournament picks)
        const pgaPlayers = [
            { id: "9478", name: "Scottie Scheffler", country: "USA", rank: 1 },
            { id: "10230", name: "Xander Schauffele", country: "USA", rank: 2 },
            { id: "401", name: "Rory McIlroy", country: "NIR", rank: 3 },
            { id: "9780", name: "Ludvig berg", country: "SWE", rank: 18 },
            { id: "10592", name: "Collin Morikawa", country: "USA", rank: 5 },
            { id: "10046", name: "Viktor Hovland", country: "NOR", rank: 6 },
            { id: "6007", name: "Patrick Cantlay", country: "USA", rank: 7 },
            { id: "11119", name: "Wyndham Clark", country: "USA", rank: 8 },
            { id: "4585", name: "Hideki Matsuyama", country: "JPN", rank: 5 },
            { id: "6798", name: "Tommy Fleetwood", country: "ENG", rank: 11 },
            { id: "8973", name: "Max Homa", country: "USA", rank: 12 },
            { id: "1225", name: "Brian Harman", country: "USA", rank: 13 },
            { id: "10980", name: "Sahith Theegala", country: "USA", rank: 14 },
            { id: "5409", name: "Russell Henley", country: "USA", rank: 15 },
            { id: "2230", name: "Tony Finau", country: "USA", rank: 16 },
            { id: "9037", name: "Luke List", country: "USA", rank: 73 },
            { id: "9427", name: "Sungjae Im", country: "KOR", rank: 18 },
            { id: "9973", name: "Keegan Bradley", country: "USA", rank: 16 },
            { id: "5321", name: "Justin Thomas", country: "USA", rank: 20 },
            { id: "5467", name: "Jordan Spieth", country: "USA", rank: 21 },
            { id: "6798", name: "Cameron Smith", country: "AUS", rank: 22 },
            { id: "5013", name: "Shane Lowry", country: "IRL", rank: 23 },
            { id: "10644", name: "Cameron Young", country: "USA", rank: 24 },
            { id: "9576", name: "Corey Conners", country: "CAN", rank: 25 },
            { id: "1680", name: "Jason Day", country: "AUS", rank: 26 },
            { id: "4419142", name: "Akshay Bhatia", country: "USA", rank: 27 },
            { id: "6993", name: "Tyrrell Hatton", country: "ENG", rank: 28 },
            { id: "7081", name: "Si Woo Kim", country: "KOR", rank: 29 },
            { id: "8961", name: "Sepp Straka", country: "AUT", rank: 30 },
            { id: "3702", name: "Rickie Fowler", country: "USA", rank: 31 },
            { id: "9877", name: "Will Zalatoris", country: "USA", rank: 32 },
            { id: "9938", name: "Sam Burns", country: "USA", rank: 33 },
            { id: "4602673", name: "Tom Kim", country: "KOR", rank: 34 },
            { id: "11378", name: "Robert MacIntyre", country: "SCO", rank: 35 },
            { id: "9025", name: "Daniel Berger", country: "USA", rank: 36 },
            { id: "388", name: "Adam Scott", country: "AUS", rank: 37 },
            { id: "569", name: "Justin Rose", country: "ENG", rank: 38 },
            { id: "1651", name: "Billy Horschel", country: "USA", rank: 39 },
            { id: "6086", name: "Tom Hoge", country: "USA", rank: 40 }
        ];

        // Current tournament (from live data)
        // COMPLETED: The American Express (Jan 22-26, 2026)
        // ==================== 2026 PGA TOUR SCHEDULE ====================
        // Full season schedule - tournaments auto-rotate based on current date
        // Excludes opposite-field events (Puerto Rico, Myrtle Beach, ISCO, Corales, etc.)
        const pga2026Schedule = [
            {
                id: "sentry-2026",
                fieldId: "R2026001",
                name: "The Sentry",
                startDate: "2026-01-02",
                endDate: "2026-01-05",
                course: "Kapalua Resort (Plantation Course)",
                location: "Kapalua, Maui, HI",
                purse: 20000000,
                logoCode: "R016"
            },
            {
                id: "sony-2026",
                fieldId: "R2026006",
                name: "Sony Open in Hawaii",
                startDate: "2026-01-09",
                endDate: "2026-01-12",
                course: "Waialae Country Club",
                location: "Honolulu, HI",
                purse: 8900000,
                logoCode: "R006"
            },
            {
                id: "amex-2026",
                fieldId: "R2026002",
                name: "The American Express",
                startDate: "2026-01-22",
                endDate: "2026-01-25",
                course: "Pete Dye Stadium Course, PGA West",
                location: "La Quinta, CA",
                purse: 9200000,
                logoCode: "R002"
            },
            {
                id: "farmers-2026",
                fieldId: "R2026004",
                name: "Farmers Insurance Open",
                startDate: "2026-01-29",
                endDate: "2026-02-01",
                course: "Torrey Pines GC (South)",
                location: "San Diego, CA",
                purse: 9600000,
                logoCode: "R004"
            },
            {
                id: "phoenix-2026",
                fieldId: "R2026003",
                name: "WM Phoenix Open",
                startDate: "2026-02-05",
                endDate: "2026-02-08",
                course: "TPC Scottsdale (Stadium)",
                location: "Scottsdale, AZ",
                purse: 9600000,
                logoCode: "R003"
            },
            {
                id: "pebble-2026",
                fieldId: "R2026005",
                name: "AT&T Pebble Beach Pro-Am",
                startDate: "2026-02-12",
                endDate: "2026-02-15",
                course: "Pebble Beach Golf Links",
                location: "Pebble Beach, CA",
                purse: 20000000,
                logoCode: "R005"
            },
            {
                id: "genesis-2026",
                fieldId: "R2026011",
                name: "The Genesis Invitational",
                startDate: "2026-02-19",
                endDate: "2026-02-22",
                course: "The Riviera Country Club",
                location: "Pacific Palisades, CA",
                purse: 20000000,
                logoCode: "R011"
            },
            {
                id: "cognizant-2026",
                fieldId: "R2026473",
                name: "Cognizant Classic in The Palm Beaches",
                startDate: "2026-02-26",
                endDate: "2026-03-01",
                course: "PGA National Resort (Champion)",
                location: "Palm Beach Gardens, FL",
                purse: 9600000,
                logoCode: "R473"
            },
            {
                id: "arnold-palmer-2026",
                fieldId: "R2026009",
                name: "Arnold Palmer Invitational",
                startDate: "2026-03-05",
                endDate: "2026-03-08",
                course: "Arnold Palmer's Bay Hill Club & Lodge",
                location: "Orlando, FL",
                purse: 20000000,
                logoCode: "R009"
            },
            {
                id: "players-2026",
                fieldId: "R2026028",
                name: "THE PLAYERS Championship",
                startDate: "2026-03-12",
                endDate: "2026-03-15",
                course: "TPC Sawgrass (Stadium)",
                location: "Ponte Vedra Beach, FL",
                purse: 25000000,
                logoCode: "R028"
            },
            {
                id: "valspar-2026",
                fieldId: "R2026535",
                name: "Valspar Championship",
                startDate: "2026-03-19",
                endDate: "2026-03-22",
                course: "Innisbrook Resort (Copperhead)",
                location: "Palm Harbor, FL",
                purse: 9100000,
                logoCode: "R535"
            },
            {
                id: "houston-2026",
                fieldId: "R2026054",
                name: "Texas Children's Houston Open",
                startDate: "2026-03-26",
                endDate: "2026-03-29",
                course: "Memorial Park Golf Course",
                location: "Houston, TX",
                purse: 9900000,
                logoCode: "R054"
            },
            {
                id: "valero-2026",
                fieldId: "R2026021",
                name: "Valero Texas Open",
                startDate: "2026-04-02",
                endDate: "2026-04-05",
                course: "TPC San Antonio (Oaks)",
                location: "San Antonio, TX",
                purse: 9800000,
                logoCode: "R021"
            },
            {
                id: "masters-2026",
                fieldId: "R2026014",
                name: "Masters Tournament",
                startDate: "2026-04-09",
                endDate: "2026-04-12",
                course: "Augusta National Golf Club",
                location: "Augusta, GA",
                purse: 20000000,
                logoCode: "R014"
            },
            {
                id: "rbc-heritage-2026",
                fieldId: "R2026012",
                name: "RBC Heritage",
                startDate: "2026-04-16",
                endDate: "2026-04-19",
                course: "Harbour Town Golf Links",
                location: "Hilton Head Island, SC",
                purse: 20000000,
                logoCode: "R012"
            },
            {
                id: "zurich-2026",
                fieldId: "R2026476",
                name: "Zurich Classic of New Orleans",
                startDate: "2026-04-23",
                endDate: "2026-04-26",
                course: "TPC Louisiana",
                location: "Avondale, LA",
                purse: 9500000,
                logoCode: "R476"
            },
            {
                id: "cadillac-2026",
                fieldId: "R2026523",
                name: "Cadillac Championship",
                startDate: "2026-04-30",
                endDate: "2026-05-03",
                course: "Trump National Doral (Blue Monster)",
                location: "Miami, FL",
                purse: 20000000,
                logoCode: "R523"
            },
            {
                id: "truist-2026",
                fieldId: "R2026533",
                name: "Truist Championship",
                startDate: "2026-05-07",
                endDate: "2026-05-10",
                course: "Quail Hollow Club",
                location: "Charlotte, NC",
                purse: 20000000,
                logoCode: "R533"
            },
            {
                id: "pga-championship-2026",
                fieldId: "R2026033",
                name: "PGA Championship",
                startDate: "2026-05-14",
                endDate: "2026-05-17",
                course: "Aronimink Golf Club",
                location: "Newtown Square, PA",
                purse: 17500000,
                logoCode: "R033"
            },
            {
                id: "byron-nelson-2026",
                fieldId: "R2026019",
                name: "THE CJ CUP Byron Nelson",
                startDate: "2026-05-21",
                endDate: "2026-05-24",
                course: "TPC Craig Ranch",
                location: "McKinney, TX",
                purse: 10300000,
                logoCode: "R019"
            },
            {
                id: "charles-schwab-2026",
                fieldId: "R2026464",
                name: "Charles Schwab Challenge",
                startDate: "2026-05-28",
                endDate: "2026-05-31",
                course: "Colonial Country Club",
                location: "Fort Worth, TX",
                purse: 9900000,
                logoCode: "R464"
            },
            {
                id: "memorial-2026",
                fieldId: "R2026023",
                name: "the Memorial Tournament",
                startDate: "2026-06-04",
                endDate: "2026-06-07",
                course: "Muirfield Village Golf Club",
                location: "Dublin, OH",
                purse: 20000000,
                logoCode: "R023"
            },
            {
                id: "canadian-open-2026",
                fieldId: "R2026032",
                name: "RBC Canadian Open",
                startDate: "2026-06-11",
                endDate: "2026-06-14",
                course: "TPC Toronto at Osprey Valley",
                location: "Caledon, Ontario, Canada",
                purse: 9800000,
                logoCode: "R032"
            },
            {
                id: "us-open-2026",
                fieldId: "R2026026",
                name: "U.S. Open",
                startDate: "2026-06-18",
                endDate: "2026-06-21",
                course: "Shinnecock Hills Golf Club",
                location: "Southampton, NY",
                purse: 21500000,
                logoCode: "R026"
            },
            {
                id: "travelers-2026",
                fieldId: "R2026034",
                name: "Travelers Championship",
                startDate: "2026-06-25",
                endDate: "2026-06-28",
                course: "TPC River Highlands",
                location: "Cromwell, CT",
                purse: 20000000,
                logoCode: "R034"
            },
            {
                id: "john-deere-2026",
                fieldId: "R2026015",
                name: "John Deere Classic",
                startDate: "2026-07-02",
                endDate: "2026-07-05",
                course: "TPC Deere Run",
                location: "Silvis, IL",
                purse: 8800000,
                logoCode: "R015"
            },
            {
                id: "scottish-open-2026",
                fieldId: "R2026541",
                name: "Genesis Scottish Open",
                startDate: "2026-07-09",
                endDate: "2026-07-12",
                course: "The Renaissance Club",
                location: "North Berwick, Scotland",
                purse: 9000000,
                logoCode: "R541"
            },
            {
                id: "open-championship-2026",
                fieldId: "R2026100",
                name: "The Open Championship",
                startDate: "2026-07-16",
                endDate: "2026-07-19",
                course: "Royal Birkdale Golf Club",
                location: "Southport, England",
                purse: 17000000,
                logoCode: "R100"
            },
            {
                id: "3m-open-2026",
                fieldId: "R2026528",
                name: "3M Open",
                startDate: "2026-07-23",
                endDate: "2026-07-26",
                course: "TPC Twin Cities",
                location: "Blaine, MN",
                purse: 8800000,
                logoCode: "R528"
            },
            {
                id: "rocket-classic-2026",
                fieldId: "R2026506",
                name: "Rocket Classic",
                startDate: "2026-07-30",
                endDate: "2026-08-02",
                course: "Detroit Golf Club",
                location: "Detroit, MI",
                purse: 10000000,
                logoCode: "R506"
            },
            {
                id: "wyndham-2026",
                fieldId: "R2026480",
                name: "Wyndham Championship",
                startDate: "2026-08-06",
                endDate: "2026-08-09",
                course: "Sedgefield Country Club",
                location: "Greensboro, NC",
                purse: 8500000,
                logoCode: "R480"
            },
            {
                id: "fedex-st-jude-2026",
                fieldId: "R2026490",
                name: "FedEx St. Jude Championship",
                startDate: "2026-08-13",
                endDate: "2026-08-16",
                course: "TPC Southwind",
                location: "Memphis, TN",
                purse: 20000000,
                logoCode: "R490"
            },
            {
                id: "bmw-2026",
                fieldId: "R2026028",
                name: "BMW Championship",
                startDate: "2026-08-20",
                endDate: "2026-08-23",
                course: "Bellerive Country Club",
                location: "St. Louis, MO",
                purse: 20000000,
                logoCode: "R028",
                isSeasonFinale: true // One and Done season ends here
            }
            // Note: Tour Championship excluded - limited field invitational
            // Opposite-field events excluded: Puerto Rico, Myrtle Beach, ISCO, Corales, Puntacana
        ];

        // ==================== DYNAMIC TOURNAMENT DETECTION ====================
        function getTournamentDates(tournament) {
            // Parse dates and set proper times
            const start = new Date(tournament.startDate + 'T07:00:00-08:00'); // Thursday 7am PT
            const end = new Date(tournament.endDate + 'T23:59:59-08:00'); // Sunday end
            const pickWindowOpen = new Date(start);
            pickWindowOpen.setDate(pickWindowOpen.getDate() - 3); // Monday before
            pickWindowOpen.setUTCHours(7, 0, 0, 0); // 7am UK time
            const showUntil = new Date(end);
            showUntil.setDate(showUntil.getDate() + 1); // Tuesday after
            showUntil.setUTCHours(7, 0, 0, 0); // Until Tuesday 7am UK
            
            // Emojis should show until next tournament starts
            const emojiShowUntil = new Date(end);
            emojiShowUntil.setDate(emojiShowUntil.getDate() + 4); // Thursday after
            emojiShowUntil.setUTCHours(7, 0, 0, 0); // Until Thursday 7am UK
            
            return { start, end, pickWindowOpen, showUntil, emojiShowUntil };
        }

        // PGA Tour Champions 2026 Schedule
        const champions2026Schedule = [
            {
                id: "chubb-champ-2026",
                fieldId: "S2026552",
                name: "Chubb Classic",
                startDate: "2026-02-13",
                endDate: "2026-02-15",
                course: "Tiburn Golf Club",
                location: "Naples, FL",
                purse: 1800000,
                logoCode: "s552"
            },
            {
                id: "hardie-champ-2026",
                fieldId: "S2026541",
                name: "James Hardie Pro Football HOF Invitational",
                startDate: "2026-03-06",
                endDate: "2026-03-08",
                course: "The Old Course at Broken Sound",
                location: "Boca Raton, FL",
                purse: 2200000,
                logoCode: "s059"
            },
            {
                id: "cologuard-champ-2026",
                fieldId: "S2026006",
                name: "Cologuard Classic",
                startDate: "2026-03-20",
                endDate: "2026-03-22",
                course: "La Paloma Country Club",
                location: "Tucson, AZ",
                purse: 2200000,
                logoCode: "s018"
            },
            {
                id: "hoag-champ-2026",
                fieldId: "S2026007",
                name: "Hoag Classic",
                startDate: "2026-03-27",
                endDate: "2026-03-29",
                course: "Newport Beach CC",
                location: "Newport Beach, CA",
                purse: 2200000,
                logoCode: "s573"
            },
            {
                id: "senior-pga-2026",
                fieldId: "S2026520",
                name: "Senior PGA Championship",
                startDate: "2026-04-16",
                endDate: "2026-04-19",
                course: "The Concession Golf Club",
                location: "Bradenton, FL",
                purse: 3000000,
                logoCode: "s520"
            },
            {
                id: "mitsubishi-classic-2026",
                fieldId: "S2026009",
                name: "Mitsubishi Electric Classic",
                startDate: "2026-04-24",
                endDate: "2026-04-26",
                course: "TPC Sugarloaf",
                location: "Duluth, GA",
                purse: 2000000,
                logoCode: "s015"
            },
            {
                id: "regions-tradition-2026",
                fieldId: "S2026505",
                name: "Regions Tradition",
                startDate: "2026-04-30",
                endDate: "2026-05-03",
                course: "Greystone G&CC",
                location: "Birmingham, AL",
                purse: 2600000,
                logoCode: "s558"
            },
            {
                id: "insperity-2026",
                fieldId: "S2026010",
                name: "Insperity Invitational",
                startDate: "2026-05-08",
                endDate: "2026-05-10",
                course: "The Woodlands CC",
                location: "The Woodlands, TX",
                purse: 3000000,
                logoCode: "s615"
            },
            {
                id: "trophy-hassan-2026",
                fieldId: "S2026540",
                name: "Trophy Hassan II",
                startDate: "2026-05-21",
                endDate: "2026-05-23",
                course: "Royal Golf Dar Es Salam",
                location: "Rabat, Morocco",
                purse: 2500000,
                logoCode: "s624"
            },
            {
                id: "american-family-2026",
                fieldId: "S2026013",
                name: "American Family Insurance Championship",
                startDate: "2026-06-05",
                endDate: "2026-06-07",
                course: "TPC Wisconsin",
                location: "Madison, WI",
                purse: 3000000,
                logoCode: "s622"
            },
            {
                id: "principal-charity-2026",
                fieldId: "S2026012",
                name: "Principal Charity Classic",
                startDate: "2026-06-12",
                endDate: "2026-06-14",
                course: "Wakonda Club",
                location: "Des Moines, IA",
                purse: 2000000,
                logoCode: "s512"
            },
            {
                id: "dicks-open-2026",
                fieldId: "S2026016",
                name: "DICK'S Open",
                startDate: "2026-06-26",
                endDate: "2026-06-28",
                course: "En-Joie GC",
                location: "Endicott, NY",
                purse: 2200000,
                logoCode: "s507"
            },
            {
                id: "us-senior-open-2026",
                fieldId: "S2026521",
                name: "U.S. Senior Open Championship",
                startDate: "2026-07-02",
                endDate: "2026-07-05",
                course: "Scioto CC",
                location: "Columbus, OH",
                purse: 4000000,
                logoCode: "s614"
            },
            {
                id: "kaulig-2026",
                fieldId: "S2026506",
                name: "Kaulig Companies Championship",
                startDate: "2026-07-09",
                endDate: "2026-07-12",
                course: "Firestone CC",
                location: "Akron, OH",
                purse: 3500000,
                logoCode: "s060"
            },
            {
                id: "senior-open-2026",
                fieldId: "S2026519",
                name: "ISPS HANDA Senior Open",
                startDate: "2026-07-23",
                endDate: "2026-07-26",
                course: "Gleneagles Hotel (Kings Course)",
                location: "Auchterarder, Scotland",
                purse: 2850000,
                logoCode: "s619"
            },
            {
                id: "portugal-2026",
                fieldId: "S2026542",
                name: "Portugal Invitational",
                startDate: "2026-07-31",
                endDate: "2026-08-02",
                course: "The Els Club Vilamoura",
                location: "Algarve, Portugal",
                purse: 3000000,
                logoCode: "s017"
            },
            {
                id: "boeing-2026",
                fieldId: "S2026022",
                name: "Boeing Classic",
                startDate: "2026-08-14",
                endDate: "2026-08-16",
                course: "The Club at Snoqualmie Ridge",
                location: "Snoqualmie, WA",
                purse: 2300000,
                logoCode: "s022"
            },
            {
                id: "rogers-charity-2026",
                fieldId: "S2026017",
                name: "Rogers Charity Classic",
                startDate: "2026-08-21",
                endDate: "2026-08-23",
                course: "Canyon Meadows G&CC",
                location: "Calgary, AB, Canada",
                purse: 2500000,
                logoCode: "s023"
            },
            {
                id: "ally-challenge-2026",
                fieldId: "S2026023",
                name: "The Ally Challenge",
                startDate: "2026-08-28",
                endDate: "2026-08-30",
                course: "Warwick Hills G&CC",
                location: "Grand Blanc, MI",
                purse: 2200000,
                logoCode: "s616"
            },
            {
                id: "sanford-2026",
                fieldId: "S2026026",
                name: "Sanford International",
                startDate: "2026-09-11",
                endDate: "2026-09-13",
                course: "Minnehaha Country Club",
                location: "Sioux Falls, SD",
                purse: 2200000,
                logoCode: "s061"
            },
            {
                id: "pure-insurance-2026",
                fieldId: "S2026024",
                name: "PURE Insurance Championship",
                startDate: "2026-09-18",
                endDate: "2026-09-20",
                course: "Pebble Beach Golf Links",
                location: "Monterey Peninsula, CA",
                purse: 2400000,
                logoCode: "s044"
            },
            {
                id: "lehigh-valley-2026",
                fieldId: "S2026543",
                name: "Jefferson Lehigh Valley Classic",
                startDate: "2026-10-02",
                endDate: "2026-10-04",
                course: "Lehigh Country Club",
                location: "Allentown, PA",
                purse: 2300000,
                logoCode: "s609"
            },
            {
                id: "furyk-2026",
                fieldId: "S2026029",
                name: "Constellation FURYK & FRIENDS",
                startDate: "2026-10-09",
                endDate: "2026-10-11",
                course: "Ocean Course at Hammock Beach",
                location: "Palm Coast, FL",
                purse: 2200000,
                logoCode: "s625"
            },
            {
                id: "sas-2026",
                fieldId: "S2026030",
                name: "SAS Championship",
                startDate: "2026-10-16",
                endDate: "2026-10-18",
                course: "Prestonwood CC",
                location: "Cary, NC",
                purse: 2100000,
                logoCode: "s009"
            },
            {
                id: "stifel-charity-2026",
                fieldId: "S2026031",
                name: "Stifel Charity Classic",
                startDate: "2026-10-23",
                endDate: "2026-10-25",
                course: "Norwood Hills Country Club",
                location: "St. Louis, MO",
                purse: 2300000,
                logoCode: "s539"
            },
            {
                id: "simmons-bank-2026",
                fieldId: "S2026032",
                name: "Simmons Bank Championship",
                startDate: "2026-10-30",
                endDate: "2026-11-01",
                course: "Pleasant Valley Country Club",
                location: "Little Rock, AR",
                purse: 2300000,
                logoCode: "s032"
            },
            {
                id: "schwab-cup-2026",
                fieldId: "S2026034",
                name: "Charles Schwab Cup Championship",
                startDate: "2026-11-12",
                endDate: "2026-11-15",
                course: "Phoenix Country Club",
                location: "Phoenix, AZ",
                purse: 3000000,
                logoCode: "s034"
            }
        ];

        // Schwab Cup Rankings for Champions Tour (2025 final + 2026 early season)
        // Used for sorting players in the Make Pick screen
        const schwabCupRankings = {
            "20229": 1,   // Stewart Cink
            "20848": 2,   // ngel Cabrera
            "20157": 3,   // Retief Goosen
            "10944": 4,   // Thomas Bjrn
            "06522": 5,   // Ernie Els
            "6522": 5,    // Ernie Els (alternate ID format)
            "21731": 6,   // Freddie Jacobson
            "19825": 7,   // Darren Clarke
            "01226": 8,   // Fred Couples
            "1226": 8,    // Fred Couples (alternate)
            "06004": 9,   // Stephen Ames
            "6004": 9,    // Stephen Ames (alternate)
            "01666": 10,  // Bernhard Langer
            "1666": 10,   // Bernhard Langer (alternate)
            "30750": 11,  // Tommy Gainey
            "20472": 12,  // Alex Cejka
            "19958": 13,  // Miguel Angel Jimnez
            "06567": 14,  // Vijay Singh
            "6567": 14,   // Vijay Singh (alternate)
            "09011": 15,  // David Duval
            "9011": 15,   // David Duval (alternate)
            "08075": 16,  // Jerry Kelly
            "8075": 16,   // Jerry Kelly (alternate)
            "26289": 17,  // Boo Weekley
            "10423": 18,  // Mike Weir
            "24663": 19,  // Y.E. Yang
            "07457": 20,  // Steve Flesch
            "7457": 20,   // Steve Flesch (alternate)
            "22075": 21,  // Ricardo Gonzalez
            "20569": 22,  // Richard Green
            "02206": 23,  // David Toms
            "2206": 23,   // David Toms (alternate)
            "01457": 24,  // Jay Haas
            "1457": 24,   // Jay Haas (alternate)
            "23175": 25,  // Tim O'Neal
            "06036": 26,  // Scott Dunlap
            "6036": 26,   // Scott Dunlap (alternate)
            "06621": 27,  // Joe Durant
            "6621": 27,   // Joe Durant (alternate)
            "20771": 28,  // Steven Alker
            "21633": 29,  // Steve Allan
            "24357": 30,  // K.J. Choi
            "10860": 31,  // Justin Leonard
            "01706": 32,  // Davis Love III
            "1706": 32,   // Davis Love III (alternate)
            "01797": 33,  // Rocco Mediate
            "1797": 33,   // Rocco Mediate (alternate)
            "10809": 34,  // Jim Furyk
            "10585": 35,  // Scott McCarron
            "20099": 36,  // Doug Barron
            "06693": 37,  // Ken Tanigawa
            "6693": 37,   // Ken Tanigawa (alternate)
            "11127": 38,  // Stephen Dodd
            "01928": 39,  // Corey Pavin
            "1928": 39,   // Corey Pavin (alternate)
            "01677": 40,  // Tom Lehman
            "1677": 40,   // Tom Lehman (alternate)
            "01139": 41,  // Olin Browne
            "1139": 41,   // Olin Browne (alternate)
            "01381": 42,  // Fred Funk
            "1381": 42,   // Fred Funk (alternate)
            "10378": 43,  // Steve Stricker
            "03418": 44,  // Padraig Harrington
            "3418": 44,   // Padraig Harrington (alternate)
            "10244": 45,  // Stuart Appleby
            "20574": 46,  // Robert Karlsson
            "01686": 47,  // Billy Mayfair
            "1686": 47,   // Billy Mayfair (alternate)
            "05251": 48,  // John Daly
            "5251": 48,   // John Daly (alternate)
            "01883": 49,  // Kenny Perry
            "1883": 49,   // Kenny Perry (alternate)
            "08794": 50   // Rod Pampling
        };
        
        // Get Schwab Cup rank for a player
        function getSchwabCupRank(playerId) {
            return schwabCupRankings[String(playerId)] || 999;
        }

        // LIV Golf 2026 Schedule (72-hole events, no cut, ~57 players)
        const liv2026Schedule = [
            {
                id: "liv-riyadh-2026",
                espnId: "401807532",
                name: "LIV Golf Riyadh",
                startDate: "2026-02-04",
                endDate: "2026-02-07",
                course: "Riyadh Golf Club",
                location: "Riyadh, Saudi Arabia",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766426449/prd/assets/assets/LIV%20Logos/01_RoshnGroup_Riyadh_Localized_Lockup_2026_Horizontal_nq79dq.jpg"
            },
            {
                id: "liv-adelaide-2026",
                espnId: "401804701",
                name: "LIV Golf Adelaide",
                startDate: "2026-02-12",
                endDate: "2026-02-15",
                course: "The Grange Golf Club",
                location: "Adelaide, Australia",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766426576/prd/assets/assets/LIV%20Logos/02_ADELAIDE_Localized_Lockup_2026_Horizontal_ctf7hc.jpg"
            },
            {
                id: "liv-hongkong-2026",
                espnId: "401824806",
                name: "LIV Golf Hong Kong",
                startDate: "2026-03-05",
                endDate: "2026-03-08",
                course: "Hong Kong Golf Club at Fanling",
                location: "Hong Kong",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766426783/prd/assets/assets/LIV%20Logos/03_HONG_KONG_Localized_Lockup_2026_Horizontal_xhqllb.jpg"
            },
            {
                id: "liv-singapore-2026",
                espnId: "401806356",
                name: "LIV Golf Singapore",
                startDate: "2026-03-12",
                endDate: "2026-03-15",
                course: "Sentosa Golf Club",
                location: "Singapore",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1768928651/prd/assets/04_SINGAPORE_Localized_Lockup_2026_Horizontal_ikytyt.jpg"
            },
            {
                id: "liv-southafrica-2026",
                espnId: "401805587",
                name: "LIV Golf South Africa",
                startDate: "2026-03-19",
                endDate: "2026-03-22",
                course: "The Club at Steyn City",
                location: "Midrand, South Africa",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766426968/prd/assets/assets/LIV%20Logos/05_SOUTH_AFRICA_Localized_Lockup_2026_Horizontal_vhxydw.jpg"
            },
            {
                id: "liv-mexico-2026",
                espnId: "401805795",
                name: "LIV Golf Mexico City",
                startDate: "2026-04-16",
                endDate: "2026-04-19",
                course: "Club De Golf Chapultepec",
                location: "Mexico City, Mexico",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766427036/prd/assets/assets/LIV%20Logos/06_MEXICO_CITY_Localized_Lockup_2026_Horizontal_ryv3lw.jpg"
            },
            {
                id: "liv-virginia-2026",
                espnId: "401808353",
                name: "LIV Golf Virginia",
                startDate: "2026-05-07",
                endDate: "2026-05-10",
                course: "Trump National Golf Club",
                location: "Washington, DC",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1769793290/prd/assets/assets/LIV%20Logos/07_VIRGINIA_Localized_Lockup_2026_Horizontal_bcux1q.jpg"
            },
            {
                id: "liv-andalucia-2026",
                espnId: "401809165",
                name: "LIV Golf Andaluca",
                startDate: "2026-06-04",
                endDate: "2026-06-07",
                course: "Real Club Valderrama",
                location: "Sotogrande, Spain",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766427162/prd/assets/assets/LIV%20Logos/09_ANDALUCIA_Localized_Lockup_2026_Horizontal_dy31la.jpg"
            },
            {
                id: "liv-louisiana-2026",
                espnId: "401817380",
                name: "LIV Golf Louisiana",
                startDate: "2026-06-25",
                endDate: "2026-06-28",
                course: "Bayou Oaks at City Park",
                location: "New Orleans, LA",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766427234/prd/assets/assets/LIV%20Logos/10_LOUISIANA_Localized_Lockup_2026_Horizontal_jzjp1q.jpg"
            },
            {
                id: "liv-uk-2026",
                espnId: "401804745",
                name: "LIV Golf United Kingdom",
                startDate: "2026-07-23",
                endDate: "2026-07-26",
                course: "JCB Golf and Country Club",
                location: "Rocester, England",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766427261/prd/assets/assets/LIV%20Logos/11_UK_Localized_Lockup_2026_Horizontal_c74bz3.jpg"
            },
            {
                id: "liv-newyork-2026",
                espnId: "401843580",
                name: "LIV Golf New York",
                startDate: "2026-08-06",
                endDate: "2026-08-09",
                course: "Trump National Bedminster",
                location: "Bedminster, NJ",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1769173152/prd/assets/assets/LIV%20Logos/12_NEW_YORK_Localized_Lockup_2026-HORIZONTAL_gtbmky.jpg"
            },
            {
                id: "liv-indianapolis-2026",
                espnId: "401811430",
                name: "LIV Golf Indianapolis",
                startDate: "2026-08-20",
                endDate: "2026-08-23",
                course: "The Club at Chatham Hills",
                location: "Westfield, IN",
                purse: 20000000,
                livLogo: "https://images.livgolf.com/image/private/t_w_420-f_webp-c_scale/v1766167359/prd/assets/new-event-logos/13_INDIANAPOLIS_Localized_Lockup_2026_Horizontal_h3mysm.jpg"
            }
            // Note: Team Championship (Michigan) excluded - different format
        ];
        
        // LIV Golf 2026 Player Field (57 players - 52 team players + 5 wildcards)
        // ESPN IDs from ESPN LIV coverage
        // DataGolf ID to LIV Team mapping
        const livTeamMapping = {
            // 4 Aces GC
            12422: "4 Aces GC",      // Dustin Johnson
            13944: "4 Aces GC",      // Thomas Pieters
            14181: "4 Aces GC",      // Thomas Detry
            15274: "4 Aces GC",      // Miguel Tabuena (temp replacement)
            // Cleeks GC
            8117: "Cleeks GC",       // Martin Kaymer
            6516: "Cleeks GC",       // Richard Bland
            14196: "Cleeks GC",      // Adrian Meronk
            20730: "Cleeks GC",      // Victor Perez
            // Crushers GC
            19841: "Crushers GC",    // Bryson DeChambeau
            7108: "Crushers GC",     // Paul Casey
            6892: "Crushers GC",     // Charles Howell III
            12669: "Crushers GC",    // Anirban Lahiri
            // Fireballs GC
            5689: "Fireballs GC",    // Sergio Garcia
            28473: "Fireballs GC",   // Jose Luis Ballester
            28984: "Fireballs GC",   // David Puig
            30428: "Fireballs GC",   // Luis Masaveu
            // HyFlyers GC
            14013: "HyFlyers GC",    // Cameron Tringale
            33755: "HyFlyers GC",    // Michael La Sasso
            11019: "HyFlyers GC",    // Brendan Steele
            18662: "HyFlyers GC",    // Ollie Schniederjans (temp replacement)
            // Korean GC
            14459: "Korean GC",      // Byeong Hun An
            11826: "Korean GC",      // Danny Lee
            20780: "Korean GC",      // Minkyu Kim
            16160: "Korean GC",      // Younghan Song
            // Legion XIII
            19195: "Legion XIII",    // Jon Rahm
            14796: "Legion XIII",    // Tyrrell Hatton
            30463: "Legion XIII",    // Caleb Surratt
            22322: "Legion XIII",    // Tom McKibbin
            // Majesticks GC
            1435: "Majesticks GC",   // Ian Poulter
            19866: "Majesticks GC",  // Sam Horsfield
            14795: "Majesticks GC",  // Laurie Canter
            27258: "Majesticks GC",  // Ben Schmidt (temp replacement)
            // RangeGoats GC
            7334: "RangeGoats GC",   // Bubba Watson
            25919: "RangeGoats GC",  // Matthew Wolff
            11357: "RangeGoats GC",  // Peter Uihlein
            14373: "RangeGoats GC",  // Ben Campbell
            // Ripper GC
            15856: "Ripper GC",      // Cameron Smith
            7649: "Ripper GC",       // Marc Leishman
            17064: "Ripper GC",      // Lucas Herbert
            24200: "Ripper GC",      // Elvis Smylie
            // Smash GC
            18580: "Smash GC",       // Talor Gooch
            7548: "Smash GC",        // Graeme McDowell
            12337: "Smash GC",       // Jason Kokrak
            16602: "Smash GC",       // Harold Varner III
            // Southern Guards
            7672: "Southern Guards", // Louis Oosthuizen
            7398: "Southern Guards", // Charl Schwartzel
            14424: "Southern Guards",// Dean Burmester
            11952: "Southern Guards",// Branden Grace
            // Torque GC
            18079: "Torque GC",      // Joaquin Niemann
            20770: "Torque GC",      // Sebastian Munoz
            18238: "Torque GC",      // Abraham Ancer
            14735: "Torque GC",      // Carlos Ortiz
            // Wildcards
            11641: "Wildcard",       // Anthony Kim
            12413: "Wildcard",       // Richard T Lee
            16231: "Wildcard",       // Bjorn Hellgren
            14559: "Wildcard",       // Scott Vincent
            12637: "Wildcard"        // Yosuke Asaji
        };

        const livPlayerField = [
            // Sorted by DataGolf win probability for LIV Riyadh 2026
            { id: "9780", name: "Jon Rahm", country: "ESP", team: "Legion XIII" },
            { id: "10046", name: "Bryson DeChambeau", country: "USA", team: "Crushers GC" },
            { id: "4895429", name: "David Puig", country: "ESP", team: "Fireballs GC" },
            { id: "5553", name: "Tyrrell Hatton", country: "ENG", team: "Legion XIII" },
            { id: "4348444", name: "Tom McKibbin", country: "NIR", team: "Legion XIII" },
            { id: "5285", name: "Byeong Hun An", country: "KOR", team: "Korean GC" },
            { id: "11099", name: "Joaquin Niemann", country: "CHI", team: "Torque GC" },
            { id: "10259", name: "Thomas Detry", country: "BEL", team: "4 Aces GC" },
            { id: "158", name: "Sergio Garcia", country: "ESP", team: "Fireballs GC" },
            { id: "5532", name: "Carlos Ortiz", country: "MEX", team: "Torque GC" },
            { id: "4686092", name: "Jose Luis Ballester", country: "ESP", team: "Fireballs GC" },
            { id: "10404", name: "Sebastian Munoz", country: "COL", team: "Torque GC" },
            { id: "780", name: "Bubba Watson", country: "USA", team: "RangeGoats GC" },
            { id: "4383", name: "Branden Grace", country: "RSA", team: "Southern Guards" },
            { id: "208", name: "Charles Howell III", country: "USA", team: "Crushers GC" },
            { id: "9353", name: "Victor Perez", country: "FRA", team: "Cleeks GC" },
            { id: "3351", name: "Marc Leishman", country: "AUS", team: "Ripper GC" },
            { id: "9131", name: "Cameron Smith", country: "AUS", team: "Ripper GC" },
            { id: "1293", name: "Louis Oosthuizen", country: "RSA", team: "Southern Guards" },
            { id: "10343", name: "Lucas Herbert", country: "AUS", team: "Ripper GC" },
            { id: "4645", name: "Cameron Tringale", country: "USA", team: "HyFlyers GC" },
            { id: "5110034", name: "Caleb Surratt", country: "USA", team: "Legion XIII" },
            { id: "9031", name: "Thomas Pieters", country: "BEL", team: "4 Aces GC" },
            { id: "5830", name: "Dean Burmester", country: "RSA", team: "Southern Guards" },
            { id: "9261", name: "Abraham Ancer", country: "MEX", team: "Torque GC" },
            { id: "10418", name: "Laurie Canter", country: "ENG", team: "Majesticks GC" },
            { id: "3448", name: "Dustin Johnson", country: "USA", team: "4 Aces GC" },
            { id: "4686269", name: "Elvis Smylie", country: "AUS", team: "Ripper GC" },
            { id: "1097", name: "Charl Schwartzel", country: "RSA", team: "Southern Guards" },
            { id: "4364379", name: "Richard T Lee", country: "CAN", team: "Wildcard" },
            { id: "9513", name: "Talor Gooch", country: "USA", team: "Smash GC" },
            { id: "72", name: "Paul Casey", country: "ENG", team: "Crushers GC" },
            { id: "9799", name: "Scott Vincent", country: "ZIM", team: "Wildcard" },
            { id: "4989", name: "Anirban Lahiri", country: "IND", team: "Crushers GC" },
            { id: "3317", name: "Jason Kokrak", country: "USA", team: "Smash GC" },
            { id: "4686095", name: "Miguel Tabuena", country: "PHI", team: "4 Aces GC" },
            { id: "6991", name: "Harold Varner III", country: "USA", team: "Smash GC" },
            { id: "4686096", name: "Ben Schmidt", country: "ENG", team: "Majesticks GC" },
            { id: "10839", name: "Adrian Meronk", country: "POL", team: "Cleeks GC" },
            { id: "1674", name: "Peter Uihlein", country: "USA", team: "RangeGoats GC" },
            { id: "1441", name: "Richard Bland", country: "ENG", team: "Cleeks GC" },
            { id: "3596", name: "Brendan Steele", country: "USA", team: "HyFlyers GC" },
            { id: "9192", name: "Younghan Song", country: "KOR", team: "Korean GC" },
            { id: "4686088", name: "Bjorn Hellgren", country: "SWE", team: "Wildcard" },
            { id: "5104245", name: "Luis Masaveu", country: "ESP", team: "Fireballs GC" },
            { id: "4412121", name: "Matthew Wolff", country: "USA", team: "RangeGoats GC" },
            { id: "301", name: "Graeme McDowell", country: "NIR", team: "Smash GC" },
            { id: "10049", name: "Sam Horsfield", country: "ENG", team: "Majesticks GC" },
            { id: "4686091", name: "Michael La Sasso", country: "ARG", team: "HyFlyers GC" },
            { id: "3670", name: "Martin Kaymer", country: "GER", team: "Cleeks GC" },
            { id: "9527", name: "Ollie Schniederjans", country: "USA", team: "HyFlyers GC" },
            { id: "619", name: "Ian Poulter", country: "ENG", team: "Majesticks GC" },
            { id: "4686090", name: "Yosuke Asaji", country: "JPN", team: "Wildcard" },
            { id: "4686093", name: "Minkyu Kim", country: "KOR", team: "Korean GC" },
            { id: "7011", name: "Ben Campbell", country: "NZL", team: "RangeGoats GC" },
            { id: "1745", name: "Anthony Kim", country: "USA", team: "Wildcard" },
            { id: "3950", name: "Danny Lee", country: "NZL", team: "Korean GC" }
        ];

        // Get schedule for a specific tour (defaults to 'pga')
        function getScheduleForTour(tour) {
            if (tour === 'champions') {
                return champions2026Schedule;
            }
            if (tour === 'liv') {
                return liv2026Schedule;
            }
            return pga2026Schedule; // Default fallback for existing pools
        }
        
        // Get display name for a tour
        function getTourDisplayName(tour) {
            if (tour === 'champions') return 'PGA Tour Champions';
            if (tour === 'liv') return 'LIV Golf';
            return 'PGA Tour';
        }

        function formatTournament(t) {
            const dates = getTournamentDates(t);
            const startMonth = new Date(t.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endDay = new Date(t.endDate).toLocaleDateString('en-US', { day: 'numeric' });
            const endMonth = new Date(t.endDate).toLocaleDateString('en-US', { month: 'short' });
            const startMonthName = new Date(t.startDate).toLocaleDateString('en-US', { month: 'short' });
            
            // Compact date format without year: "Feb 12-15" or "Mar 28 - Apr 1"
            const dateStr = startMonthName === endMonth 
                ? `${startMonth}-${endDay}`
                : `${startMonth} - ${endMonth} ${endDay}`;
            
            // Handle logo URL - LIV tournaments use livLogo, PGA/Champions use logoCode
            let logoUrl = null;
            if (t.livLogo) {
                // LIV Golf uses their own CDN for logos
                logoUrl = t.livLogo;
            } else if (t.logoCode) {
                // Use different logo URL pattern for Champions Tour (s prefix) vs PGA Tour (R prefix)
                const isChampionsTour = t.logoCode.toLowerCase().startsWith('s');
                logoUrl = isChampionsTour
                    ? `https://res.cloudinary.com/pgatour-prod/image/upload/dpr_2.0,q_auto/c_scale,w_120/v1/tournaments/logos/${t.logoCode.toLowerCase()}`
                    : `https://res.cloudinary.com/pgatour-prod/image/upload/dpr_2.0,q_auto/c_scale,w_120/v1/tournaments/logos/${t.logoCode.toLowerCase()}`;
            }
            
            return {
                ...t,
                dates: dateStr,
                logo: logoUrl,
                startTime: dates.start,
                endTime: dates.end,
                pickWindowOpen: dates.pickWindowOpen,
                showUntil: dates.showUntil,
                emojiShowUntil: dates.emojiShowUntil,
                round: 0,
                status: "Upcoming"
            };
        }

        function getCurrentTournaments(tour = 'pga') {
            const now = new Date();
            const schedule = getScheduleForTour(tour);
            
            let justFinished = null;
            let emojiTournament = null; // For showing hot/ice emojis (lasts until Thursday)
            let current = null;
            let upcoming = null;
            let next = null;
            
            for (let i = 0; i < schedule.length; i++) {
                const t = formatTournament(schedule[i]);
                const dates = getTournamentDates(schedule[i]);
                
                // Just finished: ended but still within show window (until Tuesday)
                if (now > dates.end && now < dates.showUntil) {
                    justFinished = { ...t, status: "Complete", round: 4 };
                }
                
                // Emoji tournament: ended but still within emoji window (until Thursday)
                if (now > dates.end && now < dates.emojiShowUntil) {
                    emojiTournament = { ...t, status: "Complete", round: 4 };
                }
                
                // Current/Upcoming: tournament is happening or about to start
                if (now >= dates.pickWindowOpen && now <= dates.end) {
                    if (now >= dates.start) {
                        // Tournament in progress
                        current = { ...t, status: "In Progress" };
                    } else {
                        // Pick window open, tournament not started
                        upcoming = t;
                    }
                }
                
                // Next: first tournament after current/upcoming
                if (now < dates.pickWindowOpen && !next) {
                    next = t;
                }
                
                // Upcoming fallback: if no current tournament, find the next one
                if (!current && !upcoming && now < dates.start) {
                    upcoming = t;
                    if (i + 1 < schedule.length) {
                        next = formatTournament(schedule[i + 1]);
                    }
                    break;
                }
            }
            
            // If tournament is in progress, that's also the "upcoming" for picks
            if (current && !upcoming) {
                upcoming = current;
            }
            
            return { justFinished, emojiTournament, current, upcoming, next };
        }

        // Get current tournament state (default to PGA Tour for backwards compatibility)
        let currentPoolTour = 'pga'; // Track current pool's tour
        let tournamentState = getCurrentTournaments('pga');
        let justFinishedTournament = tournamentState.justFinished;
        let emojiTournament = tournamentState.emojiTournament; // For hot/ice emojis (lasts until Thursday)
        let upcomingTournament = tournamentState.upcoming || tournamentState.current;
        let nextTournament = tournamentState.next;
        let currentTournament = upcomingTournament;

        // Update tournament state when pool changes
        async function updateTournamentStateForPool() {
            console.log(`Updating tournament state for tour: ${currentPoolTour}`);
            tournamentState = getCurrentTournaments(currentPoolTour);
            justFinishedTournament = tournamentState.justFinished;
            emojiTournament = tournamentState.emojiTournament;
            upcomingTournament = tournamentState.upcoming || tournamentState.current;
            nextTournament = tournamentState.next;
            currentTournament = upcomingTournament;
            
            console.log(`Tournament State for ${currentPoolTour}:`, {
                justFinished: justFinishedTournament?.name,
                emojiTournament: emojiTournament?.name,
                upcoming: upcomingTournament?.name,
                next: nextTournament?.name,
                currentId: currentTournament?.id
            });
            
            // Refresh ESPN leaderboard for new tour
            fetchESPNLeaderboard();
            
            // Refresh field data for new tour
            if (currentTournament) {
                console.log(`Fetching field for ${currentPoolTour} tour, tournament: ${currentTournament.id}`);
                await fetchTournamentField(currentTournament.fieldId || currentTournament.id, currentPoolTour);
                console.log(`Field loaded for ${currentPoolTour}, count: ${tournamentField.length}`);
            }
        }

        // Log current tournament state for debugging
        console.log('Tournament State:', {
            justFinished: justFinishedTournament?.name,
            upcoming: upcomingTournament?.name,
            next: nextTournament?.name
        });

        // Determine which tournament to show on leaderboard
        function getCurrentDisplayTournament() {
            const now = new Date();
            // If justFinishedTournament exists and we're within its show window, use it
            if (justFinishedTournament && now < justFinishedTournament.showUntil) {
                return justFinishedTournament;
            }
            // If ESPN is showing finished results from a different tournament, use emojiTournament for pick matching
            if (emojiTournament && espnTournamentInfo?.isFinished && 
                espnTournamentInfo.name !== upcomingTournament?.name) {
                return emojiTournament;
            }
            return upcomingTournament;
        }

        // TESTING MODE: Set to true to allow picks even after tournament starts
        const ALLOW_LATE_PICKS = false; // Production mode - picks lock at tournament start

        // Check if tournament has started (picks should be locked)
        function hasTournamentStarted() {
            if (ALLOW_LATE_PICKS) return false; // Bypass for testing
            return new Date() >= currentTournament.startTime;
        }

        // Check if pick window is open for current tournament
        function isPickWindowOpen() {
            if (ALLOW_LATE_PICKS) return true; // Bypass for testing
            const now = new Date();
            return now >= currentTournament.pickWindowOpen && now < currentTournament.startTime;
        }

        // Check if pick window is open for next tournament
        function isNextPickWindowOpen() {
            if (ALLOW_LATE_PICKS) return false; // Only show next when testing is off
            const now = new Date();
            return now >= nextTournament.pickWindowOpen && now < nextTournament.startTime;
        }

        // Get the tournament user should be picking for
        function getActiveTournamentForPicks() {
            if (isPickWindowOpen()) {
                return currentTournament;
            } else if (isNextPickWindowOpen()) {
                return nextTournament;
            }
            return null; // No pick window open
        }

        // Format date for display
        function formatPickWindowTime(date) {
            return date.toLocaleString('en-GB', { 
                weekday: 'short', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZoneName: 'short'
            });
        }

        // ESPN API configuration
        const ESPN_API_URL = 'https://site.web.api.espn.com/apis/site/v2/sports/golf/leaderboard?league=pga';
        const ESPN_CHAMPIONS_API_URL = 'https://site.web.api.espn.com/apis/site/v2/sports/golf/leaderboard?league=champions-tour';
        const ESPN_LIV_API_URL = 'https://site.web.api.espn.com/apis/site/v2/sports/golf/leaderboard?league=liv';
        
        // Get ESPN API URL for the pool's tour
        function getESPNApiUrl(tour) {
            if (tour === 'champions') {
                return ESPN_CHAMPIONS_API_URL;
            }
            if (tour === 'liv') {
                return ESPN_LIV_API_URL;
            }
            return ESPN_API_URL; // Default to PGA
        }

        // Purse payout percentages (based on PGA Tour standard)
        const PURSE_PAYOUTS = {
            1: 0.18, 2: 0.109, 3: 0.069, 4: 0.049, 5: 0.041,
            6: 0.0363, 7: 0.0338, 8: 0.0313, 9: 0.0293, 10: 0.0273,
            11: 0.0253, 12: 0.0233, 13: 0.0213, 14: 0.0193, 15: 0.0183,
            16: 0.0173, 17: 0.0163, 18: 0.0153, 19: 0.0143, 20: 0.0133,
            21: 0.0123, 22: 0.0113, 23: 0.0105, 24: 0.0097, 25: 0.0089,
            26: 0.0081, 27: 0.0078, 28: 0.0075, 29: 0.0072, 30: 0.0069,
            31: 0.0066, 32: 0.0063, 33: 0.006, 34: 0.0057, 35: 0.0055,
            36: 0.0052, 37: 0.005, 38: 0.0048, 39: 0.0046, 40: 0.0044,
            41: 0.0042, 42: 0.004, 43: 0.0038, 44: 0.0036, 45: 0.0034,
            46: 0.0032, 47: 0.003, 48: 0.0028, 49: 0.0027, 50: 0.0026,
            51: 0.0025, 52: 0.0025, 53: 0.0024, 54: 0.0024, 55: 0.0024,
            56: 0.0023, 57: 0.0023, 58: 0.0023, 59: 0.0023, 60: 0.0023,
            61: 0.0022, 62: 0.0022, 63: 0.0022, 64: 0.0022, 65: 0.0022,
            // Extended for "top 65 and ties" cut rule
            66: 0.0021, 67: 0.0021, 68: 0.0021, 69: 0.0021, 70: 0.0021,
            71: 0.0020, 72: 0.0020, 73: 0.0020, 74: 0.0020, 75: 0.0020,
            76: 0.0019, 77: 0.0019, 78: 0.0019, 79: 0.0019, 80: 0.0019,
            81: 0.0018, 82: 0.0018, 83: 0.0018, 84: 0.0018, 85: 0.0018,
            86: 0.0017, 87: 0.0017, 88: 0.0017, 89: 0.0017, 90: 0.0017
        };

        // LIV Golf purse payout percentages (based on $20M individual purse)
        // All 57 players get paid - no cut
        const LIV_PURSE_PAYOUTS = {
            1: 0.20, 2: 0.1125, 3: 0.075, 4: 0.05, 5: 0.04,
            6: 0.035, 7: 0.03, 8: 0.02625, 9: 0.0225, 10: 0.02075,
            11: 0.019, 12: 0.018, 13: 0.017, 14: 0.016, 15: 0.015,
            16: 0.01425, 17: 0.0135, 18: 0.013, 19: 0.0125, 20: 0.012,
            21: 0.0115, 22: 0.011, 23: 0.0105, 24: 0.01, 25: 0.00975,
            26: 0.0095, 27: 0.00925, 28: 0.009, 29: 0.00875, 30: 0.0085,
            31: 0.00825, 32: 0.008, 33: 0.00775, 34: 0.0075, 35: 0.007375,
            36: 0.00725, 37: 0.007125, 38: 0.007, 39: 0.006875, 40: 0.00675,
            41: 0.006625, 42: 0.0065, 43: 0.00645, 44: 0.0064, 45: 0.00635,
            46: 0.0063, 47: 0.0025, 48: 0.0025, 49: 0.0025, 50: 0.0025,
            51: 0.0025, 52: 0.0025, 53: 0.0025, 54: 0.0025, 55: 0.0025,
            56: 0.0025, 57: 0.0025
        };
        
        // Get payout table based on tour
        function getPayoutTable(tour) {
            return tour === 'liv' ? LIV_PURSE_PAYOUTS : PURSE_PAYOUTS;
        }

        function calculateProjectedEarnings(position, purse, tour = 'pga') {
            if (!position || position === '-' || position === 'WD' || position === 'CUT' || position === 'MC') return 0;
            const posNum = parseInt(position.replace('T', ''));
            const payoutTable = getPayoutTable(tour);
            const maxPos = tour === 'liv' ? 57 : 90;
            if (isNaN(posNum) || posNum > maxPos) return 0;
            const defaultPct = tour === 'liv' ? 0.0025 : 0.0017;
            const pct = payoutTable[posNum] || defaultPct;
            return Math.round(purse * pct);
        }

        // Calculate tie-adjusted earnings for all players in leaderboard
        // For T players tied at position N: sum payouts for N through N+T-1, divide by T
        function calculateTieAdjustedEarnings(leaderboard, purse, tour = 'pga') {
            if (!leaderboard || leaderboard.length === 0) return;
            if (!purse || purse <= 0) {
                console.warn('No purse value for earnings calculation');
                // Set all earnings to 0 if no purse
                leaderboard.forEach(p => p.projectedEarnings = 0);
                return;
            }
            
            const payoutTable = getPayoutTable(tour);
            const maxPos = tour === 'liv' ? 57 : 90;
            const defaultPct = tour === 'liv' ? 0.0025 : 0.0017;
            
            // Group players by position (e.g., all "T2" players together)
            const positionGroups = {};
            leaderboard.forEach(player => {
                const pos = player.pos;
                if (!pos || pos === '-' || pos === 'WD' || pos === 'CUT' || pos === 'MC') {
                    player.projectedEarnings = 0;
                    return;
                }
                if (!positionGroups[pos]) {
                    positionGroups[pos] = [];
                }
                positionGroups[pos].push(player);
            });
            
            // Calculate tie-adjusted earnings for each group
            Object.entries(positionGroups).forEach(([pos, players]) => {
                const posNum = parseInt(pos.replace('T', ''));
                if (isNaN(posNum) || posNum > maxPos) {
                    players.forEach(p => p.projectedEarnings = 0);
                    return;
                }
                
                // HYBRID RULE: 1st place always gets full winner's share (playoff decides winner)
                // All other positions use tie-split logic
                if (posNum === 1) {
                    const earnings = Math.round(purse * payoutTable[1]);
                    players.forEach(p => p.projectedEarnings = earnings);
                    return;
                }
                
                const numTied = players.length;
                
                // Sum payouts for positions posNum through posNum + numTied - 1
                let totalPayout = 0;
                for (let i = 0; i < numTied; i++) {
                    const payoutPos = posNum + i;
                    if (payoutPos <= maxPos) {
                        totalPayout += (payoutTable[payoutPos] || defaultPct);
                    }
                }
                
                // Each tied player gets equal share
                const perPlayerPayout = totalPayout / numTied;
                const earnings = Math.round(purse * perPlayerPayout);
                
                players.forEach(p => p.projectedEarnings = earnings);
            });
        }

        // Live leaderboard data from ESPN
        let liveLeaderboard = [];
        let espnDataLoaded = false;

        // Fetch live leaderboard from ESPN API
        let espnTournamentInfo = null; // Store ESPN tournament details
        
        async function fetchESPNLeaderboard() {
            try {
                const apiUrl = getESPNApiUrl(currentPoolTour);
                console.log(`Fetching ESPN leaderboard for ${currentPoolTour} tour...`);
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('ESPN API request failed');
                
                const data = await response.json();
                
                if (!data.events || !data.events[0] || !data.events[0].competitions) {
                    throw new Error('Invalid ESPN data structure');
                }

                const event = data.events[0];
                const competition = event.competitions[0];
                
                // Check if tournament is finished
                const tournamentStatus = competition.status?.type?.name || '';
                const isFinished = tournamentStatus === 'STATUS_FINAL' || tournamentStatus === 'STATUS_FINISH';
                
                // Store ESPN tournament info for display purposes
                espnTournamentInfo = {
                    name: event.name || event.shortName || 'Tournament',
                    status: tournamentStatus,
                    isFinished: isFinished,
                    round: competition.status?.period || 4
                };
                
                // Update tournament info
                if (currentTournament) {
                    // Only update purse from ESPN if it's provided AND non-zero
                    // BUT NOT for LIV - ESPN reports total purse ($30M) but we need individual purse ($20M)
                    if (event.purse && event.purse > 0 && currentPoolTour !== 'liv') {
                        currentTournament.purse = event.purse;
                    }
                    if (competition.status && competition.status.period) {
                        currentTournament.round = competition.status.period;
                    }
                }

                // Build leaderboard from competitors
                liveLeaderboard = [];
                const competitors = competition.competitors || [];
                
                // Sort by position
                competitors.sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999));
                
                // Track if ESPN provides actual earnings
                let hasActualEarnings = false;

                competitors.forEach(comp => {
                    const athlete = comp.athlete || {};
                    const status = comp.status || {};
                    const position = status.position ? status.position.displayName : '-';
                    const scoreToPar = comp.statistics ? comp.statistics.find(s => s.name === 'scoreToPar') : null;
                    
                    // Parse today's score from todayDetail (e.g., "-6(14)" or "E(F)")
                    let todayScore = 0;
                    if (status.todayDetail) {
                        const match = status.todayDetail.match(/^([+-]?\d+|E)/);
                        if (match) {
                            todayScore = match[1] === 'E' ? 0 : parseInt(match[1]);
                        }
                    }

                    // Transform ESPN headshot URL to optimized size
                    let headshot = null;
                    if (athlete.headshot && athlete.headshot.href) {
                        const originalUrl = athlete.headshot.href;
                        if (originalUrl.includes('a.espncdn.com/i/')) {
                            const path = originalUrl.replace('https://a.espncdn.com', '');
                            headshot = `https://a.espncdn.com/combiner/i?img=${path}&w=96&h=96&scale=crop&cquality=80`;
                        } else {
                            headshot = originalUrl;
                        }
                    }
                    
                    // Use ACTUAL earnings from ESPN if available AND meaningful (tournament finished)
                    let earnings = 0;
                    if (comp.earnings !== undefined && comp.earnings !== null && comp.earnings > 0) {
                        earnings = Math.round(comp.earnings);
                        hasActualEarnings = true;
                    }

                    liveLeaderboard.push({
                        playerId: athlete.id || comp.id,
                        playerName: athlete.displayName || 'Unknown',
                        pos: position,
                        score: scoreToPar ? scoreToPar.value : 0,
                        today: todayScore,
                        thru: status.displayThru || status.thru || '-',
                        projectedEarnings: earnings, // Will be recalculated if no actual earnings
                        headshot: headshot,
                        flag: athlete.flag ? athlete.flag.href : null
                    });
                });

                // Validate hasActualEarnings - need at least some players with non-zero earnings
                const playersWithEarnings = liveLeaderboard.filter(p => p.projectedEarnings > 0).length;
                const meaningfulEarnings = hasActualEarnings && playersWithEarnings >= 3;
                
                // If no actual meaningful earnings from ESPN, calculate tie-adjusted projected earnings
                if (!meaningfulEarnings) {
                    const purse = currentTournament?.purse || 0;
                    console.log(`Calculating projected earnings for ${currentPoolTour} tour, purse: ${purse}`);
                    calculateTieAdjustedEarnings(liveLeaderboard, purse, currentPoolTour);
                    console.log('Using calculated projected earnings (tournament in progress or ESPN earnings invalid)');
                    // Log sample earnings for debugging
                    if (liveLeaderboard.length > 0) {
                        console.log('Sample projected earnings:', liveLeaderboard.slice(0, 3).map(p => ({
                            name: p.playerName,
                            pos: p.pos,
                            earnings: p.projectedEarnings
                        })));
                    }
                } else {
                    console.log(`Using actual ESPN earnings (tournament finished, ${playersWithEarnings} players with earnings)`);
                }

                espnDataLoaded = true;
                console.log(`ESPN leaderboard loaded for ${currentPoolTour}:`, liveLeaderboard.length, 'players');
                return liveLeaderboard;

            } catch (error) {
                console.error('Error fetching ESPN leaderboard:', error);
                espnDataLoaded = false;
                return null;
            }
        }

        // Tournament logos and data (from PGA Tour schedule)
        const tournamentLogos = {
            "sony2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R006.png",
            "amex2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R002.png",
            "farmers2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R004.png",
            "atandt2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R054.png",
            "wmphoenix2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R003.png",
            "genesis2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R011.png",
            // Handle hyphenated IDs from database
            "sony-2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R006.png",
            "amex-2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R002.png",
            "farmers-2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R004.png",
            "atandt-2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R054.png",
            "wmphoenix-2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R003.png",
            "genesis-2026": "https://res.cloudinary.com/pgatour-prod/d_tournaments:logos:R000.png/tournaments/logos/R011.png",
            // LIV Golf 2026 (circular event badges)
            "liv-riyadh-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/prd/yjxwjdurbtzbur4ui2zx",
            "liv-adelaide-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/prd/lgnko2xhixoies9ntdnl",
            "liv-hongkong-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/v1763664867/prd/ieqzcq5kyuqinxpl6yho",
            "liv-singapore-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/prd/wuhxhp2sut57kjfctohe",
            "liv-southafrica-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/v1769094838/prd/oj20ndnsxola5jywfczj",
            "liv-mexico-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/prd/r9slom6vzq1ca1k1s0zz",
            "liv-virginia-2026": null,
            "liv-andalucia-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/prd/ckrjsaz3aahvjeupyacp",
            "liv-louisiana-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/v1763672445/prd/oszzlzu8bdbosno7ho3f",
            "liv-uk-2026": null,
            "liv-newyork-2026": null,
            "liv-indianapolis-2026": "https://images.livgolf.com/image/private/t_ratio1_1-size60-f_webp-c_fill/v1769459214/prd/lgkubuo4livlbw88cvsp"
        };
        
        // Tournament name lookup (handles both formats)
        const tournamentNames = {
            "sony2026": "Sony Open",
            "amex2026": "The American Express",
            "farmers2026": "Farmers Insurance Open",
            "atandt2026": "AT&T Pebble Beach",
            "wmphoenix2026": "WM Phoenix Open",
            "genesis2026": "Genesis Invitational",
            // Hyphenated versions
            "sony-2026": "Sony Open",
            "amex-2026": "The American Express", 
            "farmers-2026": "Farmers Insurance Open",
            "atandt-2026": "AT&T Pebble Beach",
            "wmphoenix-2026": "WM Phoenix Open",
            "genesis-2026": "Genesis Invitational",
            // LIV Golf 2026
            "liv-riyadh-2026": "LIV Golf Riyadh",
            "liv-adelaide-2026": "LIV Golf Adelaide",
            "liv-hongkong-2026": "LIV Golf Hong Kong",
            "liv-singapore-2026": "LIV Golf Singapore",
            "liv-southafrica-2026": "LIV Golf South Africa",
            "liv-mexico-2026": "LIV Golf Mexico City",
            "liv-virginia-2026": "LIV Golf Virginia",
            "liv-andalucia-2026": "LIV Golf Andaluca",
            "liv-louisiana-2026": "LIV Golf Louisiana",
            "liv-uk-2026": "LIV Golf United Kingdom",
            "liv-newyork-2026": "LIV Golf New York",
            "liv-indianapolis-2026": "LIV Golf Indianapolis"
        };

// Auto-populate tournamentNames from all schedules so history always shows official names
        pga2026Schedule.forEach(t => {
            if (!tournamentNames[t.id]) {
                tournamentNames[t.id] = t.name;
            }
        });
        champions2026Schedule.forEach(t => {
            if (!tournamentNames[t.id]) {
                tournamentNames[t.id] = t.name;
            }
        });
        liv2026Schedule.forEach(t => {
            if (!tournamentNames[t.id]) {
                tournamentNames[t.id] = t.name;
            }
        });

        // 2026 PGA Tour Schedule (upcoming tournaments)
        const upcomingSchedule = [
            {
                id: "farmers2026",
                name: "Farmers Insurance Open",
                dates: "Jan 29 - Feb 1",
                week: 3,
                course: "Torrey Pines GC (South)",
                location: "San Diego, CA",
                purse: 9600000,
                previousWinner: "Harris English",
                previousWinnings: 1674000
            },
            {
                id: "atandt2026",
                name: "AT&T Pebble Beach Pro-Am",
                dates: "Feb 5 - 8",
                week: 4,
                course: "Pebble Beach GL",
                location: "Pebble Beach, CA",
                purse: 20000000,
                previousWinner: "Wyndham Clark",
                previousWinnings: 3600000
            },
            {
                id: "wmphoenix2026",
                name: "WM Phoenix Open",
                dates: "Feb 12 - 15",
                week: 5,
                course: "TPC Scottsdale",
                location: "Scottsdale, AZ",
                purse: 20000000,
                previousWinner: "Scottie Scheffler",
                previousWinnings: 3600000
            },
            {
                id: "genesis2026",
                name: "The Genesis Invitational",
                dates: "Feb 19 - 22",
                week: 6,
                course: "Riviera CC",
                location: "Pacific Palisades, CA",
                purse: 20000000,
                previousWinner: "Hideki Matsuyama",
                previousWinnings: 4000000
            }
        ];

        // PGA Tour player photo URL helper - uses ESPN player IDs
        // Format: https://a.espncdn.com/combiner/i?img=/i/headshots/golf/players/full/{espnId}.png&w=96&h=96&scale=crop
        // Using combiner endpoint for resized images (better quality at small sizes)
        function getPlayerPhoto(espnId) {
            return `https://a.espncdn.com/combiner/i?img=/i/headshots/golf/players/full/${espnId}.png&w=96&h=96&scale=crop&cquality=80`;
        }

        // Tournament field - fetched from Supabase or fallback to hardcoded
        // Run scrape_field.py to update the field in Supabase
        
        // Full fallback field data - Farmers Insurance Open 2026 (147 players)
        const fallbackField = [
            { id: "9780", name: "Ludvig berg", country: "SWE", rank: 18 },
            { id: "10230", name: "Xander Schauffele", country: "USA", rank: 4 },
            { id: "10139", name: "Christiaan Bezuidenhout", country: "RSA", rank: 82 },
            { id: "10424", name: "Akshay Bhatia", country: "USA", rank: 52 },
            { id: "9973", name: "Keegan Bradley", country: "USA", rank: 16 },
            { id: "10591", name: "Dan Brown", country: "ENG", rank: 67 },
            { id: "6007", name: "Patrick Cantlay", country: "USA", rank: 7 },
            { id: "4847213", name: "Luke Clanton", country: "USA", rank: 150 },
            { id: "11119", name: "Wyndham Clark", country: "USA", rank: 8 },
            { id: "10522", name: "Eric Cole", country: "USA", rank: 56 },
            { id: "4837368", name: "Pierceson Coody", country: "USA", rank: 89 },
            { id: "10863", name: "Cam Davis", country: "AUS", rank: 63 },
            { id: "1680", name: "Jason Day", country: "AUS", rank: 26 },
            { id: "5408", name: "Harris English", country: "USA", rank: 11 },
            { id: "2230", name: "Tony Finau", country: "USA", rank: 17 },
            { id: "5162", name: "Chris Gotterup", country: "USA", rank: 105 },
            { id: "10890", name: "Max Greyserman", country: "USA", rank: 120 },
            { id: "9567", name: "Emiliano Grillo", country: "ARG", rank: 95 },
            { id: "4361187", name: "Lee Hodges", country: "USA", rank: 90 },
            { id: "4686087", name: "Rico Hoey", country: "PHI", rank: 150 },
            { id: "6086", name: "Tom Hoge", country: "USA", rank: 71 },
            { id: "11253", name: "Nicolai Hjgaard", country: "DEN", rank: 45 },
            { id: "11254", name: "Rasmus Hjgaard", country: "DEN", rank: 55 },
            { id: "8973", name: "Max Homa", country: "USA", rank: 13 },
            { id: "1651", name: "Billy Horschel", country: "USA", rank: 95 },
            { id: "6011", name: "Beau Hossler", country: "USA", rank: 100 },
            { id: "9179", name: "Mackenzie Hughes", country: "CAN", rank: 85 },
            { id: "9424", name: "Stephan Jaeger", country: "GER", rank: 75 },
            { id: "7081", name: "Si Woo Kim", country: "KOR", rank: 75 },
            { id: "4602673", name: "Tom Kim", country: "KOR", rank: 29 },
            { id: "5430", name: "Brooks Koepka", country: "USA", rank: 33 },
            { id: "3625", name: "Matt Kuchar", country: "USA", rank: 140 },
            { id: "9221", name: "Haotong Li", country: "CHN", rank: 69 },
            { id: "9037", name: "Luke List", country: "USA", rank: 73 },
            { id: "4585", name: "Hideki Matsuyama", country: "JPN", rank: 5 },
            { id: "9191", name: "Denny McCarthy", country: "USA", rank: 80 },
            { id: "4901368", name: "Matt McCarty", country: "USA", rank: 91 },
            { id: "8906", name: "Keith Mitchell", country: "USA", rank: 85 },
            { id: "10664", name: "Taylor Moore", country: "USA", rank: 95 },
            { id: "3832", name: "Alex Noren", country: "SWE", rank: 88 },
            { id: "10596", name: "Matthieu Pavon", country: "FRA", rank: 41 },
            { id: "9658", name: "Taylor Pendrith", country: "CAN", rank: 78 },
            { id: "6001", name: "Seamus Power", country: "IRL", rank: 65 },
            { id: "9611", name: "Andrew Putnam", country: "USA", rank: 100 },
            { id: "10603", name: "Aaron Rai", country: "ENG", rank: 60 },
            { id: "10425", name: "Davis Riley", country: "USA", rank: 70 },
            { id: "3702", name: "Justin Rose", country: "ENG", rank: 10 },
            { id: "388", name: "Adam Scott", country: "AUS", rank: 28 },
            { id: "9506", name: "Jordan Smith", country: "ENG", rank: 78 },
            { id: "7631", name: "Brandt Snedeker", country: "USA", rank: 200 },
            { id: "4589", name: "J.J. Spaun", country: "USA", rank: 50 },
            { id: "4426181", name: "Sam Stevens", country: "USA", rank: 110 },
            { id: "3988", name: "Kevin Streelman", country: "USA", rank: 130 },
            { id: "10980", name: "Sahith Theegala", country: "USA", rank: 14 },
            { id: "4375304", name: "Davis Thompson", country: "USA", rank: 65 },
            { id: "4364876", name: "Michael Thorbjornsen", country: "USA", rank: 95 },
            { id: "9364", name: "Erik van Rooyen", country: "RSA", rank: 80 },
            { id: "10548", name: "Matt Wallace", country: "ENG", rank: 93 },
            { id: "10216", name: "Vince Whaley", country: "USA", rank: 115 },
            { id: "3550", name: "Gary Woodland", country: "USA", rank: 130 },
            { id: "4423323", name: "Dylan Wu", country: "USA", rank: 100 },
            { id: "9766", name: "Cameron Young", country: "USA", rank: 43 },
            { id: "10093", name: "Kevin Yu", country: "TPE", rank: 85 },
            { id: "9877", name: "Will Zalatoris", country: "USA", rank: 24 }
        ];
        
        // Start with fallback field (will be replaced by Supabase data if available)
        let tournamentField = [...fallbackField];
        let fieldLoaded = true;

        // Fetch tournament field from Supabase
        async function fetchTournamentField(tournamentId, tour = 'pga') {
            // For LIV Golf, fetch from DataGolf API
            if (tour === 'liv') {
                console.log('Fetching LIV Golf field from DataGolf API');
                try {
                    const response = await fetch('https://feeds.datagolf.com/preds/pre-tournament?tour=alt&file_format=json&key=92ca1f66aca56167b4f6e780a6de');
                    const data = await response.json();
                    
                    if (data && data.baseline && data.baseline.length > 0) {
                        console.log(`Loaded ${data.baseline.length} players from DataGolf API`);
                        
                        // Map players with team info from our lookup
                        tournamentField = data.baseline.map((p, idx) => {
                            // Convert "Last, First" to "First Last"
                            let name = p.player_name || '';
                            if (name.includes(',')) {
                                const parts = name.split(',').map(s => s.trim());
                                name = `${parts[1]} ${parts[0]}`;
                            }
                            
                            // Look up team from our mapping
                            const team = livTeamMapping[p.dg_id] || 'Wildcard';
                            
                            return {
                                id: String(p.dg_id),
                                name: name,
                                country: p.country || '',
                                team: team,
                                rank: idx + 1, // Use win probability order as rank
                                winProb: p.win,
                                headshot: null // Will use fallback
                            };
                        });
                        fieldLoaded = true;
                        return;
                    }
                } catch (err) {
                    console.error('Error fetching from DataGolf API:', err);
                }
                
                // Fallback to hardcoded list
                console.log('Using fallback LIV Golf player field');
                tournamentField = livPlayerField.map(p => ({
                    id: p.id,
                    name: p.name,
                    country: p.country,
                    team: p.team,
                    rank: livPlayerField.indexOf(p) + 1,
                    headshot: `https://a.espncdn.com/combiner/i?img=/i/headshots/golf/players/full/${p.id}.png&w=80&h=58&scale=crop`
                }));
                fieldLoaded = true;
                return;
            }
            
            if (!supabaseClient) {
                console.log('No Supabase client, using fallback field');
                tournamentField = fallbackField;
                fieldLoaded = true;
                return;
            }

            try {
                console.log(`Fetching field for tournament: ${tournamentId}`);
                const result = await callAPI('get-tournament-field', { tournamentId });
                const data = result.data;

                if (!data || data.length === 0) {
                    console.error('No field data returned');
                    tournamentField = fallbackField;
                } else if (data.length > 0) {
                    console.log(`Loaded ${data.length} players from Supabase`);
                    tournamentField = data.map(p => {
                        // Fix player name - convert "Last, First" to "First Last"
                        let name = p.player_name || '';
                        if (name.includes(',')) {
                            const parts = name.split(',').map(s => s.trim());
                            name = `${parts[1]} ${parts[0]}`;
                        }
                        
                        // Fix headshot URL - replace placeholders with actual sizes
                        let headshot = p.headshot_url || null;
                        if (headshot) {
                            headshot = headshot
                                .replace('${HEIGHT}', '160')
                                .replace('${WIDTH}', '160')
                                .replace(/\$\{HEIGHT\}/g, '160')
                                .replace(/\$\{WIDTH\}/g, '160');
                        }
                        
                        return {
                            id: p.player_id,
                            name: name,
                            country: p.country || '',
                            rank: p.owgr || 999,
                            headshot: headshot
                        };
                    });
                } else {
                    console.log('No field data in Supabase, using fallback');
                    tournamentField = fallbackField;
                }
            } catch (err) {
                console.error('Error fetching field:', err);
                tournamentField = fallbackField;
            }
            
            fieldLoaded = true;
        }

        // Get player headshot URL - use Supabase data if available, else PGA Tour CDN
        function getPlayerHeadshot(player) {
            if (player.headshot) {
                return player.headshot;
            }
            // Fallback to PGA Tour CDN format
            return `https://pga-tour-res.cloudinary.com/image/upload/c_thumb,g_face,z_0.7,q_auto,f_auto,dpr_2.0,w_80,h_80,b_rgb:F2F2F2/headshots_${player.id}`;
        }

        // Enrich tournament field with world rankings (fallback if Supabase data doesn't have ranks)
        // OWGR data - Xander Schauffele is highest ranked at #4
        // Scottie Scheffler (#1), Rory (#2), Rahm (#3) are NOT playing
        const additionalRankings = {
            // Top 10 in field
            "10230": 4,     // Xander Schauffele
            "4585": 5,      // Hideki Matsuyama
            "6007": 7,      // Patrick Cantlay
            "11119": 8,     // Wyndham Clark
            "3702": 10,     // Justin Rose
            "5408": 11,     // Harris English
            "8973": 13,     // Max Homa
            "10980": 14,    // Sahith Theegala
            "9973": 16,     // Keegan Bradley
            "2230": 17,     // Tony Finau
            "9780": 18,     // Ludvig berg
            // 20-50
            "9349": 21,     // Sepp Straka (not in field actually)
            "9877": 24,     // Will Zalatoris
            "1680": 26,     // Jason Day
            "388": 28,      // Adam Scott
            "4602673": 29,  // Tom Kim
            "5430": 33,     // Brooks Koepka
            "10592": 35,    // Thomas Detry (not in field)
            "10596": 41,    // Matthieu Pavon
            "9766": 43,     // Cameron Young
            "10424": 52,    // Akshay Bhatia
            "4698579": 55,  // S.H. Kim
            // 50-100
            "10522": 56,    // Eric Cole
            "4410932": 61,  // Min Woo Lee (not in field)
            "10863": 63,    // Cam Davis
            "4375304": 65,  // Davis Thompson
            "10591": 67,    // Dan Brown
            "9221": 69,     // Haotong Li
            "6086": 71,     // Tom Hoge
            "9037": 73,     // Luke List
            "7081": 75,     // Si Woo Kim
            "9506": 78,     // Jordan Smith
            "10139": 82,    // Christiaan Bezuidenhout
            "4837368": 89,  // Pierceson Coody
            "4361187": 90,  // Lee Hodges
            "4901368": 91,  // Matt McCarty
            "10548": 93,    // Matt Wallace
            "1651": 95,     // Billy Horschel
            "10664": 95,    // Taylor Moore
            "6011": 100,    // Beau Hossler
            "5162": 105,    // Chris Gotterup
            // 100+
            "4426181": 110, // Sam Stevens
            "11332": 115,   // Andrew Novak
            "4361914": 119, // Chandler Blanchet
            "4832046": 125, // Nick Dunlap (not in field)
            "3550": 130,    // Gary Woodland
            "4686087": 150, // Rico Hoey
            "2296": 180,    // Charley Hoffman
            "7631": 200,    // Brandt Snedeker
            "10030": 202,   // Zach Bauchou
        };

        // Add rank to each player in tournamentField
        tournamentField.forEach(player => {
            const pgaPlayer = pgaPlayers.find(p => p.id === player.id);
            if (pgaPlayer && pgaPlayer.rank) {
                player.rank = pgaPlayer.rank;
            } else if (additionalRankings[player.id]) {
                player.rank = additionalRankings[player.id];
            } else {
                player.rank = 200; // Default for unranked players
            }
        });

        // Mock leaderboard - actual R1 results from ESPN (Jan 23, 2026)
        // Complete leaderboard so any pick can be tracked
        const mockLeaderboard = [
            // American Express 2026 - Final Results (Sunday Jan 26)
            // 1st: Scottie Scheffler -27
            { playerId: "9478", pos: "1", score: -27, today: "E", thru: 18, round1: 64, projectedEarnings: 1656000 },
            // T2: -23
            { playerId: "1680", pos: "T2", score: -23, today: "E", thru: 18, round1: 65, projectedEarnings: 1002800 },  // Jason Day
            { playerId: "11084", pos: "T2", score: -23, today: "E", thru: 18, round1: 65, projectedEarnings: 1002800 }, // Ryan Gerard
            { playerId: "10522", pos: "T2", score: -23, today: "E", thru: 18, round1: 65, projectedEarnings: 1002800 }, // Eric Cole
            { playerId: "11119", pos: "T2", score: -23, today: "E", thru: 18, round1: 65, projectedEarnings: 1002800 }, // Wyndham Clark  
            { playerId: "4854714", pos: "T2", score: -23, today: "E", thru: 18, round1: 65, projectedEarnings: 1002800 }, // Blades Brown
            // T6: -22
            { playerId: "7081", pos: "T6", score: -22, today: "E", thru: 18, round1: 66, projectedEarnings: 333960 },   // Si Woo Kim
            { playerId: "4837368", pos: "T6", score: -22, today: "E", thru: 18, round1: 66, projectedEarnings: 333960 }, // Pierceson Coody
            // T8: -21  
            { playerId: "10980", pos: "T8", score: -21, today: "E", thru: 18, round1: 67, projectedEarnings: 287960 },  // Sahith Theegala
            { playerId: "5409", pos: "T8", score: -21, today: "E", thru: 18, round1: 67, projectedEarnings: 287960 },   // Russell Henley
            { playerId: "6086", pos: "T8", score: -21, today: "E", thru: 18, round1: 67, projectedEarnings: 287960 },   // Tom Hoge
            { playerId: "9221", pos: "T8", score: -21, today: "E", thru: 18, round1: 67, projectedEarnings: 250700 },   // Haotong Li
            // T12: -20
            { playerId: "8973", pos: "T12", score: -20, today: "E", thru: 18, round1: 68, projectedEarnings: 213900 },  // Max Homa
            { playerId: "6007", pos: "T12", score: -20, today: "E", thru: 18, round1: 68, projectedEarnings: 213900 },  // Patrick Cantlay
            { playerId: "4602673", pos: "T12", score: -20, today: "E", thru: 18, round1: 68, projectedEarnings: 213900 }, // Tom Kim
            // T15: -19
            { playerId: "5408", pos: "T15", score: -19, today: "E", thru: 18, round1: 69, projectedEarnings: 175000 },  // Harris English
            { playerId: "9877", pos: "T15", score: -19, today: "E", thru: 18, round1: 69, projectedEarnings: 175000 },  // Will Zalatoris
            { playerId: "2230", pos: "T15", score: -19, today: "E", thru: 18, round1: 69, projectedEarnings: 175000 },  // Tony Finau
            // T18: -18
            { playerId: "388", pos: "T18", score: -18, today: "E", thru: 18, round1: 70, projectedEarnings: 140000 },   // Adam Scott
            { playerId: "3702", pos: "T18", score: -18, today: "E", thru: 18, round1: 70, projectedEarnings: 140000 },  // Justin Rose
            // T20: -17
            { playerId: "9973", pos: "T20", score: -17, today: "E", thru: 18, round1: 71, projectedEarnings: 121900 },  // Keegan Bradley
            { playerId: "10596", pos: "T20", score: -17, today: "E", thru: 18, round1: 71, projectedEarnings: 121900 }, // Matthieu Pavon
            { playerId: "1651", pos: "T20", score: -17, today: "E", thru: 18, round1: 71, projectedEarnings: 121900 },  // Billy Horschel
            // Additional players for lookup
            { playerId: "4585", pos: "T25", score: -16, today: "E", thru: 18, round1: 72, projectedEarnings: 95000 },   // Hideki Matsuyama
            { playerId: "9780", pos: "T25", score: -16, today: "E", thru: 18, round1: 72, projectedEarnings: 95000 },   // Ludvig berg
            { playerId: "10230", pos: "T25", score: -16, today: "E", thru: 18, round1: 72, projectedEarnings: 95000 },  // Xander Schauffele
            { playerId: "3550", pos: "T30", score: -15, today: "E", thru: 18, round1: 73, projectedEarnings: 63020 },   // Gary Woodland
        ];

        // Payout structure (approximate based on typical PGA purse distribution)
        const payoutStructure = {
            1: 0.18, 2: 0.109, 3: 0.069, 4: 0.049, 5: 0.041,
            6: 0.0365, 7: 0.034, 8: 0.0315, 9: 0.029, 10: 0.027,
            11: 0.025, 12: 0.023, 13: 0.021, 14: 0.019, 15: 0.017
        };

        // Historical players (from past tournaments this season, not in current field)
        // This ensures we can look up players who were picked in previous weeks
        const historicalPlayers = [
            // American Express 2026 players (for leaderboard display)
            { id: "9478", name: "Scottie Scheffler", country: "USA", rank: 1 },
            { id: "11084", name: "Ryan Gerard", country: "USA", rank: 120 },
            { id: "4854714", name: "Blades Brown", country: "USA", rank: 125 },
            { id: "4901368", name: "Matt McCarty", country: "USA", rank: 91 },
            // Sony Open notables 
            { id: "11515", name: "Chris Gotterup", country: "USA" },
        ];

        // Combine all player sources for lookup - use function to get latest data
        function getAllPlayers() {
            return [...tournamentField, ...pgaPlayers, ...historicalPlayers];
        }

        // Helper function to find player by ID and add photo URL
        function getPlayerById(playerId) {
            // Convert to string for consistent comparison
            const pid = String(playerId);
            const allPlayers = getAllPlayers();
            const player = allPlayers.find(p => String(p.id) === pid);
            if (player) {
                return {
                    ...player,
                    photo: getPlayerPhoto(player.id)
                };
            }
            console.warn('Player not found:', playerId);
            return { id: playerId, name: 'Unknown Player', country: '', photo: '' };
        }

        // ==================== STATE ====================
        let currentPoolId = null;
        let selectedPlayerId = null;
        let inviteEmails = [];

        // ==================== UTILITY FUNCTIONS ====================
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function formatCurrency(amount) {
            if (amount === undefined || amount === null || isNaN(amount)) {
                return '$0';
            }
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(amount);
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;
            toast.classList.toggle('error', isError);
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // ==================== NAVIGATION ====================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(screenId);
            if (screen) {
                screen.classList.add('active');
            } else {
                console.error('Screen not found:', screenId);
                return;
            }

            if (screenId === 'dashboard') {
                try {
                    renderDashboard();
                } catch (e) {
                    console.error('Error rendering dashboard:', e);
                }
            }
        }

        function updateNavigation() {
            const guestNav = document.getElementById('nav-guest');
            const userNav = document.getElementById('nav-user');

            if (store.currentUser) {
                guestNav.style.display = 'none';
                userNav.style.display = 'flex';
                document.getElementById('user-display-name').textContent = store.currentUser.name;
                // Update nav profile picture
                updateNavProfilePicture();
            } else {
                guestNav.style.display = 'flex';
                userNav.style.display = 'none';
            }
        }

        // ==================== AUTH ====================
        async function handleSignup(event) {
            event.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value.toLowerCase();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;

            if (password !== confirm) {
                showToast('Passwords do not match', true);
                return;
            }

            if (password.length < 6) {
                showToast('Password must be at least 6 characters', true);
                return;
            }

            try {
                if (supabaseClient) {
                    // Use Supabase auth - onAuthStateChange will handle the rest
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: { data: { name } }
                    });
                    if (error) throw error;
                    
                    showToast('Account created! Check your email to confirm.');
                    // onAuthStateChange listener will call setUserFromSession
                } else {
                    // Fallback to local storage
                    if (store.users.find(u => u.email === email)) {
                        showToast('An account with this email already exists', true);
                        return;
                    }
                    const user = { id: generateId(), name, email, password };
                    store.users.push(user);
                    store.currentUser = user;
                    updateNavigation();
                    showToast('Account created successfully!');
                    showScreen('dashboard');
                    checkPendingJoinCode();
                }
            } catch (error) {
                showToast(error.message || 'Signup failed', true);
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value.toLowerCase();
            const password = document.getElementById('login-password').value;

            try {
                if (supabaseClient) {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });
                    if (error) throw error;
                    
                    // Hide forgot password link on successful login
                    document.getElementById('forgot-password-link').style.display = 'none';
                    
                    // Set user directly instead of waiting for onAuthStateChange
                    store.currentUser = {
                        id: data.user.id,
                        name: data.user.user_metadata?.name || email.split('@')[0],
                        email: email
                    };
                    
                    if (!store.users.find(u => u.id === data.user.id)) {
                        store.users.push(store.currentUser);
                    }
                    
                    console.log('Login successful, loading user data...');
                    await loadUserData();
                    // Fetch tournament field from Supabase using PGA Tour ID
                    await fetchTournamentField(currentTournament.fieldId || currentTournament.id, currentPoolTour);
                    console.log('User data loaded, updating nav...');
                    updateNavigation();
                    console.log('Showing dashboard...');
                    showToast('Welcome back!');
                    showScreen('dashboard');
                    console.log('Dashboard shown');
                    // Check if there's a pending pool to join
                    checkPendingJoinCode();
                } else {
                    // Fallback to local storage
                    const user = store.users.find(u => u.email === email && u.password === password);
                    if (!user) {
                        showToast('Invalid email or password', true);
                        document.getElementById('forgot-password-link').style.display = 'block';
                        return;
                    }
                    store.currentUser = user;
                    updateNavigation();
                    showToast('Welcome back!');
                    showScreen('dashboard');
                    checkPendingJoinCode();
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast(error.message || 'Login failed', true);
                // Show forgot password link on any login error
                document.getElementById('forgot-password-link').style.display = 'block';
            }
        }

        async function logout() {
            try {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
            } catch (e) {
                console.log('Logout error:', e);
            }
            store.currentUser = null;
            store.pools = [];
            store.picks = [];
            updateNavigation();
            showScreen('landing');
            showToast('Logged out successfully');
        }

        async function handleForgotPassword() {
            const email = document.getElementById('login-email').value.toLowerCase().trim();
            
            if (!email) {
                showToast('Please enter your email address first', true);
                return;
            }
            
            if (!supabaseClient) {
                showToast('Password reset not available', true);
                return;
            }
            
            try {
                // Supabase will only send reset email if email exists in auth.users
                // It returns success even if email doesn't exist (for security)
                const { error } = await supabaseClient.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin + '?reset=true'
                });
                
                if (error) throw error;
                
                // Always show same message for security (don't reveal if email exists)
                showToast('If an account exists with this email, a password reset link has been sent');
                document.getElementById('forgot-password-link').style.display = 'none';
            } catch (error) {
                console.error('Password reset error:', error);
                showToast('Unable to send reset email. Please try again.', true);
            }
        }

        // Load user's pools and picks from Supabase
        let isLoadingUserData = false;
        
        async function loadUserData() {
            if (!supabaseClient || !store.currentUser) {
                console.log('loadUserData: No client or user');
                return;
            }
            
            if (isLoadingUserData) {
                console.log('loadUserData: Already loading, skipping...');
                return;
            }
            
            isLoadingUserData = true;
            console.log('Loading data for user:', store.currentUser.id);
            
            try {
                // Load user's pools via API
                const poolsResult = await callAPIRetry('get-pools');
                const pools = poolsResult.data;
                
                if (pools && pools.length > 0) {
                    console.log('Found pool memberships:', pools.length);
                    
                    // OPTIMIZED: Batch load all members for all pools in parallel
                    const memberPromises = pools.map(dbPool => 
                        loadPoolMembersOptimized(dbPool.id)
                    );
                    const allMembersResults = await Promise.all(memberPromises);
                    
                    pools.forEach((dbPool, index) => {
                        const members = allMembersResults[index] || [];
                        const memberIds = members.map(m => m.user_id);
                        
                        // Add members to store.users (already have profiles from batch query)
                        members.forEach(member => {
                            if (!store.users.find(u => u.id === member.user_id)) {
                                store.users.push({
                                    id: member.user_id,
                                    name: member.user_name || 'Player',
                                    email: member.user_email || '',
                                    profilePicture: member.profile_picture || null
                                });
                            }
                        });
                        
                        const pool = {
                            id: dbPool.id,
                            name: dbPool.name,
                            season: dbPool.season,
                            tour: dbPool.tour || 'pga',
                            inviteCode: dbPool.invite_code,
                            createdBy: dbPool.created_by,
                            members: memberIds,
                            uniquePicks: dbPool.unique_picks || false,
                            poolImage: dbPool.pool_image || null
                        };
                        
                        const existingIndex = store.pools.findIndex(p => p.id === pool.id);
                        if (existingIndex >= 0) {
                            store.pools[existingIndex] = pool;
                        } else {
                            store.pools.push(pool);
                        }
                    });
                    console.log('Loaded pools:', store.pools.length);
                } else {
                    console.log('No pool memberships found');
                }
                
                // OPTIMIZED: Only load current user's picks initially
                // Other users' picks loaded on-demand when viewing standings
                const poolIds = store.pools
                    .map(p => p.id)
                    .filter(id => id && id.length > 20 && !id.startsWith('demo'));
                    
                if (poolIds.length > 0) {
                    console.log('Loading picks for current user');
                    const picksResult = await callAPIRetry('get-user-picks', { poolIds });
                    const userPicks = picksResult.data;
                    
                    if (userPicks) {
                        userPicks.forEach(pick => {
                            const pickData = {
                                id: pick.id,
                                poolId: pick.pool_id,
                                userId: pick.user_id,
                                tournamentId: pick.tournament_id,
                                playerId: pick.player_id,
                                playerName: pick.player_name,
                                tournamentName: pick.tournament_name,
                                earnings: pick.final_earnings || 0,
                                finish: pick.finish_position || null,
                                timestamp: pick.created_at || pick.updated_at
                            };
                            
                            const existingIndex = store.picks.findIndex(
                                p => p.poolId === pickData.poolId && 
                                     p.userId === pickData.userId && 
                                     p.tournamentId === pickData.tournamentId
                            );
                            if (existingIndex >= 0) {
                                store.picks[existingIndex] = pickData;
                            } else {
                                store.picks.push(pickData);
                            }
                        });
                        console.log('Loaded user picks:', userPicks.length);
                    }
                }
                
                console.log('loadUserData complete');
            } catch (error) {
                console.error('Error in loadUserData:', error);
            } finally {
                isLoadingUserData = false;
            }
        }
        
        // OPTIMIZED: Batch load pool members with profiles
        async function loadPoolMembersOptimized(poolId) {
            try {
                const result = await callAPI('get-pool-members', { poolId });
                return result.data || [];
            } catch (err) {
                console.error('Error loading pool members:', err);
                return [];
            }
        }
        
        // OPTIMIZED: Get standings using server-side calculation
        async function getPoolStandingsOptimized(poolId) {
            try {
                // Still uses RPC for complex standings calculation
                const { data, error } = await supabaseClient
                    .rpc('get_pool_standings', { p_pool_id: poolId });
                
                if (!error && data) {
                    return data;
                }
                
                console.log('Falling back to client-side standings calculation');
                return null;
            } catch (err) {
                console.error('Error getting standings:', err);
                return null;
            }
        }
        
        // OPTIMIZED: Get tournament picks for unique picks check
        async function getTournamentPicksOptimized(poolId, tournamentId) {
            try {
                const result = await callAPI('get-pool-picks', { poolId, tournamentId });
                return result.data || [];
            } catch (err) {
                console.error('Error getting tournament picks:', err);
                return [];
            }
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            // Load user's profile picture
            loadUserProfilePicture();
            
            const container = document.getElementById('tournaments-container');
            const userPools = store.pools.filter(p => p.members.includes(store.currentUser.id));

            if (userPools.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>No Pools Yet</h3>
                        <p>Create a new pool or join one using an invite link from a friend.</p>
                        <button class="btn btn-primary" onclick="showScreen('create-tournament')">Create Your First Pool</button>
                    </div>
                `;
                return;
            }

            container.innerHTML = userPools.map(pool => {
                const members = pool.members.map(id => store.users.find(u => u.id === id)).filter(Boolean);
                const userPicks = store.picks.filter(p => p.poolId === pool.id && p.userId === store.currentUser.id);
                
                // Calculate user's total earnings from COMPLETED tournaments only
                const userCompletedEarnings = userPicks
                    .filter(p => p.tournamentId !== currentTournament.id)
                    .reduce((sum, p) => sum + (p.earnings || 0), 0);

                // Calculate standings to determine user's rank
                const standings = pool.members.map(memberId => {
                    const memberPicks = store.picks.filter(p => p.poolId === pool.id && p.userId === memberId);
                    const completedEarnings = memberPicks
                        .filter(p => p.tournamentId !== currentTournament.id)
                        .reduce((sum, p) => sum + (p.earnings || 0), 0);
                    return { memberId, completedEarnings };
                }).sort((a, b) => b.completedEarnings - a.completedEarnings);

                // Find user's rank (1-indexed)
                const userRank = standings.findIndex(s => s.memberId === store.currentUser.id) + 1;

                // Get tour name and schedule for this pool
                const poolTour = pool.tour || 'pga';
                const tourName = getTourDisplayName(poolTour);
                const poolSchedule = getScheduleForTour(poolTour);
                const year = pool.season.includes('-') ? pool.season.split('-')[1] : pool.season;
                
                // Get current tournament for this pool's tour
                const poolTournamentState = getCurrentTournaments(poolTour);
                const poolCurrentTournament = poolTournamentState.upcoming || poolTournamentState.current;

                return `
                    <div class="tournament-card">
                        <div class="tournament-header">
                            <div>
                                <h3>${pool.name}</h3>
                                <p>${tourName} ${year}</p>
                            </div>
                            <img src="${pool.poolImage || getDefaultPoolLogo(poolTour)}" alt="Pool Image" style="width: 50px; height: 50px; border-radius: 6px; object-fit: contain; background: white; padding: 4px; border: 1px solid #e5e7eb;">
                        </div>
                        <div class="tournament-body">
                            <div class="tournament-stat">
                                <span>Your Rank</span>
                                <span>${userRank} / ${members.length}</span>
                            </div>
                            <div class="tournament-stat">
                                <span>Your Earnings</span>
                                <span>${formatCurrency(userCompletedEarnings)}</span>
                            </div>
                            <div class="tournament-stat">
                                <span>Picks Used</span>
                                <span>${userPicks.length} / ${poolSchedule.length}</span>
                            </div>
                            <div class="tournament-stat">
                                <span>Current Week</span>
                                <span>${poolCurrentTournament?.name || 'TBD'}</span>
                            </div>
                        </div>
                        <div class="tournament-actions">
                            <button class="btn btn-primary" onclick="openPool('${pool.id}')">View Pool</button>
                            <button class="btn btn-secondary" onclick="showInviteModal('${pool.id}')">Invite</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== PROFILE PICTURE ====================
        let userProfilePicture = null; // Base64 string

        function previewProfilePicture(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image too large. Please use an image under 2MB.', true);
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                userProfilePicture = e.target.result;
                document.getElementById('profile-preview').src = userProfilePicture;
                document.getElementById('remove-photo-btn').style.display = 'inline-block';
                
                // Save to store and localStorage
                if (store.currentUser) {
                    store.currentUser.profilePicture = userProfilePicture;
                    localStorage.setItem('userProfilePicture_' + store.currentUser.id, userProfilePicture);
                }
            };
            reader.readAsDataURL(file);
        }

        function removeProfilePicture() {
            userProfilePicture = null;
            document.getElementById('profile-preview').src = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='12'>No Photo</text></svg>";
            document.getElementById('remove-photo-btn').style.display = 'none';
            document.getElementById('profile-picture-input').value = '';
            
            if (store.currentUser) {
                store.currentUser.profilePicture = null;
                localStorage.removeItem('userProfilePicture_' + store.currentUser.id);
            }
        }

        function loadUserProfilePicture() {
            if (store.currentUser) {
                const saved = localStorage.getItem('userProfilePicture_' + store.currentUser.id);
                if (saved) {
                    userProfilePicture = saved;
                    store.currentUser.profilePicture = saved;
                    const preview = document.getElementById('profile-preview');
                    const removeBtn = document.getElementById('remove-photo-btn');
                    if (preview) {
                        preview.src = saved;
                    }
                    if (removeBtn) {
                        removeBtn.style.display = 'inline-block';
                    }
                }
            }
        }

        function getUserProfilePicture(userId) {
            // Check if it's current user
            if (store.currentUser && store.currentUser.id === userId && store.currentUser.profilePicture) {
                return store.currentUser.profilePicture;
            }
            // Check store.users (loaded from Supabase profiles)
            const user = store.users.find(u => u.id === userId);
            if (user && user.profilePicture) {
                return user.profilePicture;
            }
            // Check localStorage as fallback
            const saved = localStorage.getItem('userProfilePicture_' + userId);
            if (saved) return saved;
            // Default avatar
            return "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='24'></text></svg>";
        }

        // Profile picture change tracking (max 2 per 24 hours)
        const MAX_PROFILE_CHANGES = 2;
        const PROFILE_CHANGE_WINDOW = 24 * 60 * 60 * 1000; // 24 hours in ms
        let pendingProfilePicture = null;

        function getProfileChangeCount() {
            if (!store.currentUser) return 0;
            const key = 'profileChanges_' + store.currentUser.id;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            const now = Date.now();
            // Filter to only changes within the last 24 hours
            const recentChanges = data.filter(timestamp => now - timestamp < PROFILE_CHANGE_WINDOW);
            // Clean up old entries
            localStorage.setItem(key, JSON.stringify(recentChanges));
            return recentChanges.length;
        }

        function recordProfileChange() {
            if (!store.currentUser) return;
            const key = 'profileChanges_' + store.currentUser.id;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            data.push(Date.now());
            localStorage.setItem(key, JSON.stringify(data));
        }

        function canChangeProfilePicture() {
            return getProfileChangeCount() < MAX_PROFILE_CHANGES;
        }

        function getNextProfileChangeTime() {
            if (!store.currentUser) return null;
            const key = 'profileChanges_' + store.currentUser.id;
            const data = JSON.parse(localStorage.getItem(key) || '[]');
            if (data.length === 0) return null;
            const oldestChange = Math.min(...data);
            const resetTime = new Date(oldestChange + PROFILE_CHANGE_WINDOW);
            return resetTime;
        }

        function openProfileEditor() {
            const currentPic = getUserProfilePicture(store.currentUser.id);
            document.getElementById('profile-editor-preview').src = currentPic;
            pendingProfilePicture = null;
            
            // Update change limit display
            const changesRemaining = MAX_PROFILE_CHANGES - getProfileChangeCount();
            const limitEl = document.getElementById('profile-change-limit');
            
            if (changesRemaining > 0) {
                limitEl.textContent = `${changesRemaining} change${changesRemaining !== 1 ? 's' : ''} remaining today`;
                limitEl.style.color = 'var(--gray)';
            } else {
                const resetTime = getNextProfileChangeTime();
                if (resetTime) {
                    limitEl.textContent = `Limit reached. You can change again at ${resetTime.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}`;
                } else {
                    limitEl.textContent = 'Limit reached. Try again later.';
                }
                limitEl.style.color = 'var(--red)';
            }
            
            // Show/hide remove button
            const hasCustomPic = store.currentUser.profilePicture || localStorage.getItem('userProfilePicture_' + store.currentUser.id);
            document.getElementById('remove-profile-btn').style.display = hasCustomPic ? 'inline-block' : 'none';
            document.getElementById('save-profile-btn').style.display = 'none';
            
            document.getElementById('profile-editor-modal').classList.add('active');
        }

        async function previewNewProfilePicture(event) {
            if (!canChangeProfilePicture()) {
                showToast('You\'ve reached the limit of 2 profile changes per 24 hours', true);
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be smaller than 2MB', true);
                return;
            }
            
            // Compress image to 200x200 max
            pendingProfilePicture = await compressImage(file, 256, 0.92);
            document.getElementById('profile-editor-preview').src = pendingProfilePicture;
            document.getElementById('save-profile-btn').style.display = 'block';
        }

        async function saveNewProfilePicture() {
            if (!pendingProfilePicture) return;
            
            if (!canChangeProfilePicture()) {
                showToast('You\'ve reached the limit of 2 profile changes per 24 hours', true);
                return;
            }
            
            // Save to store and localStorage
            store.currentUser.profilePicture = pendingProfilePicture;
            localStorage.setItem('userProfilePicture_' + store.currentUser.id, pendingProfilePicture);
            
            // Save to Supabase profiles table
            if (supabaseClient) {
                try {
                    await callAPI('update-profile', {
                        name: store.currentUser.name,
                        email: store.currentUser.email,
                        profilePicture: pendingProfilePicture
                    });
                } catch (err) {
                    console.error('Error saving profile picture:', err);
                }
            }
            
            // Record the change
            recordProfileChange();
            
            // Update nav profile picture
            document.getElementById('nav-profile-pic').src = pendingProfilePicture;
            
            pendingProfilePicture = null;
            closeModal('profile-editor-modal');
            showToast('Profile picture updated!');
        }

        async function removeUserProfilePicture() {
            if (!canChangeProfilePicture()) {
                showToast('You\'ve reached the limit of 2 profile changes per 24 hours', true);
                return;
            }
            
            // Remove from store and localStorage
            store.currentUser.profilePicture = null;
            localStorage.removeItem('userProfilePicture_' + store.currentUser.id);
            
            // Remove from Supabase
            if (supabaseClient) {
                try {
                    await callAPI('remove-profile-picture');
                } catch (err) {
                    console.error('Error removing profile picture:', err);
                }
            }
            
            // Record the change
            recordProfileChange();
            
            // Reset to default
            const defaultPic = "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23e5e7eb' width='100' height='100'/><text x='50' y='55' text-anchor='middle' fill='%239ca3af' font-size='24'></text></svg>";
            document.getElementById('nav-profile-pic').src = defaultPic;
            document.getElementById('profile-editor-preview').src = defaultPic;
            document.getElementById('remove-profile-btn').style.display = 'none';
            document.getElementById('save-profile-btn').style.display = 'none';
            
            closeModal('profile-editor-modal');
            showToast('Profile picture removed');
        }

        function updateNavProfilePicture() {
            if (store.currentUser) {
                const pic = getUserProfilePicture(store.currentUser.id);
                document.getElementById('nav-profile-pic').src = pic;
            }
        }

        function showProfileModal(imageSrc, userName) {
            const modal = document.getElementById('profile-modal');
            const image = document.getElementById('profile-modal-image');
            const name = document.getElementById('profile-modal-name');
            
            image.src = imageSrc;
            name.textContent = userName;
            modal.classList.add('active');
            
            // Prevent scrolling while modal is open
            document.body.style.overflow = 'hidden';
        }

        function showProfileModalFromElement(imgElement, userName) {
            showProfileModal(imgElement.src, userName);
        }

        function closeProfileModal() {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ==================== POOL IMAGE ====================
        let pendingPoolImage = null;
        
        function handlePoolImageClick() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;
            
            const isCreator = pool.createdBy === store.currentUser.id;
            
            if (isCreator) {
                // Creator can edit
                openPoolImageModal();
            } else {
                // Non-creator can view expanded
                const imgSrc = pool.poolImage || getDefaultPoolLogo(pool.tour);
                showProfileModal(imgSrc, pool.name);
            }
        }
        
        function openPoolImageModal() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;
            
            // Check if user is the creator
            if (pool.createdBy !== store.currentUser.id) {
                showToast('Only the pool creator can change the image', true);
                return;
            }
            
            // Set current image in preview
            const preview = document.getElementById('pool-image-preview');
            const removeBtn = document.getElementById('remove-pool-image-btn');
            
            if (pool.poolImage) {
                preview.src = pool.poolImage;
                removeBtn.style.display = 'inline-block';
            } else {
                preview.src = getDefaultPoolLogo(pool.tour);
                removeBtn.style.display = 'none';
            }
            
            pendingPoolImage = pool.poolImage || null;
            document.getElementById('pool-image-modal').classList.add('active');
        }
        
        // Compress image to max dimensions while maintaining aspect ratio
        function compressImage(file, maxSize = 200, quality = 0.9) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Scale down if larger than maxSize
                        if (width > height) {
                            if (width > maxSize) {
                                height = Math.round(height * maxSize / width);
                                width = maxSize;
                            }
                        } else {
                            if (height > maxSize) {
                                width = Math.round(width * maxSize / height);
                                height = maxSize;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        // Enable high-quality image smoothing
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to compressed JPEG
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }
        
        // Create Pool Image (for new pool creation)
        let createPoolImage = null;
        
        async function previewCreatePoolImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be smaller than 2MB', true);
                return;
            }
            
            // Compress image to 200x200 max
            createPoolImage = await compressImage(file, 256, 0.92);
            document.getElementById('create-pool-image-preview').src = createPoolImage;
            document.getElementById('remove-create-pool-image-btn').style.display = 'inline-block';
        }
        
        function removeCreatePoolImage() {
            createPoolImage = null;
            const selectedTour = document.getElementById('pool-tour')?.value || 'pga';
            document.getElementById('create-pool-image-preview').src = getDefaultPoolLogo(selectedTour);
            document.getElementById('remove-create-pool-image-btn').style.display = 'none';
            document.getElementById('create-pool-image-input').value = '';
        }
        
        function resetCreatePoolForm() {
            document.getElementById('pool-name').value = '';
            createPoolImage = null;
            const selectedTour = document.getElementById('pool-tour')?.value || 'pga';
            document.getElementById('create-pool-image-preview').src = getDefaultPoolLogo(selectedTour);
            document.getElementById('remove-create-pool-image-btn').style.display = 'none';
            document.getElementById('create-pool-image-input').value = '';
            document.getElementById('invite-list').innerHTML = '';
            inviteEmails = [];
        }
        
        async function previewPoolImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Check file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showToast('Image must be smaller than 2MB', true);
                return;
            }
            
            // Compress image to 200x200 max
            pendingPoolImage = await compressImage(file, 256, 0.92);
            document.getElementById('pool-image-preview').src = pendingPoolImage;
            document.getElementById('remove-pool-image-btn').style.display = 'inline-block';
        }
        
        function removePoolImage() {
            pendingPoolImage = null;
            const pool = store.pools.find(p => p.id === currentPoolId);
            document.getElementById('pool-image-preview').src = getDefaultPoolLogo(pool?.tour);
            document.getElementById('remove-pool-image-btn').style.display = 'none';
        }
        
        async function savePoolImage() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;
            
            try {
                // Save to Supabase
                if (supabaseClient) {
                    try {
                        await callAPI('update-pool-image', { poolId: currentPoolId, poolImage: pendingPoolImage });
                    } catch (apiErr) {
                        console.error('Error saving pool image:', apiErr);
                        showToast('Failed to save pool image', true);
                        return;
                    }
                }
                
                // Update local store
                pool.poolImage = pendingPoolImage;
                
                // Update UI
                updatePoolImageDisplay();
                
                closeModal('pool-image-modal');
                showToast(pendingPoolImage ? 'Pool image saved!' : 'Pool image removed');
                
                // Refresh dashboard if visible
                renderDashboard();
            } catch (err) {
                console.error('Error saving pool image:', err);
                showToast('Failed to save pool image', true);
            }
        }
        
        function updatePoolImageDisplay() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;
            
            const imgDisplay = document.getElementById('pool-image-display');
            const container = document.getElementById('pool-image-container');
            
            // Set the image
            if (pool.poolImage) {
                imgDisplay.src = pool.poolImage;
            } else {
                imgDisplay.src = getDefaultPoolLogo(pool.tour);
            }
            
            // Clickable for everyone (creators edit, others view expanded)
            container.style.cursor = 'pointer';
            container.onclick = handlePoolImageClick;
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeProfileModal();
                closeModal('profile-editor-modal');
            }
        });

        // ==================== CREATE TOURNAMENT ====================
        function addInvite() {
            const input = document.getElementById('invite-email');
            const email = input.value.toLowerCase().trim();

            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email', true);
                return;
            }

            if (inviteEmails.includes(email)) {
                showToast('This email is already in the invite list', true);
                return;
            }

            inviteEmails.push(email);
            renderInviteList();
            input.value = '';
        }

        function removeInvite(email) {
            inviteEmails = inviteEmails.filter(e => e !== email);
            renderInviteList();
        }

        function renderInviteList() {
            const container = document.getElementById('invite-list');
            container.innerHTML = inviteEmails.map(email => `
                <span class="invite-tag">
                    ${email}
                    <button onclick="removeInvite('${email}')">&times;</button>
                </span>
            `).join('');
        }

        async function handleCreateTournament(event) {
            event.preventDefault();
            const name = document.getElementById('pool-name').value;
            const tourSeasonValue = document.getElementById('pool-season').value;
            const uniquePicks = document.getElementById('unique-picks').checked;

            // Parse tour|season format (e.g., "pga|2025-2026" or "champions|2025-2026")
            // For backwards compatibility, if no pipe, assume PGA tour
            let tour = 'pga';
            let season = tourSeasonValue;
            if (tourSeasonValue.includes('|')) {
                [tour, season] = tourSeasonValue.split('|');
            }

            if (!name || !season) {
                showToast('Please fill in all fields', true);
                return;
            }

            console.log('Creating pool:', name, 'tour:', tour, 'season:', season, 'uniquePicks:', uniquePicks);

            try {
                let pool;
                
                if (supabaseClient && store.currentUser) {
                    // Create pool via API
                    const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                    
                    console.log('Creating pool via API...');
                    const result = await callAPI('create-pool', {
                        name, season, tour, inviteCode,
                        uniquePicks, poolImage: createPoolImage
                    });
                    const newPool = result.data;
                    
                    console.log('Pool created:', newPool);
                    
                    pool = {
                        id: newPool.id,
                        name: newPool.name,
                        season: newPool.season,
                        tour: newPool.tour || 'pga',
                        ownerId: store.currentUser.id,
                        createdBy: store.currentUser.id,
                        members: [store.currentUser.id],
                        inviteCode: newPool.invite_code,
                        uniquePicks: newPool.unique_picks,
                        poolImage: newPool.pool_image
                    };
                } else {
                    // Fallback to local
                    pool = {
                        id: generateId(),
                        name,
                        season,
                        tour: tour,
                        ownerId: store.currentUser.id,
                        createdBy: store.currentUser.id,
                        members: [store.currentUser.id],
                        inviteCode: generateId().toUpperCase(),
                        uniquePicks: uniquePicks,
                        poolImage: createPoolImage
                    };
                }

                store.pools.push(pool);

                // Send invite emails
                if (inviteEmails.length > 0) {
                    const inviteLink = `${window.location.origin}${window.location.pathname}?join=${pool.inviteCode}`;
                    const subject = encodeURIComponent(`Join my One & Done Golf Pool: ${pool.name}`);
                    const body = encodeURIComponent(
`Hey!

I've created a One & Done golf pool called "${pool.name}" and I'd love for you to join!

Click this link to join:
${inviteLink}

Or use invite code: ${pool.inviteCode}

How it works:
- Pick one golfer each week
- Each golfer can only be used once per season
- Earn their prize money winnings
- Most earnings at season end wins!

See you on the course!`
                    );
                    
                    // Open mailto with all emails
                    const mailtoLink = `mailto:${inviteEmails.join(',')}?subject=${subject}&body=${body}`;
                    window.open(mailtoLink, '_blank');
                    
                    // Also store invites locally
                    inviteEmails.forEach(email => {
                        store.invites.push({
                            id: generateId(),
                            poolId: pool.id,
                            email,
                            status: 'pending'
                        });
                    });
                }

                inviteEmails = [];
                renderInviteList();

                showToast('Pool created successfully!');
                
                // Reset form
                resetCreatePoolForm();
                
                // Show the invite modal with the code
                setTimeout(() => {
                    showInviteModal(pool.id);
                }, 500);
                
                showScreen('dashboard');
            } catch (error) {
                console.error('Create pool error:', error);
                showToast(error.message || 'Failed to create pool', true);
            }
        }

        // ==================== LEAVE POOL ====================
        let poolToLeave = null;

        function togglePoolOptions(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('pool-options-dropdown');
            const btn = event.currentTarget;
            const rect = btn.getBoundingClientRect();
            
            // Reset any transforms
            dropdown.style.transform = 'none';
            
            // Position dropdown below the button
            dropdown.style.top = (rect.bottom + 5) + 'px';
            
            // On mobile, position from left to keep it on screen
            if (window.innerWidth < 768) {
                const dropdownWidth = 160;
                let leftPos = rect.left;
                // Make sure it doesn't go off the right edge
                if (leftPos + dropdownWidth > window.innerWidth - 10) {
                    leftPos = window.innerWidth - dropdownWidth - 10;
                }
                dropdown.style.left = leftPos + 'px';
                dropdown.style.right = 'auto';
            } else {
                // Desktop: align to right edge of button
                dropdown.style.right = (window.innerWidth - rect.right) + 'px';
                dropdown.style.left = 'auto';
            }
            
            dropdown.classList.toggle('active');
        }
        
        function closePoolOptionsDropdown() {
            const dropdown = document.getElementById('pool-options-dropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        // Close dropdown when clicking elsewhere
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('pool-options-dropdown');
            if (dropdown && !e.target.closest('.pool-options-menu')) {
                dropdown.classList.remove('active');
            }
        });

        function confirmLeaveCurrentPool() {
            // Close the dropdown
            document.getElementById('pool-options-dropdown').classList.remove('active');
            
            // Get current pool
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (pool) {
                confirmLeavePool(currentPoolId, pool.name);
            }
        }

        function confirmLeavePool(poolId, poolName) {
            poolToLeave = poolId;
            document.getElementById('leave-pool-name').textContent = `"${poolName}"?`;
            document.getElementById('leave-pool-modal').classList.add('active');
        }

        async function leavePool() {
            if (!poolToLeave) return;

            try {
                // Remove from Supabase if connected
                if (supabaseClient) {
                    await callAPI('leave-pool', { poolId: poolToLeave });
                }

                // Remove from local store
                store.picks = store.picks.filter(p => !(p.poolId === poolToLeave && p.userId === store.currentUser.id));
                
                const pool = store.pools.find(p => p.id === poolToLeave);
                if (pool) {
                    pool.members = pool.members.filter(m => m !== store.currentUser.id);
                    // If user is no longer a member, remove from their pools list
                    if (!pool.members.includes(store.currentUser.id)) {
                        store.pools = store.pools.filter(p => p.id !== poolToLeave);
                    }
                }

                closeModal('leave-pool-modal');
                poolToLeave = null;
                currentPoolId = null;
                showToast('You have left the pool');
                showScreen('dashboard');
                renderDashboard();

            } catch (error) {
                console.error('Leave pool error:', error);
                showToast('Failed to leave pool', true);
            }
        }

        let poolToDelete = null;

        function confirmDeletePool() {
            // Close the dropdown
            document.getElementById('pool-options-dropdown').classList.remove('active');
            
            // Get current pool
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (pool) {
                poolToDelete = currentPoolId;
                document.getElementById('delete-pool-name').textContent = `"${pool.name}"?`;
                document.getElementById('delete-pool-modal').classList.add('active');
            }
        }

        async function deletePool() {
            if (!poolToDelete) return;

            try {
                if (supabaseClient) {
                    // Delete all picks for this pool
                    await callAPI('delete-pool', { poolId: poolToDelete });
                }

                // Remove from local store
                store.picks = store.picks.filter(p => p.poolId !== poolToDelete);
                store.pools = store.pools.filter(p => p.id !== poolToDelete);

                closeModal('delete-pool-modal');
                poolToDelete = null;
                currentPoolId = null;
                localStorage.removeItem('currentPoolId');
                showToast('Pool deleted successfully');
                showScreen('dashboard');
                renderDashboard();

            } catch (error) {
                console.error('Delete pool error:', error);
                showToast('Failed to delete pool', true);
            }
        }

        // ==================== POOL VIEW ====================
        async function openPool(poolId) {
            currentPoolId = poolId;
            selectedPlayerId = null;
            // Save to localStorage so we can restore after refresh
            localStorage.setItem('currentPoolId', poolId);
            
            // Update tournament state based on pool's tour
            const pool = store.pools.find(p => p.id === poolId);
            if (pool) {
                currentPoolTour = pool.tour || 'pga';
                await updateTournamentStateForPool();
            }
            
            showScreen('pool-view');
            switchPoolTab('standings');
            renderPoolView();
            checkTabsOverflow();
            
            // Show creator-only buttons
            const deleteBtn = document.getElementById('delete-pool-btn');
            const editImageBtn = document.getElementById('edit-pool-image-dropdown-btn');
            if (pool) {
                const isCreator = pool.createdBy === store.currentUser.id;
                if (deleteBtn) deleteBtn.style.display = isCreator ? 'block' : 'none';
                if (editImageBtn) editImageBtn.style.display = isCreator ? 'block' : 'none';
            }
            
            // Update pool image display
            updatePoolImageDisplay();
            
            // Hide scroll indicator when user scrolls tabs
            const poolTabs = document.getElementById('pool-tabs');
            const scrollIndicator = document.getElementById('scroll-indicator');
            if (poolTabs && scrollIndicator) {
                poolTabs.addEventListener('scroll', function() {
                    if (this.scrollLeft > 5) {
                        scrollIndicator.classList.add('hidden');
                    }
                }, { passive: true });
            }
        }

        function checkTabsOverflow() {
            // No longer needed - using scroll indicator instead
        }

        function switchPoolTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.pool-tab').forEach(t => t.style.display = 'none');

            // Find and activate the correct tab button
            const tabButton = document.querySelector(`.tab[onclick*="'${tabName}'"]`);
            if (tabButton) {
                tabButton.classList.add('active');
            }
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            if (tabName === 'standings') renderStandings();
            if (tabName === 'leaderboard') renderLeaderboard();
            if (tabName === 'pick') renderPlayerSelection();
            if (tabName === 'history') renderHistory();
        }

        function renderPoolView() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;

            document.getElementById('pool-title').textContent = pool.name;
            
            // Show tour and season (e.g., "PGA Tour - 2026" or "PGA Tour Champions - 2026")
            const tourName = getTourDisplayName(pool.tour);
            // Extract just the year (handles both "2026" and "2025-2026" formats)
            const year = pool.season.includes('-') ? pool.season.split('-')[1] : pool.season;
            document.getElementById('pool-season-display').textContent = `${tourName} - ${year}`;
            renderStandings();
        }

        async function renderStandings() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) return;

            // Fetch ESPN data to ensure we have latest leaderboard info
            await fetchESPNLeaderboard();

            // Use ESPN live data if available, otherwise mock data
            const leaderboardData = espnDataLoaded && liveLeaderboard.length > 0 ? liveLeaderboard : mockLeaderboard;

            // OPTIMIZED: Try server-side standings first
            let standings = [];
            const serverStandings = await getPoolStandingsOptimized(currentPoolId);
            
            if (serverStandings && serverStandings.length > 0) {
                // Use server-side calculated standings
                standings = serverStandings.map(s => {
                    // Ensure user is in store and update profile picture if available
                    const existingUser = store.users.find(u => u.id === s.user_id);
                    if (!existingUser) {
                        store.users.push({
                            id: s.user_id,
                            name: s.user_name || 'Player',
                            email: s.user_email || '',
                            profilePicture: s.profile_picture || null
                        });
                    } else if (s.profile_picture && !existingUser.profilePicture) {
                        // Update profile picture if we have it from server but not in store
                        existingUser.profilePicture = s.profile_picture;
                    }
                    
                    const user = store.users.find(u => u.id === s.user_id) || { 
                        id: s.user_id, 
                        name: s.user_name || 'Unknown User' 
                    };
                    
                    // Get current week pick info
                    let currentWeekEarnings = 0;
                    let currentPlayer = null;
                    let playerHeadshot = null;
                    let playerPosition = null;
                    
                    if (s.current_week_pick && s.current_week_pick.player_id) {
                        currentPlayer = getPlayerById(s.current_week_pick.player_id) || {
                            id: s.current_week_pick.player_id,
                            name: s.current_week_pick.player_name
                        };
                        
                        // Only look up position/earnings if ESPN is showing the same tournament
                        // (not showing finished results from a previous tournament)
                        const currentTournamentFirstWord = currentTournament?.name?.split(' ')[0]?.toLowerCase() || '';
                        const espnMatchesCurrentTournament = espnTournamentInfo && 
                            espnTournamentInfo.name && 
                            currentTournament && 
                            currentTournament.name &&
                            (espnTournamentInfo.name.toLowerCase().includes(currentTournamentFirstWord) ||
                             currentTournament.name.toLowerCase().includes(espnTournamentInfo.name.split(' ')[0]?.toLowerCase() || ''));
                        
                        // For LIV and in-progress tournaments, always try to look up earnings
                        const shouldLookupEarnings = espnMatchesCurrentTournament || 
                            !espnTournamentInfo?.isFinished ||
                            currentPoolTour === 'liv';
                        
                        if (shouldLookupEarnings) {
                            // Look in live leaderboard
                            let leaderboardEntry = leaderboardData.find(l => 
                                String(l.playerId) === String(s.current_week_pick.player_id)
                            );
                            if (!leaderboardEntry && s.current_week_pick.player_name) {
                                leaderboardEntry = leaderboardData.find(l => 
                                    l.playerName && l.playerName.toLowerCase() === s.current_week_pick.player_name.toLowerCase()
                                );
                            }
                            currentWeekEarnings = leaderboardEntry ? leaderboardEntry.projectedEarnings : 0;
                            playerPosition = leaderboardEntry ? leaderboardEntry.pos : null;
                            // Get headshot from leaderboard if available
                            playerHeadshot = leaderboardEntry?.headshot || null;
                        }
                    }
                    
                    return {
                        user,
                        picks: { length: s.picks_count },
                        completedEarnings: Number(s.total_earnings) || 0,
                        totalEarnings: (Number(s.total_earnings) || 0) + currentWeekEarnings,
                        currentWeekEarnings,
                        currentPlayer,
                        playerHeadshot,
                        playerPosition
                    };
                }).sort((a, b) => b.completedEarnings - a.completedEarnings);
            } else {
                // FALLBACK: Client-side calculation (original logic)
                // Load all picks for this pool if not already loaded
                const poolPicks = store.picks.filter(p => p.poolId === currentPoolId);
                if (poolPicks.length === 0 || poolPicks.every(p => p.userId === store.currentUser.id)) {
                    // Need to load other users' picks
                    try {
                        const result = await callAPI('get-all-pool-picks', { poolId: currentPoolId });
                        const allPicks = result.data;
                    
                        if (allPicks) {
                            allPicks.forEach(pick => {
                                if (!store.picks.find(p => p.id === pick.id)) {
                                    store.picks.push({
                                        id: pick.id,
                                        poolId: pick.pool_id,
                                        userId: pick.user_id,
                                        tournamentId: pick.tournament_id,
                                        playerId: pick.player_id,
                                        playerName: pick.player_name,
                                        tournamentName: pick.tournament_name,
                                        earnings: pick.final_earnings || 0,
                                        finish: pick.finish_position || null
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error loading pool picks:', e);
                    }
                }
                
                standings = pool.members.map(memberId => {
                    const user = store.users.find(u => u.id === memberId) || { id: memberId, name: 'Unknown User' };
                    const userPicks = store.picks.filter(p => p.poolId === currentPoolId && p.userId === memberId);
                    
                    const completedEarnings = userPicks
                        .filter(p => p.tournamentId !== currentTournament.id)
                        .reduce((sum, p) => sum + (p.earnings || 0), 0);

                    const currentPick = userPicks.find(p => p.tournamentId === currentTournament.id);
                    let currentWeekEarnings = 0;
                    let currentPlayer = null;
                    let playerHeadshot = null;
                    let playerPosition = null;

                    if (currentPick) {
                        currentPlayer = getPlayerById(currentPick.playerId);
                        
                        // Only look up position/earnings if ESPN is showing the same tournament
                        const currentTournamentFirstWord = currentTournament?.name?.split(' ')[0]?.toLowerCase() || '';
                        const espnMatchesCurrentTournament = espnTournamentInfo && 
                            espnTournamentInfo.name && 
                            currentTournament && 
                            currentTournament.name &&
                            (espnTournamentInfo.name.toLowerCase().includes(currentTournamentFirstWord) ||
                             currentTournament.name.toLowerCase().includes(espnTournamentInfo.name.split(' ')[0]?.toLowerCase() || ''));
                        
                        // For LIV and in-progress tournaments, always try to look up earnings
                        const shouldLookupEarnings = espnMatchesCurrentTournament || 
                            !espnTournamentInfo?.isFinished ||
                            currentPoolTour === 'liv';
                        
                        if (shouldLookupEarnings) {
                            let leaderboardEntry = leaderboardData.find(l => String(l.playerId) === String(currentPick.playerId));
                            if (!leaderboardEntry && currentPlayer) {
                                leaderboardEntry = leaderboardData.find(l => 
                                    l.playerName && l.playerName.toLowerCase() === currentPlayer.name.toLowerCase()
                                );
                            }
                            if (!leaderboardEntry && currentPick.playerName) {
                                leaderboardEntry = leaderboardData.find(l => 
                                    l.playerName && l.playerName.toLowerCase() === currentPick.playerName.toLowerCase()
                                );
                            }
                            currentWeekEarnings = leaderboardEntry ? leaderboardEntry.projectedEarnings : 0;
                            playerPosition = leaderboardEntry ? leaderboardEntry.pos : null;
                            playerHeadshot = leaderboardEntry?.headshot || null;
                        }
                    }

                    return {
                        user,
                        picks: userPicks,
                        completedEarnings,
                        totalEarnings: completedEarnings + currentWeekEarnings,
                        currentWeekEarnings,
                        currentPlayer,
                        playerHeadshot,
                        playerPosition
                    };
                }).filter(s => s.user).sort((a, b) => b.completedEarnings - a.completedEarnings);
            }

            const tbody = document.getElementById('standings-body');
            
            if (standings.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; padding: 2rem; color: var(--gray);">
                            No members in this pool yet
                        </td>
                    </tr>
                `;
                return;
            }
            
            // ==================== STREAK DETECTION ====================
            // Walk backwards through finalized tournaments to find consecutive
            // best/worst finish streaks for each user
            // 1 week = single emoji, 2 = double, 3 = triple, 4+ = emoji + "x4"
            let hotStreaks = {}; // userId -> consecutive "best pick" count
            let iceStreaks = {}; // userId -> consecutive "worst pick" count
            
            if (emojiTournament) {
                const schedule = getScheduleForTour(currentPoolTour);
                const emojiIdx = schedule.findIndex(t => t.id === emojiTournament.id);
                
                if (emojiIdx >= 0) {
                    let hotStreakBroken = {};
                    let iceStreakBroken = {};
                    
                    // Bulk-fetch ALL picks for this pool so streak lookback works
                    try {
                        const result = await callAPI('get-all-pool-picks', { poolId: currentPoolId });
                        const allPoolPicks = result.data;
                        
                        if (allPoolPicks) {
                            allPoolPicks.forEach(pick => {
                                if (!store.picks.find(p => p.id === pick.id)) {
                                    store.picks.push({
                                        id: pick.id,
                                        poolId: pick.pool_id,
                                        userId: pick.user_id,
                                        tournamentId: pick.tournament_id,
                                        playerId: pick.player_id,
                                        playerName: pick.player_name,
                                        tournamentName: pick.tournament_name,
                                        earnings: pick.final_earnings || 0,
                                        finish: pick.finish_position || null
                                    });
                                }
                            });
                        }
                    } catch (e) {
                        console.error('Error bulk-fetching picks for streak detection:', e);
                    }
                    
                    for (let i = emojiIdx; i >= 0; i--) {
                        const t = schedule[i];
                        const tId = t.id;
                        const tIdAlt = tId.includes('-') ? tId.replace('-', '') : tId.replace(/(\d+)$/, '-$1');
                        
                        // Get picks for this tournament from store (now guaranteed loaded)
                        let tournamentPicks = store.picks.filter(p => 
                            p.poolId === currentPoolId && 
                            (p.tournamentId === tId || p.tournamentId === tIdAlt)
                        );
                        
                        // Need at least 2 picks and at least one finalized to compare
                        if (tournamentPicks.length < 2) continue;
                        const hasBeenFinalized = tournamentPicks.some(p => (p.earnings || p.final_earnings || 0) > 0);
                        if (!hasBeenFinalized) continue;
                        
                        const bestEarnings = Math.max(...tournamentPicks.map(p => p.earnings || p.final_earnings || 0));
                        const worstEarnings = Math.min(...tournamentPicks.map(p => p.earnings || p.final_earnings || 0));
                        
                        if (bestEarnings <= 0) continue;
                        
                        const bestUserIds = tournamentPicks
                            .filter(p => (p.earnings || p.final_earnings || 0) === bestEarnings)
                            .map(p => p.userId || p.user_id);
                        
                        const worstUserIds = tournamentPicks
                            .filter(p => (p.earnings || p.final_earnings || 0) === worstEarnings)
                            .map(p => p.userId || p.user_id);
                        
                        // Extend hot streaks for users who were best AND haven't been broken yet
                        bestUserIds.forEach(uid => {
                            if (!hotStreakBroken[uid]) {
                                hotStreaks[uid] = (hotStreaks[uid] || 0) + 1;
                            }
                        });
                        // Break hot streak for everyone who WASN'T the best this week
                        tournamentPicks.forEach(p => {
                            const uid = p.userId || p.user_id;
                            if (!bestUserIds.includes(uid)) {
                                hotStreakBroken[uid] = true;
                            }
                        });
                        
                        // Extend ice streaks for users who were worst AND haven't been broken yet
                        worstUserIds.forEach(uid => {
                            if (!iceStreakBroken[uid]) {
                                iceStreaks[uid] = (iceStreaks[uid] || 0) + 1;
                            }
                        });
                        // Break ice streak for everyone who WASN'T the worst this week
                        tournamentPicks.forEach(p => {
                            const uid = p.userId || p.user_id;
                            if (!worstUserIds.includes(uid)) {
                                iceStreakBroken[uid] = true;
                            }
                        });
                        
                        // Stop only when every member with an active streak has had it broken
                        // (i.e., no more streaks can possibly grow)
                        const anyHotStillGrowing = Object.keys(hotStreaks).some(uid => !hotStreakBroken[uid]);
                        const anyIceStillGrowing = Object.keys(iceStreaks).some(uid => !iceStreakBroken[uid]);
                        if (!anyHotStillGrowing && !anyIceStillGrowing && Object.keys(hotStreaks).length > 0) break;
                    }
                }
                
                console.log('Hot streaks:', hotStreaks);
                console.log('Ice streaks:', iceStreaks);
            }
            
            // Format streak emoji: 1=, 2=, 3=, 4+=x4
            function formatStreakEmoji(emoji, count) {
                if (!count || count <= 0) return '';
                if (count === 1) return ' ' + emoji;
                if (count === 2) return ' ' + emoji + emoji;
                if (count === 3) return ' ' + emoji + emoji + emoji;
                return ' ' + emoji + 'x' + count;
            }
            
            tbody.innerHTML = standings.map((standing, index) => {
                const isCurrentUser = standing.user.id === store.currentUser.id;
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                const profilePic = getUserProfilePicture(standing.user.id);
                const userName = standing.user.name || 'Unknown';
                const picksCount = standing.picks.length !== undefined ? standing.picks.length : standing.picks;

                return `
                    <tr class="${isCurrentUser ? 'current-user' : ''}">
                        <td>
                            <span class="rank-badge ${rankClass}">${index + 1}</span>
                        </td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <img src="${profilePic}" alt="" class="clickable-profile" 
                                     style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;"
                                     onclick="event.stopPropagation(); showProfileModalFromElement(this, '${userName.replace(/'/g, "\\'")}')"
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                <strong>${userName}</strong>${formatStreakEmoji('', hotStreaks[standing.user.id])}${!hotStreaks[standing.user.id] ? formatStreakEmoji('', iceStreaks[standing.user.id]) : ''}
                                ${isCurrentUser ? ' (You)' : ''}
                            </div>
                        </td>
                        <td>
                            ${standing.currentPlayer ? `
                                <div class="weekly-pick">
                                    <img src="${standing.playerHeadshot || getPlayerHeadshot(standing.currentPlayer)}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                    <span>${standing.currentPlayer.name}</span>
                                    ${standing.playerPosition ? 
                                        `<span style="color: var(--gold); font-size: 0.8rem; margin-left: auto; text-align: right;">${standing.playerPosition} (${formatCurrency(standing.currentWeekEarnings)} proj)</span>` :
                                        ''
                                    }
                                </div>
                            ` : '<span style="color: var(--gray);">No pick yet</span>'}
                        </td>
                        <td style="font-weight: 600; color: var(--green-fairway);">
                            ${formatCurrency(standing.completedEarnings)}
                        </td>
                        <td>${picksCount}</td>
                    </tr>
                `;
            }).join('');
        }

        async function renderLeaderboard() {
            // Header always shows the upcoming/current tournament
            const headerTournament = upcomingTournament || currentTournament;
            
            if (!headerTournament) {
                document.getElementById('leaderboard-body').innerHTML = `
                    <tr><td colspan="7" style="text-align: center; padding: 2rem;">No tournament data available for this tour yet.</td></tr>
                `;
                return;
            }
            
            // Header shows UPCOMING tournament info
            document.getElementById('current-tournament-name').textContent = headerTournament.name;
            document.getElementById('tournament-dates').textContent = headerTournament.dates;
            document.getElementById('tournament-course').textContent = headerTournament.course;
            
            // Set logo - for LIV, use circular badge from tournamentLogos instead of wide banner
            const logoEl = document.getElementById('tournament-logo');
            if (currentPoolTour === 'liv') {
                // Use circular badge but request higher resolution for header display
                let circularLogo = tournamentLogos[headerTournament.id] || headerTournament.logo;
                // Upscale from size60 (60px) to 200px for crisp retina display
                if (circularLogo && circularLogo.includes('t_ratio1_1-size60')) {
                    circularLogo = circularLogo.replace('t_ratio1_1-size60-f_webp-c_fill', 'w_200,h_200,c_fill,f_auto,q_auto');
                }
                logoEl.src = circularLogo;
                logoEl.className = 'tournament-logo-liv';
                logoEl.style.width = '70px';
                logoEl.style.height = '70px';
            } else {
                logoEl.src = headerTournament.logo;
                logoEl.className = 'tournament-logo';
                logoEl.style.width = '';
                logoEl.style.height = '';
            }

            // Always try to fetch ESPN data first
            await fetchESPNLeaderboard();
            
            const now = new Date();
            const hasLeaderboardData = espnDataLoaded && liveLeaderboard.length > 0;
            
            // Check if ESPN is showing finished results from a DIFFERENT tournament
            const showingFinishedResults = hasLeaderboardData && 
                                           espnTournamentInfo && 
                                           espnTournamentInfo.isFinished &&
                                           espnTournamentInfo.name !== headerTournament.name;
            
            // Debug logging
            console.log('Banner logic:', {
                hasLeaderboardData,
                espnTournamentInfo,
                headerTournamentName: headerTournament.name,
                showingFinishedResults
            });
            
            // Update round display based on what we're showing
            if (showingFinishedResults) {
                document.getElementById('tournament-round').textContent = 'Starts Soon';
            } else if (espnTournamentInfo && hasLeaderboardData) {
                document.getElementById('tournament-round').textContent = espnTournamentInfo.isFinished ? 'Final' : `Round ${espnTournamentInfo.round}`;
            } else {
                document.getElementById('tournament-round').textContent = `Round ${headerTournament.round}`;
            }
            
            // Check if tournament hasn't started yet AND no ESPN data available
            const tournamentStart = new Date(headerTournament.startTime);
            const tournamentNotStarted = now < tournamentStart;
            
            // Build the finished results banner
            const resultsBanner = document.getElementById('results-banner');
            if (showingFinishedResults) {
                document.getElementById('results-banner-text').textContent = `Final Results: ${espnTournamentInfo.name}`;
                resultsBanner.style.display = 'block';
            } else {
                resultsBanner.style.display = 'none';
            }
            
            if (tournamentNotStarted && !hasLeaderboardData) {
                // Show "Tournament Not Started" message only if no data available
                const myPickSection = document.getElementById('my-pick-section');
                myPickSection.style.display = 'none';
                
                const startDate = tournamentStart.toLocaleDateString('en-GB', { 
                    weekday: 'short', 
                    day: 'numeric', 
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit',
                    timeZoneName: 'short'
                });
                
                document.getElementById('leaderboard-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state" style="padding: 3rem; text-align: center;">
                            <div style="font-size: 2rem; margin-bottom: 1rem;"></div>
                            <h3 style="margin-bottom: 0.5rem;">Tournament Not Started Yet</h3>
                            <p style="color: var(--gray); margin-bottom: 1rem;">The ${headerTournament.name} begins:</p>
                            <p style="color: var(--gold); font-weight: 600; font-size: 1.1rem;">${startDate}</p>
                            <p style="color: var(--gray); margin-top: 1rem;">Check back once the tournament is underway for live leaderboard updates.</p>
                        </td>
                    </tr>
                `;
                return;
            }

            // Use ESPN data if available, otherwise fall back to mock data
            const leaderboardData = espnDataLoaded && liveLeaderboard.length > 0 ? liveLeaderboard : mockLeaderboard;
            
            // For pick matching on leaderboard, use the tournament that matches what ESPN is showing
            const leaderboardTournament = getCurrentDisplayTournament();
            
            // For "Your Pick" section, always show the upcoming tournament pick
            const yourPickTournament = upcomingTournament;
            
            console.log('Tournament matching:', {
                yourPickTournament: yourPickTournament?.name,
                leaderboardTournament: leaderboardTournament?.name,
                espnTournament: espnTournamentInfo?.name
            });

            // Get the current pool
            const pool = store.pools.find(p => p.id === currentPoolId);

            // Check if user has a pick for the UPCOMING tournament (shown in "Your Pick" section)
            const userPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === yourPickTournament.id
            );
            
            // Check if user has a pick for the LEADERBOARD tournament (for "YOU" tag on leaderboard)
            // Handle both ID formats: "farmers2026" and "farmers-2026"
            const leaderboardTournamentIdAlt = leaderboardTournament.id.includes('-') ? 
                leaderboardTournament.id.replace('-', '') : 
                leaderboardTournament.id.replace(/(\d+)$/, '-$1');
            
            const userLeaderboardPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                (p.tournamentId === leaderboardTournament.id || p.tournamentId === leaderboardTournamentIdAlt)
            );

            // Get all pool members' picks for the LEADERBOARD tournament (for friend tags)
            const poolPicks = store.picks.filter(
                p => p.poolId === currentPoolId && 
                (p.tournamentId === leaderboardTournament.id || p.tournamentId === leaderboardTournamentIdAlt)
            );
            
            console.log('Leaderboard pick matching:', {
                leaderboardTournamentId: leaderboardTournament.id,
                leaderboardTournamentIdAlt,
                userLeaderboardPick: userLeaderboardPick?.playerName,
                poolPicksCount: poolPicks.length
            });

            // Create a color index map for friends
            const friendColorMap = {};
            let colorIndex = 0;
            pool.members.forEach(memberId => {
                if (memberId !== store.currentUser.id) {
                    friendColorMap[memberId] = colorIndex % 5;
                    colorIndex++;
                }
            });

            const myPickSection = document.getElementById('my-pick-section');

            if (userPick) {
                const player = getPlayerById(userPick.playerId);
                // Look for player in leaderboard by ID or by name
                let leaderboardEntry = leaderboardData.find(l => String(l.playerId) === String(userPick.playerId));
                if (!leaderboardEntry && player) {
                    leaderboardEntry = leaderboardData.find(l => 
                        l.playerName && l.playerName.toLowerCase() === player.name.toLowerCase()
                    );
                }
                
                // Try to find player in tournament field for headshot
                const playerName = player?.name || userPick.playerName;
                const fieldPlayer = tournamentField.find(p => 
                    p.name && playerName && p.name.toLowerCase() === playerName.toLowerCase()
                );

                myPickSection.style.display = 'flex';
                // Headshot priority: leaderboard > field player > ESPN CDN > PGA Tour CDN
                let photoUrl = leaderboardEntry?.headshot;
                if (!photoUrl && fieldPlayer) {
                    photoUrl = fieldPlayer.headshot_url || getPlayerPhoto(fieldPlayer.id);
                }
                if (!photoUrl && player?.photo) {
                    photoUrl = player.photo;
                }
                if (!photoUrl) {
                    photoUrl = getPlayerPhoto(userPick.playerId);
                }
                console.log('My Pick photo debug:', {
                    playerId: userPick.playerId,
                    fieldPlayerId: fieldPlayer?.id,
                    playerName: playerName,
                    photoUrl: photoUrl,
                    hasLeaderboardEntry: !!leaderboardEntry,
                    hasFieldPlayer: !!fieldPlayer
                });
                document.getElementById('my-pick-photo').src = photoUrl;
                const pickPlayerId = fieldPlayer?.id || userPick.playerId;
                document.getElementById('my-pick-photo').onerror = function() {
                    // Track which fallback we've tried
                    if (!this.dataset.fallbackTried) {
                        // Try PGA Tour CDN as fallback
                        this.dataset.fallbackTried = 'pga';
                        this.src = `https://pga-tour-res.cloudinary.com/image/upload/c_thumb,g_face,z_0.7,q_auto,f_auto,dpr_2.0,w_80,h_80/headshots_${pickPlayerId}`;
                    } else if (this.dataset.fallbackTried === 'pga') {
                        // Try ESPN CDN directly
                        this.dataset.fallbackTried = 'espn';
                        this.src = `https://a.espncdn.com/combiner/i?img=/i/headshots/golf/players/full/${pickPlayerId}.png&w=96&h=96&scale=crop&cquality=80`;
                    } else {
                        // All fallbacks failed, use placeholder
                        this.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23e5e7eb" width="100" height="100"/></svg>';
                    }
                };
                document.getElementById('my-pick-name').textContent = player?.name || userPick.playerName || 'Unknown';
                document.getElementById('my-pick-position').textContent = leaderboardEntry ? leaderboardEntry.pos : 'N/A';
                document.getElementById('my-pick-earnings').textContent = leaderboardEntry 
                    ? `Projected: ${formatCurrency(leaderboardEntry.projectedEarnings)}`
                    : 'Projected: TBD';
            } else {
                // Show "No pick yet" message
                myPickSection.style.display = 'flex';
                document.getElementById('my-pick-photo').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23e5e7eb" width="100" height="100"/><text x="50" y="55" text-anchor="middle" fill="%239ca3af" font-size="12">?</text></svg>';
                document.getElementById('my-pick-name').textContent = 'No Pick Made';
                document.getElementById('my-pick-position').textContent = '-';
                document.getElementById('my-pick-earnings').textContent = 'Make your pick!';
            }

            // Render leaderboard
            const tbody = document.getElementById('leaderboard-body');
            const leaderboardRows = leaderboardData.map(entry => {
                // Prefer ESPN data (playerName, headshot) over our database lookup
                // Only fall back to database if ESPN data is missing
                const player = getPlayerById(entry.playerId);
                const playerName = entry.playerName || player?.name || 'Unknown';
                const playerPhoto = entry.headshot || player?.photo || getPlayerPhoto(entry.playerId);

                // Check if this is user's pick (by ID or name match)
                const isMyPick = userLeaderboardPick && (
                    String(userLeaderboardPick.playerId) === String(entry.playerId) ||
                    (player && getPlayerById(userLeaderboardPick.playerId)?.name.toLowerCase() === playerName.toLowerCase())
                );
                
                // Check if any pool members picked this player
                const memberPicks = poolPicks.filter(p => {
                    const pickPlayer = getPlayerById(p.playerId);
                    return (String(p.playerId) === String(entry.playerId) ||
                        (pickPlayer && pickPlayer.name.toLowerCase() === playerName.toLowerCase())) && 
                        p.userId !== store.currentUser.id;
                });

                const scoreDisplay = entry.score === 0 ? 'E' : 
                    (typeof entry.score === 'number' && entry.score < 0 ? entry.score : `+${entry.score}`);
                const scoreClass = entry.score === 0 ? '' : 
                    (typeof entry.score === 'number' && entry.score < 0 ? 'under' : 'over');

                const todayDisplay = entry.today === 0 ? 'E' : 
                    (typeof entry.today === 'number' && entry.today < 0 ? entry.today : `+${entry.today}`);

                // Build pick tags
                let pickTags = '';
                if (isMyPick) {
                    pickTags += '<span class="pick-tag your-pick">YOU</span>';
                }
                memberPicks.forEach(pick => {
                    const friendUser = store.users.find(u => u.id === pick.userId);
                    if (friendUser) {
                        const firstName = friendUser.name.split(' ')[0];
                        const colorClass = `friend-pick-${friendColorMap[pick.userId]}`;
                        pickTags += `<span class="pick-tag ${colorClass}">${firstName}</span>`;
                    }
                });

                return `
                    <tr class="${isMyPick ? 'my-pick' : ''}">
                        <td class="pos-cell">${entry.pos}</td>
                        <td>
                            <div class="player-cell">
                                <img src="${playerPhoto}" alt="" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                                <span>${playerName}</span>
                                ${pickTags}
                            </div>
                        </td>
                        <td class="score-cell ${scoreClass}">${scoreDisplay}</td>
                        <td class="score-cell ${scoreClass}">${todayDisplay}</td>
                        <td class="thru-cell">${entry.thru}</td>
                        <td class="earnings-cell">${formatCurrency(entry.projectedEarnings)}</td>
                    </tr>
                `;
            }).join('');
            
            // Add the leaderboard rows
            tbody.innerHTML = leaderboardRows;
        }

        async function renderPlayerSelection() {
            // Determine which tournament we're picking for
            const activeTournament = getActiveTournamentForPicks();
            const tournamentStarted = hasTournamentStarted();
            const pickWindowOpen = isPickWindowOpen();

            // Update tournament info display
            document.getElementById('pick-tournament-info').textContent = 
                `${currentTournament.name}  ${currentTournament.dates}`;
            
            // Set logo - for LIV, use circular badge
            const pickLogoEl = document.getElementById('pick-tournament-logo');
            if (currentPoolTour === 'liv') {
                let circularLogo = tournamentLogos[currentTournament.id] || currentTournament.logo;
                if (circularLogo && circularLogo.includes('t_ratio1_1-size60')) {
                    circularLogo = circularLogo.replace('t_ratio1_1-size60-f_webp-c_fill', 'w_200,h_200,c_fill,f_auto,q_auto');
                }
                pickLogoEl.src = circularLogo;
                pickLogoEl.className = 'tournament-logo-liv';
                pickLogoEl.style.width = '70px';
                pickLogoEl.style.height = '70px';
            } else {
                pickLogoEl.src = currentTournament.logo;
                pickLogoEl.className = 'tournament-logo';
                pickLogoEl.style.width = '';
                pickLogoEl.style.height = '';
            }

            // Get ALL players this user has picked in this pool (any tournament)
            // But EXCLUDE the current tournament pick (so they can change it)
            const usedPlayerIds = store.picks
                .filter(p => p.poolId === currentPoolId && 
                            p.userId === store.currentUser.id && 
                            p.tournamentId !== currentTournament.id) // Exclude current tournament
                .map(p => String(p.playerId));

            // Check if user already has a pick for THIS tournament
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );

            // SCENARIO 1: Tournament started with existing pick - LOCKED
            if (existingPick && tournamentStarted) {
                const player = getPlayerById(existingPick.playerId);
                document.getElementById('players-list').innerHTML = `
                    <div class="empty-state">
                        <h3> Pick Locked</h3>
                        <p>You've selected <strong>${player ? player.name : 'a player'}</strong> for this tournament.</p>
                        <p style="color: var(--gray); margin-top: 0.5rem;">The tournament is in progress - picks can no longer be changed.</p>
                        <p style="color: var(--gray); margin-top: 0.5rem;">View the leaderboard to track their progress.</p>
                    </div>
                `;
                document.getElementById('confirm-pick-btn').style.display = 'none';
                document.getElementById('current-pick-display').style.display = 'none';
                return;
            }

            // SCENARIO 2: Tournament started, NO pick - missed the window
            if (!existingPick && tournamentStarted) {
                // Check if next tournament pick window is open
                const nextWindowOpen = isNextPickWindowOpen();
                
                let nextPickMessage = '';
                if (nextWindowOpen) {
                    nextPickMessage = `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f0f9f4; border-radius: 8px; border-left: 4px solid var(--green-fairway);">
                            <h4 style="color: var(--green-fairway); margin-bottom: 0.5rem;"> Pick Now Open for Next Week</h4>
                            <p><strong>${nextTournament.name}</strong> (${nextTournament.dates})</p>
                            <p style="color: var(--gray); margin-top: 0.25rem;">Pick closes: ${formatPickWindowTime(nextTournament.startTime)}</p>
                        </div>
                    `;
                } else {
                    nextPickMessage = `
                        <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                            <h4 style="margin-bottom: 0.5rem;"> Next Pick Window</h4>
                            <p><strong>${nextTournament.name}</strong> (${nextTournament.dates})</p>
                            <p style="color: var(--gray); margin-top: 0.25rem;">Opens: ${formatPickWindowTime(nextTournament.pickWindowOpen)}</p>
                        </div>
                    `;
                }

                document.getElementById('players-list').innerHTML = `
                    <div class="empty-state">
                        <h3> Pick Window Closed</h3>
                        <p><strong>${currentTournament.name}</strong> has already started.</p>
                        <p style="color: var(--gray); margin-top: 0.5rem;">You missed the pick window for this week.</p>
                        ${nextPickMessage}
                    </div>
                `;
                document.getElementById('confirm-pick-btn').style.display = 'none';
                document.getElementById('current-pick-display').style.display = 'none';
                return;
            }

            // SCENARIO 3: Pick window not yet open
            if (!pickWindowOpen && !tournamentStarted) {
                document.getElementById('players-list').innerHTML = `
                    <div class="empty-state">
                        <h3> Pick Window Not Open Yet</h3>
                        <p>Picks for <strong>${currentTournament.name}</strong> open:</p>
                        <p style="font-size: 1.2rem; font-weight: 600; color: var(--green-fairway); margin: 1rem 0;">
                            ${formatPickWindowTime(currentTournament.pickWindowOpen)}
                        </p>
                        <p style="color: var(--gray);">Check back then to make your pick!</p>
                    </div>
                `;
                document.getElementById('confirm-pick-btn').style.display = 'none';
                document.getElementById('current-pick-display').style.display = 'none';
                return;
            }

            // SCENARIO 4: Pick window open with existing pick - can change
            if (existingPick && pickWindowOpen) {
                const player = getPlayerById(existingPick.playerId);
                selectedPlayerId = existingPick.playerId; // Pre-select current pick
                
                // Show change pick UI
                const currentPickDisplay = document.getElementById('current-pick-display');
                currentPickDisplay.style.display = 'flex';
                document.getElementById('selected-player-name').textContent = player.name;
                
                document.getElementById('confirm-pick-btn').style.display = 'block';
                document.getElementById('confirm-pick-btn').textContent = 'UPDATE PICK';
                document.getElementById('confirm-pick-btn').disabled = true; // Disabled until they select someone different
                
                document.getElementById('pick-warning').innerHTML = 
                    `<strong>Current pick:</strong> ${player.name}. You can change your pick until the tournament starts.`;
            } else {
                // SCENARIO 5: Pick window open, no pick yet - can pick
                document.getElementById('current-pick-display').style.display = 'none';
                document.getElementById('confirm-pick-btn').style.display = 'block';
                document.getElementById('confirm-pick-btn').textContent = 'CONFIRM PICK';
            }

            await renderPlayersListFiltered('', usedPlayerIds, existingPick);
        }

        // Cache for tournament picks (for unique picks feature)
        let cachedTournamentPicks = null;
        let cachedTournamentPicksPoolId = null;
        let cachedTournamentPicksTournamentId = null;
        
        async function renderPlayersListFiltered(searchTerm, usedPlayerIds, existingPick = null) {
            const container = document.getElementById('players-list');
            const pool = store.pools.find(p => p.id === currentPoolId);
            
            // Use tournament field (players in THIS WEEK'S tournament)
            // Filter by search term, then sort by world ranking (or Schwab Cup for Champions Tour)
            const filtered = tournamentField
                .filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()))
                .sort((a, b) => {
                    // For Champions Tour, use Schwab Cup rankings
                    if (currentPoolTour === 'champions') {
                        const rankA = getSchwabCupRank(a.id);
                        const rankB = getSchwabCupRank(b.id);
                        return rankA - rankB;
                    }
                    // For LIV, use win probability rank from DataGolf
                    // For PGA Tour, use OWGR
                    return (a.rank || 999) - (b.rank || 999);
                });

            // Check if tournament has started - only show leaderboard data if it has
            const tournamentStarted = new Date() >= currentTournament.startTime;
            
            // OPTIMIZED: Get players already picked by others this week (for unique picks pools)
            let pickedThisWeekByOthers = [];
            let pickedByMap = {}; // Map playerId -> picker name
            
            if (pool?.uniquePicks) {
                // Check cache first
                if (cachedTournamentPicks && 
                    cachedTournamentPicksPoolId === currentPoolId && 
                    cachedTournamentPicksTournamentId === currentTournament.id) {
                    // Use cached data
                    pickedThisWeekByOthers = cachedTournamentPicks
                        .filter(p => p.user_id !== store.currentUser.id)
                        .map(p => String(p.player_id));
                    cachedTournamentPicks.forEach(p => {
                        if (p.user_id !== store.currentUser.id) {
                            pickedByMap[String(p.player_id)] = p.user_name?.split(' ')[0] || 'Someone';
                        }
                    });
                } else {
                    // Fetch from server
                    const tournamentPicks = await getTournamentPicksOptimized(currentPoolId, currentTournament.id);
                    cachedTournamentPicks = tournamentPicks;
                    cachedTournamentPicksPoolId = currentPoolId;
                    cachedTournamentPicksTournamentId = currentTournament.id;
                    
                    pickedThisWeekByOthers = tournamentPicks
                        .filter(p => p.user_id !== store.currentUser.id)
                        .map(p => String(p.player_id));
                    tournamentPicks.forEach(p => {
                        if (p.user_id !== store.currentUser.id) {
                            pickedByMap[String(p.player_id)] = p.user_name?.split(' ')[0] || 'Someone';
                        }
                    });
                }
            }

            container.innerHTML = filtered.map(player => {
                const isUsed = usedPlayerIds.includes(String(player.id));
                const isSelected = String(selectedPlayerId) === String(player.id);
                const isCurrentPick = existingPick && String(existingPick.playerId) === String(player.id);
                const isTakenByOther = pickedThisWeekByOthers.includes(String(player.id));
                const isDisabled = isUsed || isTakenByOther;
                
                // Only get leaderboard data if tournament has started
                let currentPos = '-';
                let currentScore = '-';
                if (tournamentStarted) {
                    const leaderboardEntry = mockLeaderboard.find(l => String(l.playerId) === String(player.id));
                    if (leaderboardEntry) {
                        currentPos = leaderboardEntry.pos;
                        currentScore = leaderboardEntry.score < 0 ? leaderboardEntry.score : 
                            (leaderboardEntry.score === 0 ? 'E' : `+${leaderboardEntry.score}`);
                    }
                }

                // Show world ranking or team for LIV, Schwab Cup for Champions
                let playerSubline;
                if (player.team) {
                    // LIV Golf - show team
                    playerSubline = `${player.country}  ${player.team}`;
                } else if (currentPoolTour === 'champions') {
                    // Champions Tour - show Schwab Cup rank
                    const schwabRank = getSchwabCupRank(player.id);
                    playerSubline = schwabRank < 999 
                        ? `${player.country}  Schwab Cup #${schwabRank}`
                        : `${player.country}`;
                } else {
                    // PGA Tour - show OWGR
                    const worldRank = player.rank ? `#${player.rank}` : '-';
                    playerSubline = `${player.country}  OWGR ${worldRank}`;
                }
                
                // Get headshot - prefer Supabase data, fallback to PGA Tour CDN
                const headshotUrl = player.headshot || getPlayerHeadshot(player);
                
                // Find who picked this player (for unique picks pools)
                const takenByName = pickedByMap[String(player.id)] || '';
                
                // Determine button text based on whether updating existing pick
                const confirmBtnText = isCurrentPick ? 'Current' : (existingPick ? 'Update' : 'Confirm');
                const showConfirmBtn = isSelected && !isDisabled && !isCurrentPick;
                
                // Show remove button only on current pick when tournament hasn't started
                const showRemoveBtn = isCurrentPick && !tournamentStarted;

                return `
                    <div class="player-item ${isDisabled ? 'disabled' : ''} ${isSelected ? 'selected' : ''} ${isCurrentPick ? 'current-pick' : ''}"
                         onclick="${isDisabled ? '' : `selectPlayer('${player.id}')`}">
                        <img class="player-photo" src="${headshotUrl}" alt="${player.name}"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>'">
                        <div class="player-info">
                            <h4>${player.name}</h4>
                            <p>${playerSubline}</p>
                        </div>
                        ${isUsed ? '<span class="used-badge">Already Used</span>' : ''}
                        ${isTakenByOther ? `<span class="used-badge" style="background: #ef4444;">Picked by ${takenByName}</span>` : ''}
                        ${isCurrentPick ? '<span class="current-badge">Current Pick</span>' : ''}
                        ${showRemoveBtn ? `<button class="inline-remove-btn" onclick="event.stopPropagation(); removePick();">Remove</button>` : ''}
                        ${showConfirmBtn ? `<button class="inline-confirm-btn" onclick="event.stopPropagation(); confirmPick();">${confirmBtnText}</button>` : ''}
                        ${!isSelected && !isCurrentPick ? `<div class="player-rank">
                            ${tournamentStarted ? `
                                <strong>${currentPos}</strong>
                                <span>${currentScore}</span>
                            ` : `
                                <span style="color: var(--gray); font-size: 0.8rem;">Not started</span>
                            `}
                        </div>` : ''}
                    </div>
                `;
            }).join('');

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No players found matching "${searchTerm}"</p>
                    </div>
                `;
            }
        }

        async function filterPlayers() {
            const searchTerm = document.getElementById('player-search').value;
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );
            const usedPlayerIds = store.picks
                .filter(p => p.poolId === currentPoolId && 
                            p.userId === store.currentUser.id &&
                            p.tournamentId !== currentTournament.id)
                .map(p => String(p.playerId));
            await renderPlayersListFiltered(searchTerm, usedPlayerIds, existingPick);
        }

        async function selectPlayer(playerId) {
            selectedPlayerId = String(playerId);
            const player = getPlayerById(playerId);

            // Check if there's an existing pick for this tournament
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );

            // Update UI
            const usedPlayerIds = store.picks
                .filter(p => p.poolId === currentPoolId && 
                            p.userId === store.currentUser.id &&
                            p.tournamentId !== currentTournament.id)
                .map(p => String(p.playerId));
            await renderPlayersListFiltered(document.getElementById('player-search').value, usedPlayerIds, existingPick);

            // Show current selection
            const currentPickDisplay = document.getElementById('current-pick-display');
            currentPickDisplay.style.display = 'flex';
            document.getElementById('selected-player-name').textContent = player.name;

            // Update button and warning based on whether this is a new pick or change
            const confirmBtn = document.getElementById('confirm-pick-btn');
            if (existingPick) {
                const isSamePlayer = String(existingPick.playerId) === String(playerId);
                confirmBtn.textContent = isSamePlayer ? 'CURRENT PICK' : 'UPDATE PICK';
                confirmBtn.disabled = isSamePlayer;
                document.getElementById('pick-warning').innerHTML = isSamePlayer
                    ? `<strong>${player.name}</strong> is your current pick. Select a different player to change.`
                    : `<strong>Change pick to ${player.name}?</strong> You can still change until the tournament starts.`;
            } else {
                confirmBtn.textContent = 'CONFIRM PICK';
                confirmBtn.disabled = false;
                document.getElementById('pick-warning').innerHTML = 
                    `<strong>Warning:</strong> Once the tournament starts, you cannot change your pick. ${player.name} will be unavailable for the rest of the season.`;
            }
        }

        async function confirmPick() {
            if (!selectedPlayerId) return;

            // Double-check tournament hasn't started (in case user had page open)
            if (hasTournamentStarted()) {
                showToast('Tournament has already started - picks are locked!', true);
                renderPlayerSelection(); // Re-render to show locked state
                return;
            }

            const player = getPlayerById(selectedPlayerId);

            try {
                if (supabaseClient) {
                    // Save pick via API
                    const result = await callAPI('make-pick', {
                        poolId: currentPoolId,
                        tournamentId: currentTournament.id,
                        playerId: String(selectedPlayerId),
                        playerName: player.name
                    });
                    const data = result.data;
                    
                    // Update local store
                    const existingPickIndex = store.picks.findIndex(
                        p => p.poolId === currentPoolId && 
                        p.userId === store.currentUser.id && 
                        p.tournamentId === currentTournament.id
                    );

                    const pickData = {
                        id: data.id,
                        poolId: currentPoolId,
                        userId: store.currentUser.id,
                        playerId: String(selectedPlayerId),
                        tournamentId: currentTournament.id,
                        tournamentName: currentTournament.name,
                        timestamp: new Date().toISOString(),
                        earnings: 0
                    };

                    if (existingPickIndex !== -1) {
                        store.picks[existingPickIndex] = pickData;
                        showToast(`Pick updated to ${player.name}!`);
                    } else {
                        store.picks.push(pickData);
                        showToast(`${player.name} locked in for ${currentTournament.name}!`);
                    }
                } else {
                    // Fallback to local storage
                    const existingPickIndex = store.picks.findIndex(
                        p => p.poolId === currentPoolId && 
                        p.userId === store.currentUser.id && 
                        p.tournamentId === currentTournament.id
                    );

                    if (existingPickIndex !== -1) {
                        store.picks[existingPickIndex].playerId = String(selectedPlayerId);
                        store.picks[existingPickIndex].timestamp = new Date().toISOString();
                        showToast(`Pick updated to ${player.name}!`);
                    } else {
                        const pick = {
                            id: generateId(),
                            poolId: currentPoolId,
                            userId: store.currentUser.id,
                            playerId: String(selectedPlayerId),
                            tournamentId: currentTournament.id,
                            tournamentName: currentTournament.name,
                            timestamp: new Date().toISOString(),
                            earnings: 0
                        };
                        store.picks.push(pick);
                        showToast(`${player.name} locked in for ${currentTournament.name}!`);
                    }
                }

                selectedPlayerId = null;
                switchPoolTab('leaderboard');
            } catch (error) {
                showToast(error.message || 'Failed to save pick', true);
            }
        }

        async function removePick() {
            // Double-check tournament hasn't started
            if (hasTournamentStarted()) {
                showToast('Tournament has already started - picks are locked!', true);
                renderPlayerSelection();
                return;
            }

            // Find existing pick
            const existingPick = store.picks.find(
                p => p.poolId === currentPoolId && 
                p.userId === store.currentUser.id && 
                p.tournamentId === currentTournament.id
            );

            if (!existingPick) {
                showToast('No pick to remove', true);
                return;
            }

            try {
                if (supabaseClient) {
                    // Delete pick via API
                    await callAPI('delete-pick', {
                        poolId: currentPoolId,
                        tournamentId: currentTournament.id
                    });
                }

                // Remove from local store
                const pickIndex = store.picks.findIndex(
                    p => p.poolId === currentPoolId && 
                    p.userId === store.currentUser.id && 
                    p.tournamentId === currentTournament.id
                );
                
                if (pickIndex !== -1) {
                    store.picks.splice(pickIndex, 1);
                }

                selectedPlayerId = null;
                showToast('Pick removed successfully');
                renderPlayerSelection();
            } catch (error) {
                showToast(error.message || 'Failed to remove pick', true);
            }
        }

        function renderHistory() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            
            // Get user's picks
            const userPicks = store.picks
                .filter(p => p.poolId === currentPoolId && p.userId === store.currentUser.id);
            
            // Sort by tournament order (most recent first)
            // Use schedule to determine order
            const schedule = getScheduleForTour(currentPoolTour);
            const tournamentOrder = {};
            schedule.forEach((t, idx) => {
                tournamentOrder[t.id] = idx;
                // Also add hyphenated version
                const hyphenatedId = t.id.replace(/(\d+)$/, '-$1');
                tournamentOrder[hyphenatedId] = idx;
            });
            
            userPicks.sort((a, b) => {
                const orderA = tournamentOrder[a.tournamentId] ?? 999;
                const orderB = tournamentOrder[b.tournamentId] ?? 999;
                return orderB - orderA; // Most recent (higher index) first
            });

            const tbody = document.getElementById('history-body');

            if (userPicks.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state" style="padding: 3rem;">
                            <h3>No Picks Yet</h3>
                            <p>Make your first pick to start tracking your history.</p>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = userPicks.map((pick, index) => {
                    const player = getPlayerById(pick.playerId);
                    // Check both live and mock leaderboard for the player
                    let leaderboardEntry = liveLeaderboard.find(l => String(l.playerId) === String(pick.playerId));
                    if (!leaderboardEntry) {
                        leaderboardEntry = liveLeaderboard.find(l => 
                            l.playerName && pick.playerName && 
                            l.playerName.toLowerCase() === pick.playerName.toLowerCase()
                        );
                    }
                    if (!leaderboardEntry) {
                        leaderboardEntry = mockLeaderboard.find(l => String(l.playerId) === String(pick.playerId));
                    }
                    
                    // Also check tournament field for player data
                    const fieldPlayer = tournamentField.find(p => 
                        (p.name && pick.playerName && p.name.toLowerCase() === pick.playerName.toLowerCase()) ||
                        String(p.id) === String(pick.playerId)
                    );
                    
                    const isCurrentTournament = pick.tournamentId === currentTournament.id;
                    const tournamentLogo = tournamentLogos[pick.tournamentId] || '';
                    // Get tournament name - fallback to lookup, then current tournament, then formatted ID
                    const tournamentName = pick.tournamentName || 
                        tournamentNames[pick.tournamentId] ||
                        (isCurrentTournament ? currentTournament.name : pick.tournamentId.replace(/-/g, ' ').replace(/(\d+)/, ' $1'));
                    
                    // Get player headshot - better fallback chain
                    const pickPlayerId = fieldPlayer?.id || pick.playerId;
                    let playerHeadshot = leaderboardEntry?.headshot;
                    if (!playerHeadshot && fieldPlayer?.headshot_url) {
                        playerHeadshot = fieldPlayer.headshot_url;
                    }
                    if (!playerHeadshot) {
                        playerHeadshot = player?.photo || getPlayerPhoto(pickPlayerId);
                    }

                    // Get week number - picks are sorted most recent first, so reverse the index
                    const weekNum = userPicks.length - index;
                    
                    // For LIV tournaments, use circular badge logo plus name
                    const isLivTournament = pick.tournamentId.startsWith('liv-');
                    const livFallbackLogo = DEFAULT_LIV_LOGO;
                    const tournamentDisplay = isLivTournament
                        ? `<div class="player-cell">
                            <img src="${tournamentLogo || livFallbackLogo}" class="tournament-logo-liv" alt="" onerror="this.style.display='none'">
                            <span>${tournamentName}</span>
                           </div>`
                        : `<div class="player-cell">
                            ${tournamentLogo ? `<img src="${tournamentLogo}" class="tournament-logo-small" alt="" onerror="this.style.display='none'">` : ''}
                            <span>${tournamentName}</span>
                           </div>`;

                    return `
                        <tr>
                            <td>${weekNum}</td>
                            <td>
                                ${tournamentDisplay}
                            </td>
                            <td>
                                <div class="player-cell">
                                    <img src="${playerHeadshot}" alt="" 
                                         data-player-id="${pickPlayerId}"
                                         onerror="if(!this.dataset.fallbackTried){this.dataset.fallbackTried='pga';this.src='https://pga-tour-res.cloudinary.com/image/upload/c_thumb,g_face,z_0.7,q_auto,f_auto,dpr_2.0,w_80,h_80/headshots_'+this.dataset.playerId;}else if(this.dataset.fallbackTried==='pga'){this.dataset.fallbackTried='done';this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23e5e7eb%22 width=%22100%22 height=%22100%22/></svg>';}">
                                    <span>${pick.playerName || player?.name || 'Unknown'}</span>
                                </div>
                            </td>
                            <td>
                                ${isCurrentTournament ? 
                                    (leaderboardEntry ? 
                                        `<span style="color: var(--gold); font-weight: 600;">In Progress (${leaderboardEntry.pos})</span>` :
                                        `<span style="color: var(--gray);">Upcoming</span>`) :
                                    (pick.finish || '-')
                                }
                            </td>
                            <td class="earnings-cell">
                                ${isCurrentTournament ? 
                                    (leaderboardEntry ? 
                                        formatCurrency(leaderboardEntry.projectedEarnings) + ' (proj)' :
                                        '-') :
                                    formatCurrency(pick.earnings || 0)
                                }
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // Render friends' pick history
            const friendsContainer = document.getElementById('friends-history');
            const otherMembers = pool.members.filter(m => m !== store.currentUser.id);
            
            if (otherMembers.length === 0) {
                friendsContainer.innerHTML = `<p style="padding: 1.5rem; color: var(--gray);">No other pool members yet.</p>`;
            } else {
                friendsContainer.innerHTML = otherMembers.map(memberId => {
                    const user = store.users.find(u => u.id === memberId);
                    const memberPicks = store.picks
                        .filter(p => p.poolId === currentPoolId && p.userId === memberId)
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    return `
                        <div style="border-bottom: 1px solid #e5e7eb; padding: 1rem 2rem;">
                            <h4 style="margin-bottom: 0.75rem; font-family: 'Oswald', sans-serif; color: var(--green-deep);">${user ? user.name : 'Unknown'}</h4>
                            ${memberPicks.length === 0 ? 
                                `<p style="color: var(--gray); font-size: 0.9rem;">No picks yet</p>` :
                                `<div style="display: flex; flex-wrap: wrap; gap: 1rem;">
                                    ${memberPicks.map(pick => {
                                        const player = getPlayerById(pick.playerId);
                                        const isCurrentTournament = pick.tournamentId === currentTournament.id;
                                        const leaderboardEntry = isCurrentTournament ? mockLeaderboard.find(l => String(l.playerId) === String(pick.playerId)) : null;
                                        const tournamentLogo = tournamentLogos[pick.tournamentId] || '';
                                        const tournamentName = pick.tournamentName || 
                                            tournamentNames[pick.tournamentId] ||
                                            (isCurrentTournament ? currentTournament.name : pick.tournamentId);
                                        const shortName = tournamentName.split(' ').slice(0, 2).join(' ');
                                        
                                        // Get earnings - either projected (current) or final (completed)
                                        const earnings = isCurrentTournament && leaderboardEntry ? 
                                            leaderboardEntry.projectedEarnings : 
                                            (pick.earnings || 0);
                                        const earningsLabel = isCurrentTournament && leaderboardEntry ? 'proj' : '';
                                        
                                        return `
                                            <div style="background: #f9fafb; padding: 0.5rem 0.75rem; border-radius: 4px; display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem;">
                                                ${tournamentLogo ? `<img src="${tournamentLogo}" style="width: 24px; height: 24px; object-fit: contain;" alt="">` : ''}
                                                <span style="color: var(--gray);">${shortName}:</span>
                                                <strong>${player?.name !== 'Unknown Player' ? player.name : (pick.playerName || 'Unknown')}</strong>
                                                ${isCurrentTournament && leaderboardEntry ? 
                                                    `<span style="color: var(--gold);">(${leaderboardEntry.pos})</span>` :
                                                    (pick.finish ? `<span style="color: var(--gray);">(${pick.finish})</span>` : '')
                                                }
                                                <span style="color: var(--green-fairway); font-weight: 600;">${formatCurrency(earnings)}${earningsLabel ? ' (' + earningsLabel + ')' : ''}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>`
                            }
                        </div>
                    `;
                }).join('');
            }

            // Render upcoming schedule based on pool's tour
            const scheduleBody = document.getElementById('schedule-body');
            const poolSchedule = getScheduleForTour(currentPoolTour);
            const now = new Date();
            
            // Get upcoming tournaments from the pool's tour schedule
            const upcomingFromSchedule = poolSchedule
                .filter(t => new Date(t.endDate) > now)
                .slice(0, 10) // Show next 10 tournaments
                .map((t, index) => {
                    const formatted = formatTournament(t);
                    return {
                        id: t.id,
                        name: t.name,
                        dates: formatted.dates,
                        week: index + 1,
                        course: t.course,
                        purse: t.purse,
                        logo: formatted.logo
                    };
                });
            
            scheduleBody.innerHTML = upcomingFromSchedule.map(tournament => {
                // For LIV tournaments, use the high-quality badge from tournamentLogos
                const isLivTournament = tournament.id.startsWith('liv-');
                const livFallbackLogo = DEFAULT_LIV_LOGO;
                const logoUrl = isLivTournament ? (tournamentLogos[tournament.id] || livFallbackLogo) : tournament.logo;
                const logoClass = isLivTournament ? 'tournament-logo-liv' : 'tournament-logo-small';
                
                return `
                    <tr>
                        <td>${tournament.week}</td>
                        <td>
                            <div class="player-cell">
                                <img src="${logoUrl}" class="${logoClass}" alt="" onerror="this.style.display='none'">
                                <strong>${tournament.name}</strong>
                            </div>
                        </td>
                        <td>${tournament.dates}</td>
                        <td>${tournament.course}</td>
                        <td>
                            <span style="color: var(--green-fairway);">${formatCurrency(tournament.purse)}</span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ==================== MODALS ====================
        function showInviteModal(poolId) {
            const pool = store.pools.find(p => p.id === poolId);
            if (!pool) return;

            currentPoolId = poolId;
            const inviteLink = `${window.location.origin}${window.location.pathname}?join=${pool.inviteCode}`;
            
            document.getElementById('invite-link-input').value = inviteLink;
            document.getElementById('sent-invites-list').innerHTML = '';
            document.getElementById('modal-invite-email').value = '';
            document.getElementById('invite-modal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showJoinPoolModal() {
            document.getElementById('join-pool-code').value = '';
            document.getElementById('join-pool-error').style.display = 'none';
            document.getElementById('join-pool-modal').classList.add('active');
            document.getElementById('join-pool-code').focus();
        }

        async function handleJoinPoolByCode() {
            const codeInput = document.getElementById('join-pool-code');
            const errorEl = document.getElementById('join-pool-error');
            const code = codeInput.value.trim().toUpperCase();
            
            errorEl.style.display = 'none';
            
            if (!code || code.length < 4) {
                errorEl.textContent = 'Please enter a valid invite code';
                errorEl.style.display = 'block';
                return;
            }
            
            if (!supabaseClient || !store.currentUser) {
                errorEl.textContent = 'You must be logged in to join a pool';
                errorEl.style.display = 'block';
                return;
            }
            
            try {
                // Join pool via API
                const result = await callAPI('join-pool', { inviteCode: code });
                
                if (result.alreadyMember) {
                    errorEl.textContent = 'You are already a member of this pool';
                    errorEl.style.display = 'block';
                    return;
                }
                
                const pool = result.data;
                closeModal('join-pool-modal');
                showToast(`Successfully joined ${pool.name}!`);
                
                // Reload user data to get the new pool
                await loadUserData();
                renderDashboard();
                
            } catch (error) {
                console.error('Join pool error:', error);
                const msg = error.message?.includes('Invalid invite code') 
                    ? 'Invalid invite code. Please check and try again.'
                    : 'Failed to join pool. Please try again.';
                errorEl.textContent = msg;
                errorEl.style.display = 'block';
            }
        }

        function copyInviteLink() {
            const link = document.getElementById('invite-link-input').value;
            navigator.clipboard.writeText(link).then(() => {
                showToast('Link copied!');
            });
        }

        async function sendEmailInvite() {
            const emailInput = document.getElementById('modal-invite-email');
            const email = emailInput.value.toLowerCase().trim();
            if (!email || !email.includes('@')) {
                showToast('Please enter a valid email', true);
                return;
            }

            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) {
                showToast('Could not find pool', true);
                return;
            }

            const sendBtn = event.target.closest('button') || document.querySelector('#invite-modal button[onclick*="sendEmailInvite"]');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;

            try {
                const inviteLink = `${window.location.origin}${window.location.pathname}?join=${pool.inviteCode}`;
                
                // Call the Edge Function to send email
                const response = await fetch(`${SUPABASE_URL}/functions/v1/send-invite`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        email: email,
                        poolName: pool.name,
                        inviteCode: pool.inviteCode,
                        inviteLink: inviteLink,
                        inviterName: store.currentUser.name
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to send invite');
                }

                // Store invite in database
                if (supabaseClient) {
                    try {
                        await callAPI('save-invite', {
                            poolId: pool.id,
                            email: email,
                            inviteCode: pool.inviteCode
                        });
                    } catch (e) {
                        console.error('Error saving invite:', e);
                    }
                }

                // Store locally too
                store.invites.push({
                    id: generateId(),
                    poolId: pool.id,
                    email,
                    status: 'sent'
                });

                // Add to sent list in modal
                const sentList = document.getElementById('sent-invites-list');
                sentList.innerHTML += `<div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f0f9f4; border-radius: 6px; margin-top: 0.5rem;">
                    <span style="color: var(--green-fairway);"></span>
                    <span style="font-size: 0.9rem;">${email}</span>
                </div>`;

                showToast(`Invite sent to ${email}!`);
                emailInput.value = '';

            } catch (error) {
                console.error('Send invite error:', error);
                showToast(error.message || 'Failed to send invite', true);
            } finally {
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        function emailInviteLink() {
            const pool = store.pools.find(p => p.id === currentPoolId);
            if (!pool) {
                console.error('No pool found for currentPoolId:', currentPoolId);
                showToast('Could not find pool', true);
                return;
            }
            
            const inviteLink = document.getElementById('invite-link').textContent;
            const subject = encodeURIComponent(`Join my One & Done Golf Pool: ${pool.name}`);
            const body = encodeURIComponent(
`Hey!

I've created a One & Done golf pool and I'd love for you to join!

Click this link to join:
${inviteLink}

Or use invite code: ${pool.inviteCode}

See you on the course!`
            );
            
            // Use location.href for better compatibility
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        // Close modal when clicking outside
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ==================== INIT ====================
        // Add some demo data for testing
        function initDemoData() {
            // Demo users
            store.users.push({
                id: 'demo1',
                name: 'Demo User',
                email: 'demo@example.com',
                password: 'password123'
            });

            store.users.push({
                id: 'friend1',
                name: 'Tiger Woods Fan',
                email: 'tiger@example.com',
                password: 'password123'
            });

            store.users.push({
                id: 'friend2',
                name: 'Golf Buddy',
                email: 'buddy@example.com',
                password: 'password123'
            });

            // Demo pool
            store.pools.push({
                id: 'demo-pool',
                name: 'Office Golf League 2026',
                season: '2025-2026 PGA Tour Season',
                ownerId: 'demo1',
                members: ['demo1', 'friend1', 'friend2'],
                inviteCode: 'DEMO2026'
            });

            // 2026 Season: The Sentry was CANCELLED due to drought at Kapalua
            // Sony Open in Hawaii (Jan 15-18) was the FIRST tournament - Chris Gotterup won
            // The American Express (Jan 22-25) is currently in progress

            // Sony Open picks (Week 1 - the only completed tournament so far)
            store.picks.push({
                id: 'pick1',
                poolId: 'demo-pool',
                userId: 'demo1',
                playerId: '11378', // Robert MacIntyre - T4 at Sony Open ($409,500)
                tournamentId: 'sony2026',
                tournamentName: 'Sony Open in Hawaii',
                timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                earnings: 409500,
                finish: 'T4'
            });

            store.picks.push({
                id: 'pick2',
                poolId: 'demo-pool',
                userId: 'friend1',
                playerId: '9025', // Daniel Berger - T6 at Sony Open ($287,105)
                tournamentId: 'sony2026',
                tournamentName: 'Sony Open in Hawaii',
                timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                earnings: 287105,
                finish: 'T6'
            });

            store.picks.push({
                id: 'pick3',
                poolId: 'demo-pool',
                userId: 'friend2',
                playerId: '7081', // Si Woo Kim - T11 at Sony Open ($220,675)
                tournamentId: 'sony2026',
                tournamentName: 'Sony Open in Hawaii',
                timestamp: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                earnings: 220675,
                finish: 'T11'
            });

            // Current week picks (The American Express - in progress)
            // Friend1 picked Scottie Scheffler (currently T3 at -9)
            store.picks.push({
                id: 'pick4',
                poolId: 'demo-pool',
                userId: 'friend1',
                playerId: '9478', // Scottie Scheffler
                tournamentId: 'amex2026',
                tournamentName: 'The American Express',
                timestamp: new Date().toISOString(),
                earnings: 0
            });

            // Friend2 picked Min Woo Lee (currently T1 at -10!)
            store.picks.push({
                id: 'pick5',
                poolId: 'demo-pool',
                userId: 'friend2',
                playerId: '4410932', // Min Woo Lee
                tournamentId: 'amex2026',
                tournamentName: 'The American Express',
                timestamp: new Date().toISOString(),
                earnings: 0
            });

            // Demo user hasn't made their pick yet for The American Express!
        }

        // Only load demo data if not using Supabase
        if (!supabaseClient) {
            initDemoData();
        }

        // Helper to set user from session
        let isLoadingSession = false;
        
        async function setUserFromSession(session) {
            if (!session || !session.user) return;
            if (isLoadingSession) return; // Prevent duplicate calls
            
            isLoadingSession = true;
            
            try {
                store.currentUser = {
                    id: session.user.id,
                    name: session.user.user_metadata?.name || session.user.email.split('@')[0],
                    email: session.user.email
                };
                
                if (!store.users.find(u => u.id === session.user.id)) {
                    store.users.push(store.currentUser);
                }
                
                await loadUserData();
                // Fetch tournament field from Supabase
                console.log('Fetching tournament field for:', currentTournament.fieldId || currentTournament.id);
                await fetchTournamentField(currentTournament.fieldId || currentTournament.id, currentPoolTour);
                console.log('Tournament field loaded, count:', tournamentField.length);
                updateNavigation();
                
                // Check if we were viewing a pool before refresh
                const savedPoolId = localStorage.getItem('currentPoolId');
                if (savedPoolId && store.pools.find(p => p.id === savedPoolId)) {
                    openPool(savedPoolId);
                } else {
                    showScreen('dashboard');
                }
                
                console.log('Session active for:', store.currentUser.email);
            } finally {
                isLoadingSession = false;
            }
        }

        // Listen for auth state changes (login, logout, token refresh)
        if (supabaseClient) {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                
                // Only handle INITIAL_SESSION (page load with existing session)
                // SIGNED_IN is handled by handleLogin directly
                if (event === 'INITIAL_SESSION' && session) {
                    await setUserFromSession(session);
                    // Check for join code after user is loaded
                    checkJoinCodeFromURL();
                    checkPendingJoinCode();
                } else if (event === 'SIGNED_OUT') {
                    store.currentUser = null;
                    store.pools = [];
                    store.picks = [];
                    updateNavigation();
                    showScreen('landing');
                } else if (event === 'TOKEN_REFRESHED' && session) {
                    // Just update the user info, don't reload everything
                    store.currentUser = {
                        id: session.user.id,
                        name: session.user.user_metadata?.name || session.user.email.split('@')[0],
                        email: session.user.email
                    };
                }
            });
        }

        // Check for join code in URL and handle joining a pool
        let pendingJoinCode = null;

        function checkJoinCodeFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const joinCode = urlParams.get('join');
            
            if (joinCode) {
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                
                if (store.currentUser) {
                    // User is logged in, join immediately
                    joinPoolWithCode(joinCode);
                } else {
                    // Save for after login/signup
                    pendingJoinCode = joinCode;
                    localStorage.setItem('pendingJoinCode', joinCode);
                    showToast('Please log in or sign up to join the pool');
                    showScreen('login');
                }
            }
        }

        // Check for pending join code after login
        function checkPendingJoinCode() {
            const savedCode = pendingJoinCode || localStorage.getItem('pendingJoinCode');
            if (savedCode && store.currentUser) {
                pendingJoinCode = null;
                localStorage.removeItem('pendingJoinCode');
                joinPoolWithCode(savedCode);
            }
        }

        async function joinPoolWithCode(inviteCode) {
            try {
                showToast('Joining pool...');
                
                console.log('Looking for pool with invite code:', inviteCode.toUpperCase());
                
                const result = await callAPI('join-pool', { inviteCode: inviteCode.toUpperCase() });
                const pool = result.data;

                if (result.alreadyMember) {
                    showToast('You\'re already in this pool!');
                    await loadUserData();
                    openPool(pool.id);
                    return;
                }

                // Reload data and open the pool
                await loadUserData();
                showToast(`Welcome to ${pool.name}!`);
                openPool(pool.id);

            } catch (error) {
                console.error('Join pool error:', error);
                const msg = error.message?.includes('Invalid invite code')
                    ? 'Invalid invite code'
                    : 'Failed to join pool';
                showToast(msg, true);
            }
        }

        // Check URL for join code on page load
        // This handles the case where user clicks invite link
        checkJoinCodeFromURL();

        // Fetch tournament field on page load (regardless of auth state)
        // This ensures the field data is ready before user makes picks
        fetchTournamentField(currentTournament.fieldId || currentTournament.id, currentPoolTour);

        // Check tabs overflow on resize
        window.addEventListener('resize', () => {
            checkTabsOverflow();
        });
    </script>
</body>
</html>
